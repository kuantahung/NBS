<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å€å®‰ä¿éšªéœ€æ±‚åˆ†æç³»çµ± (2026 ç¶“å…¸ä¿®å¾©ç‰ˆ)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700;900&display=swap" rel="stylesheet">
    <style>
        /* --- è¦–è¦ºé¢¨æ ¼é‚„åŸï¼šæ·±è—æ¼¸å±¤ + æ¯›ç»ç’ƒ --- */
        body { font-family: 'Microsoft JhengHei', 'Noto Sans TC', sans-serif; background-color: #f1f5f9; overflow-x: hidden; -webkit-tap-highlight-color: transparent; }
        
        /* æ¼¸å±¤ Header */
        .gradient-bg { background: linear-gradient(135deg, #0f172a 0%, #334155 100%); }
        /* æ¯›ç»ç’ƒå¡ç‰‡ */
        .glass-card { background: rgba(255, 255, 255, 0.98); backdrop-filter: blur(10px); border: 1px solid rgba(255,255,255,0.2); box-shadow: 0 10px 30px -10px rgba(0,0,0,0.15); }

        input[type="number"]::-webkit-inner-spin-button { -webkit-appearance: none; }
        .hidden { display: none !important; }
        .animate-fade-in { animation: fadeIn 0.3s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

        /* è¡¨æ ¼èˆ‡è¼¸å…¥æ¡† */
        .financial-table th { background-color: #f8fafc; color: #475569; padding: 12px; font-size: 0.95rem; border-bottom: 2px solid #e2e8f0; font-weight: 700; white-space: nowrap; text-align: left; }
        .financial-table td { padding: 10px; border-bottom: 1px solid #f1f5f9; vertical-align: middle; }
        .form-input { width: 100%; border: 1px solid #cbd5e1; border-radius: 8px; padding: 10px; font-size: 1rem; transition: all 0.2s; background: white; }
        .form-input:focus { border-color: #3b82f6; box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1); outline: none; }
        
        /* ç¤¾ä¿é¸å–® */
        .si-select { background-color: #f8fafc; border: 1px solid #cbd5e1; border-radius: 6px; padding: 8px 12px; font-size: 0.95rem; font-weight: bold; color: #475569; width: 100%; margin-bottom: 8px; cursor: pointer; transition: all 0.2s; }
        .si-select:hover { border-color: #3b82f6; }
        
        /* é€£çµ */
        .salary-table-link { font-size: 0.8rem; color: #3b82f6; text-decoration: none; display: inline-flex; align-items: center; margin-top: 4px; transition: color 0.2s; }
        .salary-table-link:hover { color: #1d4ed8; text-decoration: underline; }

        /* æ•™è‚²å­¸ç¨‹é–‹é—œ */
        .edu-toggle-label { cursor: pointer; padding: 4px 8px; border-radius: 4px; border: 1px solid #cbd5e1; font-size: 0.8rem; text-align: center; transition: all 0.2s; user-select: none; background: white; }
        .edu-toggle-input:checked + .edu-toggle-label { background-color: #0f172a; color: white; border-color: #0f172a; }
        .edu-stage-row { display: grid; grid-template-columns: 2fr 1fr 1fr; gap: 8px; align-items: center; border-bottom: 1px dashed #e2e8f0; padding: 8px 0; }

        /* é¦–é å¡ç‰‡ (é‚„åŸåœ–ç‰‡èƒŒæ™¯) */
        .need-card { height: 280px; transition: transform 0.3s ease, box-shadow 0.3s ease; border-radius: 1.5rem; overflow: hidden; position: relative; cursor: pointer; }
        .need-card:hover { transform: translateY(-5px); box-shadow: 0 15px 30px rgba(0,0,0,0.15); }
        .need-card input:checked ~ .border-overlay { border-color: #3b82f6; border-width: 4px; } /* Blue highlight */

        /* Loading */
        #loading-overlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.85); z-index: 100000; color: white; justify-content: center; align-items: center; flex-direction: column; backdrop-filter: blur(5px); }
        .spinner { border: 4px solid rgba(255,255,255,0.3); border-radius: 50%; border-top: 4px solid #d4af37; width: 50px; height: 50px; animation: spin 1s linear infinite; margin-bottom: 20px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* RWD */
        @media (max-width: 768px) {
            .mobile-card-table thead { display: none; }
            .mobile-card-table tbody tr { display: block; background: white; margin-bottom: 15px; border-radius: 12px; border: 1px solid #e2e8f0; padding: 20px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
            .mobile-card-table td { display: block; width: 100%; padding: 8px 0; border: none; }
            .mobile-card-table td::before { content: attr(data-label); float: left; font-weight: bold; color: #64748b; margin-right: 10px; font-size: 1rem; margin-top: 10px;}
            .need-card { height: 220px; }
        }
    </style>
</head>
<body class="bg-slate-100 min-h-screen text-slate-800 font-sans" onload="initSystem()">

    <div id="loading-overlay">
        <div class="spinner"></div>
        <div class="text-2xl font-bold tracking-widest">å ±å‘Šç”Ÿæˆä¸­</div>
        <p class="text-sm text-gray-400 mt-2">æ­£åœ¨é€²è¡Œå°ˆæ¥­æ’ç‰ˆèˆ‡æ•¸æ“šé‹ç®—...</p>
    </div>
    
    <canvas id="hidden-chart-canvas" width="2400" height="1200" style="position:fixed; left:-9999px;"></canvas>

    <div id="settings-modal" class="fixed inset-0 z-50 flex items-center justify-center bg-black/60 hidden backdrop-blur-sm">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-md p-6 m-4 animate-fade-in">
            <div class="flex justify-between items-center mb-6 border-b pb-4">
                <h3 class="text-xl font-bold text-slate-800"><i class="fas fa-cog mr-2"></i> åƒæ•¸è¨­å®š</h3>
                <button onclick="toggleSettings()" class="text-slate-400 hover:text-slate-600"><i class="fas fa-times text-xl"></i></button>
            </div>
            <div class="space-y-4">
                <h4 class="font-bold text-sm text-slate-500 uppercase">æ•™è‚²è²»ç”¨é è¨­å€¼ (è¬/å¹´)</h4>
                <div class="grid grid-cols-2 gap-4">
                    <div><label class="text-xs font-bold block mb-1">å…¬ç«‹ - å¹¼å…’åœ’</label><input type="number" id="cfg-pub-kindergarten" class="form-input text-sm"></div>
                    <div><label class="text-xs font-bold block mb-1">ç§ç«‹ - å¹¼å…’åœ’</label><input type="number" id="cfg-pri-kindergarten" class="form-input text-sm"></div>
                    <div><label class="text-xs font-bold block mb-1">å…¬ç«‹ - åœ‹å°</label><input type="number" id="cfg-pub-elementary" class="form-input text-sm"></div>
                    <div><label class="text-xs font-bold block mb-1">ç§ç«‹ - åœ‹å°</label><input type="number" id="cfg-pri-elementary" class="form-input text-sm"></div>
                    <div><label class="text-xs font-bold block mb-1">å…¬ç«‹ - åœ‹ä¸­</label><input type="number" id="cfg-pub-junior" class="form-input text-sm"></div>
                    <div><label class="text-xs font-bold block mb-1">ç§ç«‹ - åœ‹ä¸­</label><input type="number" id="cfg-pri-junior" class="form-input text-sm"></div>
                    <div><label class="text-xs font-bold block mb-1">å…¬ç«‹ - é«˜ä¸­</label><input type="number" id="cfg-pub-senior" class="form-input text-sm"></div>
                    <div><label class="text-xs font-bold block mb-1">ç§ç«‹ - é«˜ä¸­</label><input type="number" id="cfg-pri-senior" class="form-input text-sm"></div>
                    <div><label class="text-xs font-bold block mb-1">å…¬ç«‹ - å¤§å­¸</label><input type="number" id="cfg-pub-university" class="form-input text-sm"></div>
                    <div><label class="text-xs font-bold block mb-1">ç§ç«‹ - å¤§å­¸</label><input type="number" id="cfg-pri-university" class="form-input text-sm"></div>
                </div>
            </div>
            <div class="mt-8 flex justify-end gap-3">
                <button onclick="resetDefaultConfig()" class="px-4 py-2 text-sm text-slate-500 hover:bg-slate-100 rounded-lg">æ¢å¾©é è¨­</button>
                <button onclick="saveConfig()" class="px-6 py-2 bg-slate-900 text-white rounded-lg font-bold hover:bg-slate-800">å„²å­˜</button>
            </div>
        </div>
    </div>

    <div id="app-container" class="pb-20">
        <div id="page1" class="container mx-auto py-6 px-4 md:py-10">
            <div class="max-w-6xl mx-auto glass-card shadow-2xl rounded-3xl overflow-hidden border border-white">
                <div class="gradient-bg p-6 md:p-8 text-white flex justify-between items-center">
                    <div>
                        <h1 class="text-2xl md:text-3xl font-black">å€å®‰ä¿éšªéœ€æ±‚åˆ†æç³»çµ±</h1>
                        <p class="mt-1 text-slate-300 text-xs md:text-sm">Your needs are our responsibility</p>
                    </div>
                    <div class="flex items-center gap-3">
                        <button type="button" onclick="clearAllData()" class="bg-white/10 hover:bg-white/20 text-white px-3 py-1.5 rounded-lg text-sm transition flex items-center backdrop-blur-sm border border-white/20"><i class="fas fa-trash-alt mr-2"></i>æ¸…é™¤</button>
                        <button type="button" onclick="toggleSettings()" class="text-white/80 hover:text-white transition p-2"><i class="fas fa-cog text-xl"></i></button>
                        <div class="text-right opacity-80 text-sm font-mono border-l pl-4 border-white/20">Step 1/3</div>
                    </div>
                </div>
                
                <div class="p-6 md:p-8">
                    <section class="mb-10">
                        <div class="flex justify-between items-end mb-6">
                            <h2 class="text-xl font-bold border-l-4 border-slate-700 pl-3 text-slate-800">å®¢æˆ¶åŸºæœ¬è³‡æ–™</h2>
                            <button type="button" onclick="addFamilyMember()" class="text-sm bg-slate-100 text-slate-600 px-4 py-2 rounded-full hover:bg-slate-200 font-bold transition shadow-sm">+ æ–°å¢æˆå“¡</button>
                        </div>
                        <div id="family-container" class="space-y-4">
                            <div id="main-user-row" class="grid grid-cols-1 md:grid-cols-12 gap-4 items-end bg-slate-50 p-5 rounded-2xl border border-slate-200 shadow-sm" data-relation="æœ¬äºº">
                                <div class="md:col-span-2">
                                    <label class="text-xs font-bold text-slate-500 uppercase tracking-wide mb-1 block">é—œä¿‚</label>
                                    <select id="main-relation" class="form-input bg-white font-bold text-slate-700 fam-rel">
                                        <option value="æœ¬äºº" selected>æœ¬äºº</option><option value="é…å¶">é…å¶</option><option value="å­">å­</option><option value="å¥³">å¥³</option><option value="çˆ¶">çˆ¶</option><option value="æ¯">æ¯</option><option value="ç¥–çˆ¶æ¯">ç¥–çˆ¶æ¯</option>
                                    </select>
                                </div>
                                <div class="md:col-span-3"><label class="text-xs font-bold text-slate-500 uppercase tracking-wide mb-1 block">å§“å</label><input type="text" id="main-name" placeholder="è«‹è¼¸å…¥å§“å" class="form-input name-input"></div>
                                <div class="md:col-span-4"><label class="text-xs font-bold text-slate-500 uppercase tracking-wide mb-1 block">å‡ºç”Ÿå¹´æœˆæ—¥</label><input type="date" id="main-dob" onchange="updateAge(this)" class="form-input dob-input fam-dob"></div>
                                <div class="md:col-span-3"><label class="text-xs font-bold text-slate-500 uppercase tracking-wide mb-1 block">ä¿éšªå¹´é½¡</label><div id="main-user-age-display" class="bg-white p-3 rounded-lg text-center font-bold text-slate-800 text-lg border border-slate-200 age-display">-- æ­²</div><input type="hidden" id="main-user-age-value" value="0"></div>
                            </div>
                        </div>
                    </section>

                    <section class="mb-10">
                        <h2 class="text-xl font-bold border-l-4 border-slate-700 pl-3 mb-6 text-slate-800">æ ¸å¿ƒæ“”æ†‚èˆ‡ç›®æ¨™ (è«‹å‹¾é¸)</h2>
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                            <label class="relative need-card rounded-3xl overflow-hidden shadow-lg cursor-pointer group">
                                <input type="checkbox" id="check-sick" class="hidden peer">
                                <div class="absolute inset-0 bg-cover bg-center transition-transform duration-700 group-hover:scale-110" style="background-image: url('https://images.unsplash.com/photo-1538108149393-fbbd81895907?q=80&w=600');"></div>
                                <div class="absolute inset-0 bg-black/40 peer-checked:bg-blue-900/80 transition-all"></div>
                                <div class="absolute top-6 right-6 text-white opacity-0 peer-checked:opacity-100 transition-all scale-0 peer-checked:scale-100"><i class="fas fa-check-circle text-4xl"></i></div>
                                <div class="relative h-full flex flex-col justify-end p-8 text-white"><h3 class="text-6xl font-black mb-2 tracking-tighter">ç—…</h3><p class="text-xl font-bold opacity-90">é«˜ç«¯é†«ç™‚å“è³ª</p></div>
                                <div class="absolute inset-0 border-4 border-transparent peer-checked:border-blue-400 rounded-3xl pointer-events-none border-overlay"></div>
                            </label>
                            
                            <label class="relative need-card rounded-3xl overflow-hidden shadow-lg cursor-pointer group">
                                <input type="checkbox" id="check-disability" class="hidden peer">
                                <div class="absolute inset-0 bg-cover bg-center transition-transform duration-700 group-hover:scale-110" style="background-image: url('https://images.unsplash.com/photo-1576765608535-5f04d1e3f289?q=80&w=600');"></div>
                                <div class="absolute inset-0 bg-black/40 peer-checked:bg-amber-900/80 transition-all"></div>
                                <div class="absolute top-6 right-6 text-white opacity-0 peer-checked:opacity-100 transition-all scale-0 peer-checked:scale-100"><i class="fas fa-check-circle text-4xl"></i></div>
                                <div class="relative h-full flex flex-col justify-end p-8 text-white"><h3 class="text-6xl font-black mb-2 tracking-tighter">æ®˜</h3><p class="text-xl font-bold opacity-90">å¤±èƒ½é•·ç…§é˜²è­·</p></div>
                                <div class="absolute inset-0 border-4 border-transparent peer-checked:border-amber-400 rounded-3xl pointer-events-none border-overlay"></div>
                            </label>

                            <label class="relative need-card rounded-3xl overflow-hidden shadow-lg cursor-pointer group">
                                <input type="checkbox" id="check-death" class="hidden peer">
                                <div class="absolute inset-0 bg-cover bg-center transition-transform duration-700 group-hover:scale-110" style="background-image: url('https://images.unsplash.com/photo-1475483768296-6163e08872a1?q=80&w=600');"></div>
                                <div class="absolute inset-0 bg-black/40 peer-checked:bg-rose-900/80 transition-all"></div>
                                <div class="absolute top-6 right-6 text-white opacity-0 peer-checked:opacity-100 transition-all scale-0 peer-checked:scale-100"><i class="fas fa-check-circle text-4xl"></i></div>
                                <div class="relative h-full flex flex-col justify-end p-8 text-white"><h3 class="text-6xl font-black mb-2 tracking-tighter">æ­»</h3><p class="text-xl font-bold opacity-90">å®¶åº­è²¬ä»»å‚³æ‰¿</p></div>
                                <div class="absolute inset-0 border-4 border-transparent peer-checked:border-rose-400 rounded-3xl pointer-events-none border-overlay"></div>
                            </label>

                            <label class="relative need-card rounded-3xl overflow-hidden shadow-lg cursor-pointer group">
                                <input type="checkbox" id="check-retire" class="hidden peer">
                                <div class="absolute inset-0 bg-cover bg-center transition-transform duration-700 group-hover:scale-110" style="background-image: url('https://images.unsplash.com/photo-1507525428034-b723cf961d3e?q=80&w=600');"></div>
                                <div class="absolute inset-0 bg-black/40 peer-checked:bg-emerald-900/80 transition-all"></div>
                                <div class="absolute top-6 right-6 text-white opacity-0 peer-checked:opacity-100 transition-all scale-0 peer-checked:scale-100"><i class="fas fa-check-circle text-4xl"></i></div>
                                <div class="relative h-full flex flex-col justify-end p-8 text-white"><h3 class="text-6xl font-black mb-2 tracking-tighter">è€</h3><p class="text-xl font-bold opacity-90">é€€ä¼‘è²¡å¯Œè‡ªç”±</p></div>
                                <div class="absolute inset-0 border-4 border-transparent peer-checked:border-emerald-400 rounded-3xl pointer-events-none border-overlay"></div>
                            </label>
                        </div>
                    </section>

                    <div class="flex justify-end pt-6">
                        <button type="button" onclick="goToPage2()" class="bg-slate-900 text-white px-10 py-4 rounded-xl font-bold text-xl hover:bg-slate-800 transition shadow-xl flex items-center transform hover:-translate-y-1">
                            ä¸‹ä¸€æ­¥ï¼šéœ€æ±‚é‡åŒ– <i class="fas fa-arrow-right ml-3"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <div id="page2" class="container mx-auto py-6 px-4 md:py-10 hidden animate-fade-in">
             <div class="max-w-6xl mx-auto space-y-6">
                <div class="flex justify-between items-center mb-4">
                    <button type="button" onclick="togglePages('page1')" class="text-slate-500 hover:text-slate-800 font-bold flex items-center px-4 py-2 bg-white rounded-lg shadow-sm border border-slate-200"><i class="fas fa-arrow-left mr-2"></i> è¿”å›ä¿®æ”¹</button>
                    <div class="text-sm font-bold text-slate-400 font-mono">Step 2/3</div>
                </div>

                <div id="section-sick" class="hidden bg-white p-6 rounded-2xl shadow-sm border border-slate-100">
                    <h2 class="text-xl md:text-2xl font-black text-slate-800 mb-6 flex items-center"><span class="bg-blue-100 p-2 rounded-lg mr-3 text-blue-600 text-xl">ğŸ¥</span> ç–¾ç—…é†«ç™‚éœ€æ±‚</h2>
                    <table class="w-full text-left financial-table mb-6">
                        <thead class="bg-slate-50 text-slate-600"><tr><th class="rounded-l-lg">é …ç›®</th><th>å“è³ªéœ€æ±‚</th><th>å¯å®‰å¿ƒé¡åº¦ (è¬)</th><th>å·²å‚™è¦åŠƒ (è¬)</th><th class="rounded-r-lg text-right">ç¼ºå£</th></tr></thead>
                        <tbody class="divide-y divide-slate-100">
                            <tr class="calc-row-sick"><td class="font-bold">ä½é™¢é›œè²»/å·®é¡</td><td><select class="form-input text-sm w-32 py-1"><option>å–®äººæˆ¿</option><option>é›™äººæˆ¿</option><option>å¥ä¿æˆ¿</option></select></td><td><input type="number" class="sick-target form-input" onkeyup="calculateAll()" placeholder="0"></td><td><input type="number" class="sick-current form-input" onkeyup="calculateAll()" placeholder="0"></td><td class="text-right font-bold text-red-500 sick-gap text-lg">0 è¬</td></tr>
                            <tr class="calc-row-sick"><td class="font-bold">ç™Œç—‡/é‡å¤§å‚·ç—…</td><td class="text-sm text-slate-400">ä¸€ç­†çµ¦ä»˜å‹</td><td><input type="number" class="sick-target form-input" onkeyup="calculateAll()" placeholder="0"></td><td><input type="number" class="sick-current form-input" onkeyup="calculateAll()" placeholder="0"></td><td class="text-right font-bold text-red-500 sick-gap text-lg">0 è¬</td></tr>
                        </tbody>
                    </table>
                    <div class="bg-slate-50 p-6 rounded-2xl border border-slate-200">
                        <h4 class="font-bold text-slate-800 mb-2 text-lg flex items-center"><i class="fas fa-lightbulb text-yellow-500 mr-2"></i> é¡§å•æŒ‡å¼•</h4>
                        <p class="text-slate-600 text-sm leading-relaxed"><strong>ä½é™¢å“è³ªï¼š</strong>å‡ç­‰å–®äººæˆ¿å¯é™ä½é™¢å…§äº¤å‰æ„ŸæŸ“é¢¨éšªï¼Œæå‡ä¼‘é¤Šå“è³ªã€‚ <strong>ç™Œç—‡è¶¨å‹¢ï¼š</strong>æ¨™é¶è—¥ç‰©ã€å…ç–«ç™‚æ³•å¤šéœ€è‡ªè²»ï¼Œå»ºè­°è¦åŠƒä¸€æ¬¡é‡‘ä»¥æ‡‰å°çŸ­æœŸå¤§é¡æ”¯å‡ºã€‚</p>
                    </div>
                </div>

                <div id="section-disability" class="hidden bg-white p-6 rounded-2xl shadow-sm border border-slate-100">
                    <h2 class="text-xl md:text-2xl font-black text-slate-800 mb-6 flex items-center"><span class="bg-amber-100 p-2 rounded-lg mr-3 text-amber-600 text-xl">â™¿</span> å¤±èƒ½ç…§è­·éœ€æ±‚</h2>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                        <div><label class="text-base font-bold text-slate-600 mb-2 block">é ä¼°æ¯æœˆç…§è­·è²» (è¬)</label><input type="number" id="dis-target" class="form-input text-lg persist-input" placeholder="ä¾‹å¦‚: 5" onkeyup="calculateAll()"></div>
                        <div><label class="text-base font-bold text-slate-600 mb-2 block">å·²å‚™æœˆæ‰¶åŠ©é‡‘ (è¬)</label><input type="number" id="dis-current" class="form-input text-lg persist-input" placeholder="ä¾‹å¦‚: 1" onkeyup="calculateAll()"></div>
                    </div>
                    <div class="bg-amber-50 p-6 rounded-2xl text-center border border-amber-100 mb-6"><div class="text-sm text-amber-800 uppercase tracking-wider mb-1 font-bold">æ¯æœˆç¼ºå£</div><div class="text-5xl font-black text-amber-600" id="dis-gap">0 <span class="text-xl">è¬/æœˆ</span></div></div>
                    <div class="bg-slate-50 p-6 rounded-2xl border border-slate-200">
                        <h4 class="font-bold text-slate-800 mb-2 text-lg"><i class="fas fa-chart-line text-yellow-500 mr-2"></i> å¸‚å ´è¡Œæƒ…åƒè€ƒ</h4>
                        <ul class="text-slate-600 text-sm list-disc list-inside leading-relaxed"><li><strong>å¤–ç±çœ‹è­·ï¼š</strong> ç´„ 2.5 ~ 3 è¬/æœˆ</li><li><strong>å°ˆæ¥­æ©Ÿæ§‹ï¼š</strong> ç´„ 4 ~ 6 è¬/æœˆ</li><li><strong>æœ¬åœ‹çœ‹è­·ï¼š</strong> ç´„ 7 ~ 8 è¬/æœˆ</li><li class="list-none ml-4 text-slate-400 mt-1">* å°šæœªåŒ…å«å°¿å¸ƒã€ç‡Ÿé¤Šå“ç­‰è€—æè²» (ç´„ 1 è¬/æœˆ)</li></ul>
                    </div>
                </div>

                <div id="section-death" class="hidden bg-white p-6 rounded-2xl shadow-sm border border-slate-100">
                    <h2 class="text-xl md:text-2xl font-black text-slate-800 mb-6 flex items-center"><span class="bg-rose-100 p-2 rounded-lg mr-3 text-rose-600 text-xl">ğŸ•Šï¸</span> èº«æ•…è²¬ä»»ç²¾ç®—</h2>
                    <div class="space-y-8">
                        <div>
                            <div class="flex justify-between items-center mb-4 border-b border-slate-100 pb-2"><h3 class="font-bold text-slate-700 text-lg">çˆ¶æ¯å­é¤Šé‡‘</h3><button onclick="addParentRow()" class="text-xs bg-blue-50 text-blue-600 font-bold px-3 py-1.5 rounded hover:bg-blue-100 transition">+ æ‰‹å‹•æ–°å¢</button></div>
                            <div id="parents-container" class="space-y-3"></div>
                        </div>
                        <div>
                             <div class="flex justify-between items-center mb-4 border-b border-slate-100 pb-2"><h3 class="font-bold text-slate-700 text-lg">é…å¶èˆ‡ç”Ÿæ´»</h3></div>
                             <div class="grid grid-cols-2 gap-6"><div><label class="text-sm font-bold text-slate-500 block mb-2">æ¯æœˆç”Ÿæ´»è²» (è¬)</label><input type="number" id="living-monthly" class="form-input" placeholder="0" onkeyup="calculateAll()"></div><div><label class="text-sm font-bold text-slate-500 block mb-2">ç…§é¡§å¹´æ•¸ (å¹´)</label><input type="number" id="living-years" class="form-input" placeholder="ä¾‹å¦‚: 20" onkeyup="calculateAll()"></div></div>
                        </div>
                        <div>
                             <div class="flex justify-between items-center mb-4 border-b border-slate-100 pb-2"><h3 class="font-bold text-slate-700 text-lg">å­å¥³æ•™è‚²åŸºé‡‘ <span class="text-xs font-normal text-slate-400 ml-2">(ä¾æ•™è‚²éƒ¨åƒè€ƒæ¨™æº–ä¼°ç®—)</span></h3></div>
                             <div id="edu-container" class="space-y-4"></div>
                        </div>
                        <div>
                            <div class="flex justify-between items-center mb-4 border-b border-slate-100 pb-2"><h3 class="font-bold text-slate-700 text-lg">å±…ä½èˆ‡æœ€å¾Œè²»ç”¨</h3></div>
                            <div class="grid grid-cols-2 gap-6"><div><label class="text-sm font-bold text-slate-500 block mb-2">æˆ¿è²¸/ç§Ÿé‡‘æœˆæ”¯ (è¬)</label><input type="number" id="house-monthly" class="form-input" placeholder="0" onkeyup="calculateAll()"></div><div><label class="text-sm font-bold text-slate-500 block mb-2">å‰©é¤˜å¹´æ•¸ (å¹´)</label><input type="number" id="house-years" class="form-input" placeholder="0" onkeyup="calculateAll()"></div></div>
                        </div>
                    </div>
                    <div class="mt-10 pt-8 border-t-2 border-slate-100">
                         <div class="bg-slate-800 text-white rounded-2xl p-8 shadow-xl text-center relative overflow-hidden">
                            <div class="absolute top-0 left-0 w-full h-2 bg-gradient-to-r from-rose-400 to-orange-400"></div>
                            <h4 class="text-xs font-bold opacity-60 mb-2 uppercase tracking-widest text-white">èº«æ•…è²¬ä»»ç¸½ç¼ºå£</h4>
                            <div class="text-6xl font-black mb-6 tracking-tight"><span id="grand-total-gap" data-need="0">0</span><span class="text-2xl ml-2 font-bold opacity-80">è¬</span></div>
                            <div class="inline-flex items-center gap-3 bg-white/10 px-6 py-3 rounded-xl border border-white/10 backdrop-blur-sm">
                                <span class="text-sm font-bold text-slate-300">æ‰£é™¤ç¾æœ‰å£½éšª (è¬)</span>
                                <input type="number" id="existing-insurance-p2" class="bg-transparent border-b-2 border-white/50 w-28 text-center font-bold text-xl focus:outline-none text-white focus:border-white placeholder-white/20" placeholder="0" oninput="syncInsurance(this.value, 'comm-insurance-p3')">
                            </div>
                        </div>
                    </div>
                </div>

                <div id="section-retire" class="hidden bg-white p-6 rounded-2xl shadow-lg border-l-8 border-emerald-500 calc-section">
                    <h2 class="text-xl md:text-2xl font-black text-slate-800 mb-6 flex items-center"><span class="bg-emerald-100 p-2 rounded-lg mr-3 text-emerald-600 text-xl">ğŸŒ…</span> é€€ä¼‘ç”Ÿæ´»è¦åŠƒ</h2>
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                        <div class="space-y-4">
                            <div class="grid grid-cols-2 gap-4"><div><label class="block text-sm font-bold text-slate-500 mb-1">ç›®å‰å¹´é½¡</label><input type="number" id="retire-current-age" class="form-input bg-slate-100 font-bold text-slate-500 cursor-not-allowed" readonly></div><div><label class="block text-sm font-bold text-emerald-600 mb-1">é€€ä¼‘å¹´é½¡</label><input type="number" id="retire-target-age" class="form-input font-bold text-emerald-700" placeholder="ä¾‹å¦‚: 65" onkeyup="calculateAll()"></div></div>
                            <div class="grid grid-cols-2 gap-4"><div><label class="block text-sm font-bold text-slate-600 mb-1">é ä¼°å£½å‘½</label><input type="number" id="retire-end-age" class="form-input" placeholder="ä¾‹å¦‚: 85" onkeyup="calculateAll()"></div><div><label class="block text-sm font-bold text-slate-600 mb-1">é€€ä¼‘æœˆèŠ±è²»(è¬)</label><input type="number" id="retire-monthly" class="form-input" placeholder="ä¾‹å¦‚: 3" onkeyup="calculateAll()"></div></div>
                        </div>
                        <div class="flex flex-col justify-center space-y-4">
                            <div class="bg-emerald-50 rounded-2xl p-6 text-center border border-emerald-100"><div class="text-sm font-bold text-emerald-800 mb-1 uppercase">é€€ä¼‘é‡‘ç¸½éœ€æ±‚</div><div class="text-4xl font-black text-emerald-600"><span id="retire-total-needed">0</span> è¬</div></div>
                            <div class="bg-gradient-to-r from-emerald-600 to-teal-700 rounded-2xl p-6 text-center text-white shadow-xl"><div class="text-base font-bold opacity-80 mb-2">ç¾åœ¨é–‹å§‹ï¼Œæ¯å¹´éœ€å­˜</div><div class="text-5xl font-black"><span id="retire-annual-save">0</span> <span class="text-lg">è¬/å¹´</span></div></div>
                        </div>
                    </div>
                </div>

                <div class="flex justify-center mt-12 pb-16">
                    <button type="button" onclick="goToPage3()" class="bg-slate-900 text-white px-10 py-5 rounded-full font-bold text-xl hover:bg-slate-800 transition shadow-2xl flex items-center transform hover:-translate-y-1">
                        ä¸‹ä¸€æ­¥ï¼šè²¡å‹™è©¦ç®— <i class="fas fa-arrow-right ml-3"></i>
                    </button>
                </div>
             </div>
        </div>

        <div id="page3" class="container mx-auto py-6 px-4 md:py-10 hidden">
             <div class="max-w-6xl mx-auto space-y-6">
                <div class="flex justify-between items-center mb-4">
                    <button type="button" onclick="togglePages('page2')" class="text-slate-500 hover:text-slate-800 font-bold flex items-center px-4 py-2 bg-white rounded-lg shadow-sm border border-slate-200"><i class="fas fa-arrow-left mr-2"></i> è¿”å›ç¼ºå£</button>
                    <div class="text-sm font-bold text-slate-400 font-mono">Step 3/3</div>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-200">
                        <div class="flex justify-between items-center mb-4"><h3 class="font-bold text-emerald-600 text-lg">å¹´åº¦æ”¶å…¥æ¦‚æ³</h3><button onclick="addFlowRow('income')" class="text-xs bg-emerald-50 text-emerald-600 font-bold px-3 py-1.5 rounded-full hover:bg-emerald-100 transition">+ æ–°å¢</button></div>
                        <table class="w-full financial-table"><tbody id="income-body"></tbody></table>
                    </div>
                    <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-200">
                        <div class="flex justify-between items-center mb-4"><h3 class="font-bold text-red-500 text-lg">å¹´åº¦æ”¯å‡ºæ¦‚æ³</h3><button onclick="addFlowRow('expense')" class="text-xs bg-red-50 text-red-600 font-bold px-3 py-1.5 rounded-full hover:bg-red-100 transition">+ æ–°å¢</button></div>
                        <table class="w-full financial-table"><tbody id="expense-body"></tbody></table>
                    </div>
                </div>

                <div class="bg-slate-900 text-white p-8 rounded-2xl flex justify-between items-center shadow-lg">
                    <span class="text-lg opacity-80 font-bold">å¹´åº¦æ·¨ç¾é‡‘æµ (çµé¤˜)</span>
                    <span id="net-cashflow" class="text-4xl font-black">0 è¬</span>
                </div>

                <div class="bg-white p-8 rounded-3xl shadow-sm border border-slate-200">
                    <h3 class="font-bold text-blue-600 mb-6 text-xl flex items-center"><i class="fas fa-shield-alt mr-2"></i> ç¤¾æœƒä¿éšªèˆ‡ä¿éšœè©¦ç®—</h3>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-8">
                        <div class="bg-slate-50 p-5 rounded-xl border border-slate-200">
                            <label class="text-xs font-bold text-slate-500 block mb-2 uppercase">ä¿éšªèº«ä»½</label>
                            <select id="si-type" class="si-select" onchange="updateSocialInsurance()">
                                <option value="labor" selected>å‹ä¿</option>
                                <option value="gov">å…¬ä¿</option>
                                <option value="farmer">è¾²ä¿</option>
                                <option value="fisher">æ¼ä¿</option>
                                <option value="national">åœ‹ä¿</option>
                            </select>
                            <div class="mt-4">
                                <label class="text-xs font-bold text-slate-500 block mb-2 uppercase">æŠ•ä¿è–ªè³‡ / ä¿ä¿¸</label>
                                <div class="relative">
                                    <span class="absolute left-3 top-2.5 text-slate-400">$</span>
                                    <input type="number" id="labor-salary-p3" class="form-input pl-6 font-bold" oninput="calculateAll()">
                                </div>
                            </div>
                            <div class="flex justify-end mt-2">
                                <a id="si-table-link" href="https://www.bli.gov.tw/0005475.html" target="_blank" class="salary-table-link"><i class="fas fa-external-link-alt mr-1"></i>æŸ¥çœ‹ç´šè·è¡¨</a>
                            </div>
                            <div class="mt-4 pt-4 border-t border-slate-200">
                                <div class="flex justify-between items-center">
                                    <span class="text-xs font-bold text-slate-500">é ä¼°èº«æ•…çµ¦ä»˜</span>
                                    <span class="text-lg font-black text-blue-600"><span id="labor-benefit-val-p3">0</span> è¬</span>
                                </div>
                                <div id="si-note" class="text-[10px] text-slate-400 mt-1 text-right"></div>
                            </div>
                        </div>
                        <div class="bg-slate-50 p-5 rounded-xl border border-slate-200">
                            <label class="text-xs font-bold text-slate-500 block mb-2 uppercase">å…¬å¸åœ˜ä¿ / æ’«å¹</label>
                            <div class="relative">
                                <input type="number" id="group-insurance-p3" class="form-input font-bold" placeholder="0" oninput="calculateAll()">
                                <span class="absolute right-3 top-2.5 text-slate-400 text-sm font-bold">è¬</span>
                            </div>
                        </div>
                        <div class="bg-slate-50 p-5 rounded-xl border border-slate-200">
                            <label class="text-xs font-bold text-slate-500 block mb-2 uppercase">å•†æ¥­å£½éšª (ç¾æœ‰ä¿å–®)</label>
                            <div class="relative">
                                <input type="number" id="comm-insurance-p3" class="form-input font-bold" placeholder="0" oninput="syncInsurance(this.value, 'existing-insurance-p2')">
                                <span class="absolute right-3 top-2.5 text-slate-400 text-sm font-bold">è¬</span>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="flex justify-center mt-12 pb-16">
                    <button type="button" onclick="generateReport()" class="bg-slate-900 text-white px-12 py-5 rounded-full text-xl font-bold shadow-2xl hover:bg-slate-800 transition-all flex items-center"><i class="fas fa-print mr-3"></i> ç”¢å‡ºå°ˆæ¥­å ±å‘Š</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        const DEFAULT_CONFIG = { 'pub-kindergarten': 6, 'pri-kindergarten': 15, 'pub-elementary': 2, 'pri-elementary': 20, 'pub-junior': 3, 'pri-junior': 20, 'pub-senior': 5, 'pri-senior': 25, 'pub-university': 10, 'pri-university': 30, 'pub-master': 10, 'pri-master': 30 };
        let CONFIG = { ...DEFAULT_CONFIG };
        const EDU_STAGES = [ { id: 'kindergarten', name: 'å¹¼å…’åœ’', years: 3, minAge: 3, maxAge: 6 }, { id: 'elementary', name: 'åœ‹å°', years: 6, minAge: 6, maxAge: 12 }, { id: 'junior', name: 'åœ‹ä¸­', years: 3, minAge: 12, maxAge: 15 }, { id: 'senior', name: 'é«˜ä¸­', years: 3, minAge: 15, maxAge: 18 }, { id: 'university', name: 'å¤§å­¸', years: 4, minAge: 18, maxAge: 22 } ];
        const SI_DATA = {
            labor: { label: 'å‹ä¿èº«æ•…çµ¦ä»˜', note: '* ä¾å‹ä¿æ™®é€šå‚·ç—…èº«æ•…(35å€‹æœˆ)ä¼°ç®—', tableUrl: 'https://www.bli.gov.tw/0005475.html' },
            gov: { label: 'å…¬ä¿æ­»äº¡çµ¦ä»˜', note: '* ä¾æœªæ»¿20å¹´æŠ•ä¿å¹´è³‡(30å€‹æœˆ)ä¿å®ˆä¼°ç®—', tableUrl: 'https://www.bot.com.tw/tw/policy-business/government-employees-insurance-service/downloads/cash-payment-form' },
            farmer: { label: 'è¾²ä¿å–ªè‘¬æ´¥è²¼', note: '* å›ºå®šæŠ•ä¿é‡‘é¡20,400å…ƒ x 15å€‹æœˆ', fixed: 20400, tableUrl: null },
            fisher: { label: 'æ¼ä¿èº«æ•…çµ¦ä»˜', note: '* æ¯”ç…§å‹ä¿ç”²é¡æœƒå“¡æ¨™æº–(35å€‹æœˆ)ä¼°ç®—', tableUrl: 'https://www.bli.gov.tw/0005475.html' },
            national: { label: 'åœ‹ä¿å–ªè‘¬çµ¦ä»˜', note: '* å›ºå®šæœˆæŠ•ä¿é‡‘é¡ 19,761å…ƒ x 5å€‹æœˆ', fixed: 19761, tableUrl: null }
        };

        function initSystem() {
            clearAllInputs();
            const saved = localStorage.getItem('pwm_config');
            if(saved) CONFIG = { ...DEFAULT_CONFIG, ...JSON.parse(saved) };
            if(document.getElementById('income-body').children.length === 0) addFlowRow('income');
            if(document.getElementById('expense-body').children.length === 0) addFlowRow('expense');
            document.getElementById('si-type').value = 'labor';
            updateSocialInsurance();
            calculateAll();
        }

        function clearAllData() { if(confirm('ç¢ºå®šè¦æ¸…ç©ºæ‰€æœ‰è³‡æ–™å—ï¼Ÿ')) { clearAllInputs(); initSystem(); } }
        function clearAllInputs() {
            document.querySelectorAll('input').forEach(i => { if(i.type === 'checkbox' || i.type === 'radio') i.checked = false; else i.value = ''; });
            document.querySelectorAll('select:not(#si-type)').forEach(s => s.selectedIndex = 0);
            document.getElementById('parents-container').innerHTML = '';
            document.getElementById('edu-container').innerHTML = '';
            document.getElementById('income-body').innerHTML = '';
            document.getElementById('expense-body').innerHTML = '';
            document.getElementById('main-user-age-display').innerText = '-- æ­²';
            addFlowRow('income'); addFlowRow('expense');
        }

        function updateSocialInsurance() {
            const type = document.getElementById('si-type').value;
            const data = SI_DATA[type];
            const input = document.getElementById('labor-salary-p3');
            const link = document.getElementById('si-table-link');
            document.getElementById('si-note').innerText = data.note;
            if(data.tableUrl) { link.href = data.tableUrl; link.classList.remove('hidden'); } else { link.classList.add('hidden'); }
            if(data.fixed) { input.value = data.fixed; input.setAttribute('readonly', true); input.classList.add('bg-slate-100'); } else { input.removeAttribute('readonly'); input.classList.remove('bg-slate-100'); if(input.value == 20400 || input.value == 19761) input.value = ''; }
            calculateAll();
        }

        function calculateAll() {
            const fmt = n => parseFloat(n).toLocaleString('en-US'); const clean = str => parseFloat(String(str).replace(/,/g, '')) || 0;
            document.querySelectorAll('.calc-row-sick').forEach(row => { const t = clean(row.querySelector('.sick-target').value); const c = clean(row.querySelector('.sick-current').value); row.querySelector('.sick-gap').innerText = fmt(Math.max(0, t - c)) + " è¬"; });
            const disG = Math.max(0, clean(document.getElementById('dis-target').value) - clean(document.getElementById('dis-current').value)); document.getElementById('dis-gap').innerHTML = `${fmt(disG)} <span class="text-xl">è¬/æœˆ</span>`;
            
            const rTar=clean(document.getElementById('retire-target-age').value)||65, rCur=clean(document.getElementById('retire-current-age').value), rEnd=clean(document.getElementById('retire-end-age').value)||85;
            const rTot=clean(document.getElementById('retire-monthly').value)*12*Math.max(0, rEnd-rTar);
            document.getElementById('retire-total-needed').innerText = fmt(rTot);
            document.getElementById('retire-annual-save').innerText = fmt((rTot/Math.max(1, rTar-rCur)).toFixed(1));

            let pTotal=0; document.querySelectorAll('.parent-row').forEach(r => { const m=clean(r.querySelector('.p-money').value), end=clean(r.querySelector('.p-type').value), age=clean(r.querySelector('.p-age').value); pTotal+=m*12*Math.max(0,end-age); });
            document.getElementById('total-parents').innerText = fmt(pTotal) + " è¬";
            
            let eduTotal=0; document.querySelectorAll('.edu-child-card').forEach(card => {
                let sub=0; card.querySelectorAll('.edu-toggle-input:checked').forEach(input => { const stage=input.name.split('_')[1]; const type=input.value.split('_')[0]; const years=parseFloat(input.value.split('_')[1]); sub += (type==='public'?CONFIG['pub-'+stage]:CONFIG['pri-'+stage]) * years; });
                card.querySelector('.child-subtotal').innerText = fmt(sub); eduTotal += sub;
            });
            document.getElementById('total-edu').innerText = fmt(eduTotal) + " è¬"; // Explicit update

            const living = clean(document.getElementById('living-monthly').value)*12*clean(document.getElementById('living-years').value);
            const house = clean(document.getElementById('house-monthly').value)*12*clean(document.getElementById('house-years').value);
            document.getElementById('total-house').innerText = fmt(house) + " è¬";

            const siType=document.getElementById('si-type').value; const sal=clean(document.getElementById('labor-salary-p3').value);
            let siBen=0;
            if(siType==='labor'||siType==='fisher') siBen=sal*35; else if(siType==='gov') siBen=sal*30; else if(siType==='farmer') siBen=20400*15; else siBen=19761*5;
            document.getElementById('labor-benefit-val-p3').innerText = fmt(Math.round(siBen/10000));

            const grp=clean(document.getElementById('group-insurance-p3').value), comm=clean(document.getElementById('comm-insurance-p3').value);
            const deathNeed = pTotal + living + eduTotal + house;
            const deathGap = Math.max(0, deathNeed - (Math.round(siBen/10000)+grp+comm));
            document.getElementById('grand-total-gap').innerText = fmt(Math.round(deathGap)); document.getElementById('grand-total-gap').dataset.need = deathNeed;

            let inc=0; document.querySelectorAll('.income-amount').forEach(i=>inc+=clean(i.value));
            let exp=0; document.querySelectorAll('.expense-amount').forEach(i=>exp+=clean(i.value));
            const net=inc-exp; const netEl=document.getElementById('net-cashflow'); netEl.innerText=fmt(net)+" è¬"; netEl.className=`text-4xl font-black ${net>=0?'text-emerald-500':'text-red-500'}`;
            
            updateExpenseRow('æˆ¿è²¸/æˆ¿ç§Ÿ', clean(document.getElementById('house-monthly').value)*12);
            updateExpenseRow('å­è¦ªè²»', clean(document.querySelector('.p-money')?.value||0)*12);
        }

        function toggleSettings() { const m=document.getElementById('settings-modal'); m.classList.toggle('hidden'); if(!m.classList.contains('hidden')) for(k in CONFIG) document.getElementById('cfg-'+k).value=CONFIG[k]; }
        function saveConfig() { for(k in CONFIG) CONFIG[k]=parseFloat(document.getElementById('cfg-'+k).value)||CONFIG[k]; localStorage.setItem('pwm_config',JSON.stringify(CONFIG)); toggleSettings(); calculateAll(); }
        function resetDefaultConfig() { if(confirm('æ¢å¾©é è¨­ï¼Ÿ')) { CONFIG={...DEFAULT_CONFIG}; for(k in CONFIG) document.getElementById('cfg-'+k).value=CONFIG[k]; } }
        
        function updateAge(input) { if(!input.value) return; const dob=new Date(input.value); const today=new Date(); let age=today.getFullYear()-dob.getFullYear(); if(today<new Date(today.getFullYear(),dob.getMonth(),dob.getDate())) age--; if(input.id==='main-dob') { document.getElementById('main-user-age-display').innerText=age+" æ­²"; document.getElementById('main-user-age-value').value=age; document.getElementById('retire-current-age').value=age; } calculateAll(); }
        function getAge(d) { if(!d) return 0; const dob=new Date(d); const t=new Date(); let a=t.getFullYear()-dob.getFullYear(); if(t<new Date(t.getFullYear(),dob.getMonth(),dob.getDate())) a--; return a; }

        function addFamilyMember() {
            const div = document.createElement('div');
            div.className = "grid grid-cols-1 md:grid-cols-12 gap-4 items-end bg-slate-50 p-5 rounded-2xl border border-slate-200 relative animate-fade-in family-member-row";
            div.innerHTML = `<div class="md:col-span-2"><label class="block text-xs font-bold text-slate-500 mb-1">é—œä¿‚</label><select class="form-input fam-rel"><option>é…å¶</option><option>å­</option><option>å¥³</option><option>çˆ¶</option><option>æ¯</option><option>ç¥–çˆ¶æ¯</option></select></div><div class="md:col-span-3"><label class="block text-xs font-bold text-slate-500 mb-1">å§“å</label><input type="text" class="form-input name-input"></div><div class="md:col-span-4"><label class="block text-xs font-bold text-slate-500 mb-1">å‡ºç”Ÿå¹´æœˆæ—¥</label><input type="date" class="form-input dob-input fam-dob" onchange="updateAge(this)"></div><div class="md:col-span-3 relative"><label class="block text-xs font-bold text-slate-500 mb-1">ä¿éšªå¹´é½¡</label><div class="bg-white p-3 rounded-lg text-center font-bold text-slate-800 border border-slate-200 age-display">-- æ­²</div><button onclick="this.closest('.grid').remove()" class="absolute -top-2 -right-2 text-red-400 hover:text-red-600"><i class="fas fa-times-circle"></i></button></div>`;
            document.getElementById('family-container').appendChild(div);
        }

        function populateDeathNeeds() {
            if(!document.getElementById('check-death').checked) return;
            const pC = document.getElementById('parents-container'); const eC = document.getElementById('edu-container');
            pC.innerHTML=''; eC.innerHTML='';
            document.querySelectorAll('#family-container .grid').forEach(r => {
                const rel = r.querySelector('.fam-rel').value;
                const name = r.querySelector('.name-input').value || rel;
                const dob = r.querySelector('.fam-dob').value;
                if(dob) {
                    const age = getAge(dob);
                    if(rel==='çˆ¶') addParentRow(name, age, 76);
                    else if(rel==='æ¯') addParentRow(name, age, 84);
                    else if(rel==='å­'||rel==='å¥³') {
                        let html = `<div class="edu-child-card bg-slate-50 p-4 rounded-xl border border-slate-200"><div class="flex justify-between font-bold text-slate-700 mb-2 border-b pb-2"><span>${name} (${age}æ­²)</span><span>å°è¨ˆ: <span class="child-subtotal text-blue-600">0</span> è¬</span></div>`;
                        let hasStage = false;
                        EDU_STAGES.forEach(s => {
                            if(age < s.maxAge) {
                                hasStage = true;
                                let y = s.years; if(age > s.minAge) y = s.maxAge - age; y = Math.min(y, s.years);
                                const uid = Math.random().toString(36).substr(2,9);
                                html += `<div class="edu-stage-row"><div class="text-sm font-bold text-slate-600">${s.name} <span class="text-xs font-normal text-slate-400">(${y}å¹´)</span></div>
                                <div class="flex items-center gap-1"><input type="radio" name="e_${uid}" value="public_${y}" id="pub_${uid}" class="hidden edu-toggle-input" onchange="calculateAll()"><label for="pub_${uid}" class="edu-toggle-label w-full">å…¬ç«‹</label></div>
                                <div class="flex items-center gap-1"><input type="radio" name="e_${uid}" value="private_${y}" id="pri_${uid}" class="hidden edu-toggle-input" onchange="calculateAll()" checked><label for="pri_${uid}" class="edu-toggle-label w-full">ç§ç«‹</label></div></div>`;
                            }
                        });
                        html += `</div>`;
                        if(hasStage) eC.insertAdjacentHTML('beforeend', html);
                    }
                }
            });
            calculateAll();
        }

        function addParentRow(n, a, t) { const d=document.createElement('div'); d.className="flex gap-4 mb-2 items-center bg-slate-50 p-3 rounded-lg border border-slate-200 parent-row"; d.innerHTML=`<div class="w-20 text-center"><div class="font-bold text-slate-700">${n}</div><div class="text-xs text-slate-400">${a?a+'æ­²':''}</div></div><div class="flex-1 grid grid-cols-2 gap-2"><div><label class="text-[10px] text-slate-400 block">é ä¼°å£½å‘½</label><input type="number" class="p-type form-input h-8 text-sm" value="${t||80}"></div><div><label class="text-[10px] text-slate-400 block">æœˆå­é¤Š(è¬)</label><input type="number" class="p-money form-input h-8 text-sm" oninput="calculateAll()"></div></div><input type="hidden" class="p-age" value="${a||0}"><button onclick="this.parentElement.remove();calculateAll()" class="text-slate-400 hover:text-red-500"><i class="fas fa-trash"></i></button>`; document.getElementById('parents-container').appendChild(d); }
        function addChildEduRow() { alert('è«‹åœ¨ç¬¬ä¸€é æ–°å¢å­å¥³è³‡æ–™ï¼Œç³»çµ±å°‡è‡ªå‹•è¨ˆç®—æ•™è‚²åŸºé‡‘'); } // Fallback

        function addFlowRow(type, name, amount) {
            const current = Array.from(document.querySelectorAll(`.${type}-select`)).map(s=>s.value);
            const master = type==='income'?['è–ªè³‡æ”¶å…¥','å¹´çµ‚çé‡‘','è‚¡åˆ©','ç§Ÿé‡‘','å…¼è·','æŠ•è³‡','å…¶ä»–']:['ç”Ÿæ´»é–‹éŠ·','äº¤é€š','æˆ¿è²¸/æˆ¿ç§Ÿ','ä¿éšª','å­è¦ªè²»','æ•™è‚²','å¨›æ¨‚','é›œæ”¯','å…¶ä»–'];
            const avail = master.filter(i=>!current.includes(i));
            if(avail.length===0) { alert('å·²ç„¡æ›´å¤šé¸é …'); return; }
            const tr = document.createElement('tr');
            tr.innerHTML = `<td><select class="form-input ${type}-select" onchange="saveData()">${avail.map(o=>`<option>${o}</option>`).join('')}</select></td><td><input type="number" class="form-input ${type}-amount" placeholder="0" onkeyup="calculateAll()"></td><td class="text-right"><button onclick="this.closest('tr').remove();calculateAll()" class="text-slate-300 hover:text-red-400"><i class="fas fa-trash"></i></button></td>`;
            document.getElementById(type+'-body').appendChild(tr);
            if(name) { const sel=tr.querySelector('select'); if(![...sel.options].some(o=>o.value===name)) { const o=document.createElement('option'); o.value=name; o.text=name; sel.add(o); } sel.value=name; }
            if(amount) tr.querySelector('input').value=amount;
        }

        function updateExpenseRow(n, v) { if(!v) return; let f=false; document.querySelectorAll('.expense-select').forEach(s=>{ if(s.value===n) { s.closest('tr').querySelector('input').value=Math.round(v); f=true; }}); if(!f) addFlowRow('expense', n, Math.round(v)); }
        function syncInsurance(v, tid) { document.getElementById(tid).value = v; calculateAll(); }
        function saveData() {} // No auto-save

        function goToPage2() { document.getElementById('page1').classList.add('hidden'); document.getElementById('page2').classList.remove('hidden'); window.scrollTo(0,0); 
            const checks=['check-sick','check-disability','check-death','check-retire']; checks.forEach(id=>{ const el=document.getElementById(id.replace('check-','section-')); if(document.getElementById(id).checked) el.classList.remove('hidden'); else el.classList.add('hidden'); });
            populateDeathNeeds(); calculateAll(); 
        }
        function goToPage3() { document.getElementById('page2').classList.add('hidden'); document.getElementById('page3').classList.remove('hidden'); window.scrollTo(0,0); calculateAll(); }
        function togglePages(id) { document.querySelectorAll('[id^="page"]').forEach(e=>e.classList.add('hidden')); document.getElementById(id).classList.remove('hidden'); window.scrollTo(0,0); }

        async function generateReport() {
            const overlay = document.getElementById('loading-overlay'); overlay.style.display = 'flex';
            await new Promise(r => setTimeout(r, 800));
            calculateAll();
            const name = document.getElementById('main-name').value || 'è²´è³“';
            const date = new Date().toLocaleDateString();
            const clean = v => parseFloat(String(v).replace(/,/g,''))||0;
            const fmt = n => n.toLocaleString('en-US');

            let sickGap=0; document.querySelectorAll('.sick-gap').forEach(e=>sickGap+=clean(e.innerText));
            const disGap = document.getElementById('dis-gap').innerText;
            const deathGap = document.getElementById('grand-total-gap').innerText;
            const retireGap = document.getElementById('retire-annual-save').innerText;
            const deathNeed = clean(document.getElementById('grand-total-gap').dataset.need);
            const siVal = document.getElementById('labor-benefit-val-p3').innerText;
            const grpVal = document.getElementById('group-insurance-p3').value||0;
            const commVal = document.getElementById('comm-insurance-p3').value||0;
            let inc=0; document.querySelectorAll('.income-amount').forEach(i=>inc+=clean(i.value));
            let exp=0; document.querySelectorAll('.expense-amount').forEach(i=>exp+=clean(i.value));
            const net = inc - exp;

            const advice = [];
            if(sickGap>0) advice.push(`<strong>ğŸ¥ é†«ç™‚å“è³ª (ç—…)</strong>ï¼šå°šæœ‰ç¼ºå£ ${fmt(sickGap)} è¬ã€‚å»ºè­°å„ªå…ˆè£œè¶³å¯¦æ”¯å¯¦ä»˜èˆ‡é‡å¤§å‚·ç—…éšªï¼Œç¢ºä¿é†«ç™‚è‡ªä¸»æ¬Šã€‚`);
            if(clean(disGap)>0) advice.push(`<strong>â™¿ å¤±èƒ½ç…§è­· (æ®˜)</strong>ï¼šæ¯æœˆç¼ºå£ ${disGap}ã€‚é•·æœŸçœ‹è­·å°‡ä¾µè•è³‡ç”¢ï¼Œå»ºè­°è¦åŠƒå¤±èƒ½æ‰¶åŠ©éšªè½‰å«é¢¨éšªã€‚`);
            if(clean(deathGap)>0) advice.push(`<strong>ğŸ•Šï¸ å®¶åº­è²¬ä»» (æ­»)</strong>ï¼šèº«æ•…ç¼ºå£é” ${deathGap}ã€‚å»ºè­°åˆ©ç”¨å®šæœŸå£½éšªçš„é«˜æ§“æ¡¿ç‰¹æ€§ï¼Œä½é ç®—è£œè¶³å°å®¶äººçš„æ„›ã€‚`);
            if(clean(retireGap)>0) advice.push(`<strong>ğŸŒ… é€€ä¼‘æ¨‚æ´» (è€)</strong>ï¼šæ¯å¹´éœ€å­˜ ${retireGap} è¬ã€‚æ™‚é–“æ˜¯è¤‡åˆ©æœ€å¥½çš„æœ‹å‹ï¼Œå»ºè­°å³åˆ»å•Ÿå‹•å°ˆæ¬¾å°ˆç”¨è¨ˆç•«ã€‚`);
            if(advice.length===0) advice.push("<strong>ğŸ‘ æ­å–œæ‚¨ï¼</strong>ç›®å‰çš„ä¿éšœè¦åŠƒç›¸ç•¶å®Œå–„ã€‚å»ºè­°å®šæœŸæª¢è¦–ä¿å–®ï¼Œç¢ºä¿é¡åº¦éš¨äººç”Ÿéšæ®µèª¿æ•´ã€‚");

            const canvas = document.getElementById('hidden-chart-canvas');
            const ctx = canvas.getContext('2d');
            const age = parseInt(document.getElementById('main-user-age-value').value)||30;
            const rAge = parseInt(document.getElementById('retire-target-age').value)||65;
            const exist = clean(siVal)+clean(grpVal)+clean(commVal);
            const labels=[], dNeed=[], dExist=[];
            for(let i=age; i<=rAge; i++) { labels.push(i); dNeed.push(Math.max(0, Math.round(deathNeed * (1 - (i-age)/(rAge-age))))); dExist.push(exist); }
            
            new Chart(ctx, { type: 'bar', data: { labels: labels, datasets: [ { label: 'å®¶åº­è²¬ä»»', data: dNeed, backgroundColor: 'rgba(252, 211, 77, 0.5)', order: 2 }, { label: 'ç¾æœ‰ä¿éšœ', data: dExist, type:'line', borderColor: '#1e293b', borderWidth: 4, pointRadius:0, order: 1 } ] }, options: { animation: false, responsive: false, scales: { y: { beginAtZero: true } }, plugins: { legend: { labels: { font: { size: 24 } } } } } });
            const chartURL = canvas.toDataURL();

            const html = `<html><head><style>@page { size: A4; margin: 0; } body { font-family: 'Microsoft JhengHei', sans-serif; margin: 0; -webkit-print-color-adjust: exact !important; print-color-adjust: exact !important; } .page { width: 210mm; height: 296mm; position: relative; overflow: hidden; page-break-after: always; display: flex; flex-direction: column; background: white; } .cover { background: linear-gradient(135deg, #0f172a 0%, #1e3a8a 100%); flex: 1; display: flex; flex-direction: column; justify-content: center; padding-left: 30mm; color: white; } .title-line { width: 80px; height: 6px; background: #fcd34d; margin-bottom: 30px; } .header { height: 18mm; background: #0f172a; display: flex; align-items: center; justify-content: space-between; padding: 0 20mm; } .brand-l { color: #fcd34d; font-weight: 300; font-size: 14px; letter-spacing: 1px; } .header-right { text-align: right; color: white; } .content { padding: 15mm 10mm; flex: 1; display: flex; flex-direction: column; } .pg-title { font-size: 24px; font-weight: 900; color: #0f172a; border-bottom: 3px solid #e2e8f0; padding-bottom: 10px; margin-bottom: 25px; } .grid-4 { display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; margin-bottom: 25px; } .card { background: #f8fafc; border-top: 4px solid #94a3b8; padding: 15px 10px; text-align: center; border-radius: 4px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); } .card-val { font-size: 22px; font-weight: 900; color: #0f172a; } .card-lbl { font-size: 12px; color: #64748b; font-weight: bold; margin-bottom: 5px; } .tbl { width: 100%; border-collapse: collapse; font-size: 13px; margin-bottom: 20px; } .tbl th { text-align: left; padding: 10px; background: #f1f5f9; color: #475569; border-bottom: 2px solid #cbd5e1; } .tbl td { padding: 10px; border-bottom: 1px solid #f1f5f9; } .advice { background: #fff; border: 1px solid #e2e8f0; padding: 30px; border-radius: 8px; box-shadow: 0 4px 10px rgba(0,0,0,0.05); } .advice li { margin-bottom: 15px; } .footer { height: 12mm; border-top: 1px solid #e2e8f0; display: flex; align-items: center; justify-content: space-between; padding: 0 20mm; font-size: 10px; color: #94a3b8; }</style></head><body>
            <div class="page cover"><div class="title-line"></div><h1 style="font-size: 56px; font-weight: 900; line-height: 1.1; margin: 0;">å€å®‰ä¿éšª<br>éœ€æ±‚åˆ†æå ±å‘Š</h1><div style="font-size: 24px; font-weight: 300; margin-top: 10px; color: #fcd34d;">Polaris Financial Group</div><div style="border-left: 1px solid rgba(255,255,255,0.3); padding-left: 20px;"><p style="font-size: 14px; opacity: 0.7; letter-spacing: 2px;">PREPARED FOR</p><h2 style="font-size: 36px; font-weight: 700; margin: 5px 0 10px 0;">${name} <span style="font-size: 18px; font-weight: 300; font-family: 'Noto Sans TC';">å…ˆç”Ÿ/å°å§</span></h2><p style="font-size: 14px; opacity: 0.8;">å ±å‘Šæ—¥æœŸï¼š${date}</p></div></div>
            <div class="page"><div class="header"><span class="brand-l">Polaris Financial Group</span><div class="header-right"><div style="font-weight:700; font-size:18px; line-height:1.2;">é¢¨éšªåˆ†æ</div><div style="font-weight:300; font-size:9px; letter-spacing:2px; text-transform:uppercase;">RISK ANALYSIS</div></div></div><div class="content"><div class="pg-title">é¢¨éšªç¼ºå£ç¸½è¦½</div><div class="grid-4"><div class="card" style="border-color:#ef4444"><div class="card-lbl">é†«ç™‚ç¼ºå£</div><div class="card-val" style="color:#ef4444">${parseFloat(sickGap).toLocaleString()} è¬</div></div><div class="card" style="border-color:#f59e0b"><div class="card-lbl">å¤±èƒ½æœˆç¼ºå£</div><div class="card-val" style="color:#f59e0b">${disGap}</div></div><div class="card" style="border-color:#0f172a"><div class="card-lbl">èº«æ•…ç¼ºå£</div><div class="card-val" style="color:#0f172a">${deathGap}</div></div><div class="card" style="border-color:#10b981; background:#f0fdf4"><div class="card-lbl" style="color:#047857">é€€ä¼‘å¹´å„²è“„</div><div class="card-val" style="color:#047857">${retireGap}</div></div></div><table class="tbl"><tr><th width="40%">ä¿éšœä¾†æº</th><th width="30%">é ä¼°é‡‘é¡</th><th>å‚™è¨»</th></tr><tr><td>å®¶åº­ç¸½è²¬ä»»</td><td>${deathGap.replace(' è¬','')} è¬</td><td>æˆ¿è²¸ã€æ•™è‚²ã€ç”Ÿæ´»è²»ç¸½å’Œ</td></tr><tr><td>(-) ${SI_DATA[document.getElementById('si-type').value].label}</td><td style="color:#059669">- ${siVal} è¬</td><td></td></tr><tr><td>(-) å…¬å¸åœ˜ä¿/æ’«å¹</td><td style="color:#059669">- ${parseFloat(grpVal).toLocaleString()} è¬</td><td></td></tr><tr><td>(-) æ—¢æœ‰å•†æ¥­å£½éšª</td><td style="color:#059669">- ${parseFloat(commVal).toLocaleString()} è¬</td><td></td></tr><tr style="background:#fee2e2; font-weight:bold; color:#b91c1c"><td>éœ€å¢è£œç¼ºå£</td><td>${deathGap}</td><td></td></tr></table><div style="flex:1; border:1px solid #e2e8f0; border-radius:8px; padding:20px; display:flex; flex-direction:column;"><div style="text-align:center; font-weight:bold; color:#64748b; margin-bottom:10px;">å®¶åº­è²¬ä»» vs ç¾æœ‰ä¿éšœ</div><img src="${chartURL}" style="flex:1; object-fit:contain; width:100%;"></div></div><div class="footer"><span>æœ¬å ±å‘Šåƒ…ä¾›åƒè€ƒï¼Œå¯¦éš›ç†è³ é‡‘é¡ä»¥ä¿å–®æ¢æ¬¾ç‚ºæº–</span><span>Page 1</span></div></div>
            <div class="page"><div class="header"><span class="brand-l">Polaris Financial Group</span><div class="header-right"><div style="font-weight:700; font-size:18px; line-height:1.2;">è²¡å‹™å»ºè­°</div><div style="font-weight:300; font-size:9px; letter-spacing:2px; text-transform:uppercase;">FINANCIAL ADVICE</div></div></div><div class="content"><div class="pg-title">è²¡å‹™æ”¶æ”¯èˆ‡å»ºè­°</div><div style="display:flex; gap:20px; margin-bottom:30px;"><div style="flex:1; background:#f8fafc; border:1px solid #e2e8f0; border-radius:12px; padding:25px; text-align:center;"><div style="color:#64748b; font-weight:bold; font-size:14px;">å¹´åº¦æ·¨ç¾é‡‘æµ</div><div style="font-size:36px; font-weight:900; margin:10px 0; color:${net>=0?'#059669':'#dc2626'}">${netFmt} è¬</div><div style="font-size:12px; opacity:0.6;">( å¹´åº¦æ”¶å…¥ - å¹´åº¦æ”¯å‡º )</div></div><div style="flex:1; border:1px solid #e2e8f0; border-radius:12px; padding:20px; display:flex; flex-direction:column; justify-content:center;"><div style="display:flex; justify-content:space-between; margin-bottom:15px; border-bottom:1px solid #f1f5f9; padding-bottom:10px;"><span>å¹´åº¦ç¸½æ”¶å…¥</span><span style="font-weight:bold; color:#059669;">${parseFloat(totInc).toLocaleString()} è¬</span></div><div style="display:flex; justify-content:space-between;"><span>å¹´åº¦ç¸½æ”¯å‡º</span><span style="font-weight:bold; color:#dc2626;">${parseFloat(totExp).toLocaleString()} è¬</span></div></div></div><div class="advice" style="flex:1; display:flex; flex-direction:column;"><h3 style="font-size:20px; font-weight:900; color:#0f172a; margin-bottom:20px; border-left:5px solid #fcd34d; padding-left:15px;">å°ˆå®¶è¦åŠƒå»ºè­°</h3><ul style="margin:0; padding-left:20px; list-style:disc; font-size:16px; line-height:2.4; color:#334155; flex:1;">${advice.map(i=>`<li>${i}</li>`).join('')}</ul></div></div><div class="footer"><span>æœ¬å ±å‘Šåƒ…ä¾›åƒè€ƒï¼Œå¯¦éš›ç†è³ é‡‘é¡ä»¥ä¿å–®æ¢æ¬¾ç‚ºæº–</span><span>Page 2</span></div></div></body></html>`;
            
            const win = window.open('','_blank'); win.document.write(html); win.document.close(); win.onload = () => { overlay.style.display='none'; win.print(); };
        } catch(e) { alert('å ±å‘Šç”¢å‡ºå¤±æ•—'); overlay.style.display='none'; }
    }
    </script>
</body>
</html>
