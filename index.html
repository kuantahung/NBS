<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å…¨æ–¹ä½è²¡å¯Œä¿éšœç³»çµ± Pro (2026 å•†æ¥­æ——è‰¦ä¿®æ­£ç‰ˆ)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        /* --- ç³»çµ±ä»‹é¢æ¨£å¼ (Web UI) --- */
        body { font-family: 'Microsoft JhengHei', sans-serif; background-color: #f1f5f9; overflow-x: hidden; -webkit-tap-highlight-color: transparent; }
        .gradient-bg { background: linear-gradient(135deg, #0f172a 0%, #334155 100%); }
        .glass-card { background: rgba(255, 255, 255, 0.98); backdrop-filter: blur(10px); border: 1px solid rgba(255,255,255,0.2); }
        input[type="number"]::-webkit-inner-spin-button { -webkit-appearance: none; }
        .hidden { display: none !important; }
        .animate-fade-in { animation: fadeIn 0.3s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

        /* ä»‹é¢è¡¨æ ¼èˆ‡è¼¸å…¥æ¡† */
        .financial-table th { background-color: #f8fafc; color: #475569; padding: 16px; font-size: 1rem; border-bottom: 2px solid #e2e8f0; font-weight: 700; white-space: nowrap; }
        .financial-table td { padding: 16px; border-bottom: 1px solid #f1f5f9; vertical-align: middle; }
        .form-input { width: 100%; border: 1px solid #cbd5e1; border-radius: 8px; padding: 12px; font-size: 1rem; transition: all 0.2s; }
        .form-input:focus { border-color: #3b82f6; box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1); outline: none; }
        
        /* ç¤¾ä¿é¸å–®å°ˆç”¨æ¨£å¼ */
        .si-select { background-color: #f8fafc; border: 1px solid #cbd5e1; border-radius: 6px; padding: 8px 12px; font-size: 0.95rem; font-weight: bold; color: #475569; width: 100%; margin-bottom: 8px; cursor: pointer; transition: all 0.2s; }
        .si-select:hover { border-color: #3b82f6; }
        
        /* ç´šè·è¡¨é€£çµæ¨£å¼ */
        .salary-table-link { font-size: 0.75rem; color: #3b82f6; text-decoration: none; display: inline-flex; align-items: center; margin-top: 4px; transition: color 0.2s; }
        .salary-table-link:hover { color: #1d4ed8; text-decoration: underline; }

        /* æ‰‹æ©Ÿç‰ˆé©é… */
        @media (max-width: 768px) {
            .mobile-card-table thead { display: none; }
            .mobile-card-table tbody tr { display: block; background: white; margin-bottom: 15px; border-radius: 12px; border: 1px solid #e2e8f0; padding: 20px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
            .mobile-card-table td { display: block; width: 100%; padding: 8px 0; border: none; }
            .mobile-card-table td::before { content: attr(data-label); float: left; font-weight: bold; color: #64748b; margin-right: 10px; font-size: 1rem; margin-top: 10px;}
            .mobile-card-table input, .mobile-card-table select { width: 100%; }
            .mobile-card-table .action-col { text-align: right; margin-top: 15px; border-top: 1px dashed #e2e8f0; padding-top: 15px; }
        }

        /* Loading & Modal */
        #loading-overlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.85); z-index: 100000; color: white; justify-content: center; align-items: center; flex-direction: column; backdrop-filter: blur(5px); }
        .spinner { border: 4px solid rgba(255,255,255,0.3); border-radius: 50%; border-top: 4px solid #d4af37; width: 50px; height: 50px; animation: spin 1s linear infinite; margin-bottom: 20px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        #settings-modal { transition: opacity 0.3s ease; }
        #settings-modal.hidden { opacity: 0; pointer-events: none; }
        #settings-modal:not(.hidden) { opacity: 1; pointer-events: auto; }
        .highlight-update { animation: highlight 1s ease; }
        @keyframes highlight { 0% { background-color: #fef3c7; } 100% { background-color: #ffffff; } }
        .need-card { height: 280px; }
        @media (min-width: 768px) { .need-card { height: 450px; } } 
    </style>
</head>
<body class="bg-slate-100 min-h-screen text-slate-800 font-sans" onload="initSystem()">

    <div id="loading-overlay">
        <div class="spinner"></div>
        <div class="text-2xl font-bold tracking-widest">å ±å‘Šç”Ÿæˆä¸­</div>
        <p class="text-sm text-gray-400 mt-2">æ­£åœ¨é€²è¡Œå°ˆæ¥­æ’ç‰ˆèˆ‡æ•¸æ“šé‹ç®—...</p>
    </div>

    <canvas id="hidden-chart-canvas" width="2400" height="1200" style="position:fixed; left:-9999px;"></canvas>

    <div id="settings-modal" class="fixed inset-0 z-50 flex items-center justify-center bg-black/60 hidden backdrop-blur-sm">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-md p-6 m-4 animate-fade-in">
            <div class="flex justify-between items-center mb-6 border-b pb-4">
                <h3 class="text-xl font-bold text-slate-800"><i class="fas fa-cog mr-2"></i> åƒæ•¸è¨­å®š</h3>
                <button onclick="toggleSettings()" class="text-slate-400 hover:text-slate-600"><i class="fas fa-times text-xl"></i></button>
            </div>
            <div class="space-y-4">
                <h4 class="font-bold text-sm text-slate-500 uppercase">æ•™è‚²è²»ç”¨é è¨­å€¼ (è¬/å¹´)</h4>
                <div class="grid grid-cols-2 gap-4">
                    <div><label class="text-xs font-bold block mb-1">å…¬ç«‹ - K12</label><input type="number" id="cfg-pub-k12" class="form-input text-sm"></div>
                    <div><label class="text-xs font-bold block mb-1">ç§ç«‹ - K12</label><input type="number" id="cfg-pri-k12" class="form-input text-sm"></div>
                    <div><label class="text-xs font-bold block mb-1">å…¬ç«‹ - å¤§å­¸</label><input type="number" id="cfg-pub-uni" class="form-input text-sm"></div>
                    <div><label class="text-xs font-bold block mb-1">ç§ç«‹ - å¤§å­¸</label><input type="number" id="cfg-pri-uni" class="form-input text-sm"></div>
                    <div><label class="text-xs font-bold block mb-1">å…¬ç«‹ - ç¢©å£«</label><input type="number" id="cfg-pub-mas" class="form-input text-sm"></div>
                    <div><label class="text-xs font-bold block mb-1">ç§ç«‹ - ç¢©å£«</label><input type="number" id="cfg-pri-mas" class="form-input text-sm"></div>
                </div>
            </div>
            <div class="mt-8 flex justify-end gap-3">
                <button onclick="resetDefaultConfig()" class="px-4 py-2 text-sm text-slate-500 hover:bg-slate-100 rounded-lg">æ¢å¾©é è¨­</button>
                <button onclick="saveConfig()" class="px-6 py-2 bg-slate-800 text-white rounded-lg font-bold hover:bg-slate-900">å„²å­˜</button>
            </div>
        </div>
    </div>

    <div id="app-container">
        <div id="page1" class="container mx-auto py-6 px-4 md:py-10">
            <div class="max-w-6xl mx-auto glass-card shadow-2xl rounded-3xl overflow-hidden border border-white">
                <div class="gradient-bg p-6 md:p-8 text-white flex justify-between items-center">
                    <div><h1 class="text-2xl md:text-3xl font-black">å…¨æ–¹ä½è²¡å¯Œä¿éšœç³»çµ±</h1><p class="mt-1 text-slate-300 text-xs md:text-sm">Professional Wealth Management</p></div>
                    <div class="flex items-center gap-4">
                        <button onclick="clearAllData()" class="text-white/80 hover:text-red-300 transition text-sm flex items-center gap-1" title="æ¸…ç©ºæ‰€æœ‰æ¬„ä½"><i class="fas fa-trash-alt"></i> æ¸…é™¤</button>
                        <button onclick="toggleSettings()" class="text-white/80 hover:text-white transition"><i class="fas fa-cog text-xl"></i></button>
                        <div class="text-right opacity-80 text-sm font-mono border-l pl-4 border-white/20">Step 1/3</div>
                    </div>
                </div>
                
                <div class="p-6 md:p-8">
                    <section class="mb-10">
                        <div class="flex justify-between items-end mb-6">
                            <h2 class="text-xl font-bold border-l-4 border-slate-700 pl-3 text-slate-800">å®¢æˆ¶åŸºæœ¬è³‡æ–™</h2>
                            <button onclick="addFamilyMember()" class="text-sm bg-slate-100 text-slate-600 px-4 py-2 rounded-full hover:bg-slate-200 font-bold transition shadow-sm">+ æ–°å¢æˆå“¡</button>
                        </div>
                        <div id="family-container" class="space-y-4">
                            <div id="main-user-row" class="grid grid-cols-1 md:grid-cols-12 gap-4 items-end bg-slate-50 p-5 rounded-2xl border border-slate-200 shadow-sm" data-relation="æœ¬äºº">
                                <div class="md:col-span-2"><label class="text-xs font-bold text-slate-500 uppercase tracking-wide mb-1 block">é—œä¿‚</label><input type="text" value="æœ¬äºº" readonly class="w-full bg-white rounded-lg p-3 text-center font-bold text-slate-700 border border-slate-200"></div>
                                <div class="md:col-span-3"><label class="text-xs font-bold text-slate-500 uppercase tracking-wide mb-1 block">å§“å</label><input type="text" id="main-name" placeholder="è«‹è¼¸å…¥å§“å" class="form-input name-input persist-input" onchange="saveData()"></div>
                                <div class="md:col-span-4"><label class="text-xs font-bold text-slate-500 uppercase tracking-wide mb-1 block">å‡ºç”Ÿå¹´æœˆæ—¥</label><input type="date" id="main-dob" onchange="updateAge(this); saveData()" class="form-input dob-input persist-input"></div>
                                <div class="md:col-span-3"><label class="text-xs font-bold text-slate-500 uppercase tracking-wide mb-1 block">ä¿éšªå¹´é½¡</label><div id="main-user-age-display" class="bg-white p-3 rounded-lg text-center font-bold text-slate-800 text-lg border border-slate-200 age-display">-- æ­²</div><input type="hidden" id="main-user-age-value" value="0"></div>
                            </div>
                        </div>
                    </section>

                    <section class="mb-10">
                        <h2 class="text-xl font-bold border-l-4 border-slate-700 pl-3 mb-6 text-slate-800">æ ¸å¿ƒæ“”æ†‚èˆ‡ç›®æ¨™ (è«‹å‹¾é¸)</h2>
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                            <label class="relative need-card rounded-3xl overflow-hidden shadow-lg cursor-pointer group hover:shadow-2xl transition-all duration-300">
                                <input type="checkbox" id="check-sick" class="hidden peer persist-input" onchange="saveData()">
                                <div class="absolute inset-0 bg-cover bg-center transition-transform duration-700 group-hover:scale-110" style="background-image: url('https://images.unsplash.com/photo-1538108149393-fbbd81895907?q=80&w=600');"></div>
                                <div class="absolute inset-0 bg-black/40 peer-checked:bg-blue-900/80 transition-all"></div>
                                <div class="absolute top-6 right-6 text-white opacity-0 peer-checked:opacity-100 transition-all scale-0 peer-checked:scale-100"><i class="fas fa-check-circle text-4xl"></i></div>
                                <div class="relative h-full flex flex-col justify-end p-8 text-white"><h3 class="text-6xl font-black mb-2 tracking-tighter">ç—…</h3><p class="text-xl font-bold opacity-90">é«˜ç«¯é†«ç™‚å“è³ª</p></div>
                                <div class="absolute inset-0 border-4 border-transparent peer-checked:border-blue-400 rounded-3xl pointer-events-none"></div>
                            </label>
                            <label class="relative need-card rounded-3xl overflow-hidden shadow-lg cursor-pointer group hover:shadow-2xl transition-all duration-300">
                                <input type="checkbox" id="check-disability" class="hidden peer persist-input" onchange="saveData()">
                                <div class="absolute inset-0 bg-cover bg-center transition-transform duration-700 group-hover:scale-110" style="background-image: url('https://images.unsplash.com/photo-1576765608535-5f04d1e3f289?q=80&w=600');"></div>
                                <div class="absolute inset-0 bg-black/40 peer-checked:bg-amber-900/80 transition-all"></div>
                                <div class="absolute top-6 right-6 text-white opacity-0 peer-checked:opacity-100 transition-all scale-0 peer-checked:scale-100"><i class="fas fa-check-circle text-4xl"></i></div>
                                <div class="relative h-full flex flex-col justify-end p-8 text-white"><h3 class="text-6xl font-black mb-2 tracking-tighter">æ®˜</h3><p class="text-xl font-bold opacity-90">å¤±èƒ½é•·ç…§é˜²è­·</p></div>
                                <div class="absolute inset-0 border-4 border-transparent peer-checked:border-amber-400 rounded-3xl pointer-events-none"></div>
                            </label>
                            <label class="relative need-card rounded-3xl overflow-hidden shadow-lg cursor-pointer group hover:shadow-2xl transition-all duration-300">
                                <input type="checkbox" id="check-death" class="hidden peer persist-input" onchange="saveData()">
                                <div class="absolute inset-0 bg-cover bg-center transition-transform duration-700 group-hover:scale-110" style="background-image: url('https://images.unsplash.com/photo-1475483768296-6163e08872a1?q=80&w=600');"></div>
                                <div class="absolute inset-0 bg-black/40 peer-checked:bg-rose-900/80 transition-all"></div>
                                <div class="absolute top-6 right-6 text-white opacity-0 peer-checked:opacity-100 transition-all scale-0 peer-checked:scale-100"><i class="fas fa-check-circle text-4xl"></i></div>
                                <div class="relative h-full flex flex-col justify-end p-8 text-white"><h3 class="text-6xl font-black mb-2 tracking-tighter">æ­»</h3><p class="text-xl font-bold opacity-90">å®¶åº­è²¬ä»»å‚³æ‰¿</p></div>
                                <div class="absolute inset-0 border-4 border-transparent peer-checked:border-rose-400 rounded-3xl pointer-events-none"></div>
                            </label>
                            <label class="relative need-card rounded-3xl overflow-hidden shadow-lg cursor-pointer group hover:shadow-2xl transition-all duration-300">
                                <input type="checkbox" id="check-retire" class="hidden peer persist-input" onchange="saveData()">
                                <div class="absolute inset-0 bg-cover bg-center transition-transform duration-700 group-hover:scale-110" style="background-image: url('https://images.unsplash.com/photo-1507525428034-b723cf961d3e?q=80&w=600');"></div>
                                <div class="absolute inset-0 bg-black/40 peer-checked:bg-emerald-900/80 transition-all"></div>
                                <div class="absolute top-6 right-6 text-white opacity-0 peer-checked:opacity-100 transition-all scale-0 peer-checked:scale-100"><i class="fas fa-check-circle text-4xl"></i></div>
                                <div class="relative h-full flex flex-col justify-end p-8 text-white"><h3 class="text-6xl font-black mb-2 tracking-tighter">è€</h3><p class="text-xl font-bold opacity-90">é€€ä¼‘è²¡å¯Œè‡ªç”±</p></div>
                                <div class="absolute inset-0 border-4 border-transparent peer-checked:border-emerald-400 rounded-3xl pointer-events-none"></div>
                            </label>
                        </div>
                    </section>

                    <button onclick="togglePages('page2')" class="w-full bg-slate-800 text-white py-4 rounded-xl font-bold text-lg hover:bg-slate-900 shadow-xl transition transform hover:-translate-y-1">ä¸‹ä¸€æ­¥ï¼šéœ€æ±‚é‡åŒ–åˆ†æ</button>
                </div>
            </div>
        </div>

        <div id="page2" class="container mx-auto py-6 px-4 md:py-10 hidden">
            <div class="max-w-6xl mx-auto space-y-6">
                <div class="flex justify-between items-center mb-4">
                    <button onclick="togglePages('page1')" class="text-slate-500 hover:text-slate-800 font-bold flex items-center bg-white px-4 py-2 rounded-lg shadow-sm border border-slate-200 transition"><i class="fas fa-arrow-left mr-2"></i> è¿”å›ä¿®æ”¹</button>
                    <div class="text-sm font-bold text-slate-400 font-mono">Step 2/3</div>
                </div>

                <div id="section-sick" class="hidden bg-white p-6 rounded-2xl shadow-lg border-l-8 border-blue-500 calc-section">
                    <h2 class="text-xl md:text-2xl font-black text-slate-800 mb-6 flex items-center"><span class="bg-blue-100 p-2 rounded-lg mr-3 text-blue-600 text-xl">ğŸ¥</span> ç–¾ç—…é†«ç™‚éœ€æ±‚</h2>
                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                        <div class="lg:col-span-2">
                            <table class="w-full text-left mobile-card-table">
                                <thead class="bg-slate-50 text-slate-600 text-sm uppercase"><tr><th class="p-5 rounded-l-lg">é …ç›®</th><th class="p-5">å“è³ªéœ€æ±‚</th><th class="p-5">å¯å®‰å¿ƒé¡åº¦ (è¬)</th><th class="p-5">å·²å‚™è¦åŠƒ (è¬)</th><th class="p-5 rounded-r-lg text-right">ç¼ºå£</th></tr></thead>
                                <tbody class="divide-y divide-slate-100">
                                    <tr class="calc-row-sick">
                                        <td class="font-bold p-5" data-label="é …ç›®">ä½é™¢é›œè²»/å·®é¡</td>
                                        <td class="p-5" data-label="å“è³ª"><select class="form-input text-sm persist-input id-sick-room-type" onchange="saveData()"><option>å–®äººæˆ¿</option><option>é›™äººæˆ¿</option><option>å¥ä¿æˆ¿</option></select></td>
                                        <td class="p-5" data-label="å®‰å¿ƒé¡åº¦"><input type="number" class="sick-target form-input persist-input" onkeyup="calculateAll();saveData()" placeholder="0"></td>
                                        <td class="p-5" data-label="å·²å‚™"><input type="number" class="sick-current form-input persist-input" onkeyup="calculateAll();saveData()" placeholder="0"></td>
                                        <td class="text-right font-bold text-red-500 sick-gap action-col p-5" data-label="ç¼ºå£">0 è¬</td>
                                    </tr>
                                    <tr class="calc-row-sick">
                                        <td class="font-bold p-5" data-label="é …ç›®">ç™Œç—‡/é‡å¤§å‚·ç—…</td>
                                        <td class="p-5 text-sm text-slate-400" data-label="å“è³ª">ä¸€ç­†çµ¦ä»˜å‹</td>
                                        <td class="p-5" data-label="å®‰å¿ƒé¡åº¦"><input type="number" class="sick-target form-input persist-input" onkeyup="calculateAll();saveData()" placeholder="0"></td>
                                        <td class="p-5" data-label="å·²å‚™"><input type="number" class="sick-current form-input persist-input" onkeyup="calculateAll();saveData()" placeholder="0"></td>
                                        <td class="text-right font-bold text-red-500 sick-gap action-col p-5" data-label="ç¼ºå£">0 è¬</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                        <div class="lg:col-span-1 bg-slate-50 p-6 rounded-xl border border-slate-200">
                            <h4 class="font-bold text-slate-800 mb-4 text-lg flex items-center"><i class="fas fa-lightbulb text-yellow-500 mr-2"></i> é¡§å•æŒ‡å¼•</h4>
                            <div class="space-y-4 text-base text-slate-700 leading-relaxed"><p><strong>ä½é™¢å“è³ªï¼š</strong>å‡ç­‰å–®äººæˆ¿å¯é™ä½é™¢å…§äº¤å‰æ„ŸæŸ“é¢¨éšªï¼Œæå‡ä¼‘é¤Šå“è³ªã€‚</p><p><strong>ç™Œç—‡è¶¨å‹¢ï¼š</strong>æ¨™é¶è—¥ç‰©ã€å…ç–«ç™‚æ³•å¤šéœ€è‡ªè²»ï¼Œå»ºè­°è¦åŠƒä¸€æ¬¡é‡‘ä»¥æ‡‰å°çŸ­æœŸå¤§é¡æ”¯å‡ºã€‚</p></div>
                        </div>
                    </div>
                </div>

                <div id="section-disability" class="hidden bg-white p-6 rounded-2xl shadow-lg border-l-8 border-amber-500 calc-section">
                    <h2 class="text-xl md:text-2xl font-black text-slate-800 mb-6 flex items-center"><span class="bg-amber-100 p-2 rounded-lg mr-3 text-amber-600 text-xl">â™¿</span> å¤±èƒ½ç…§è­·éœ€æ±‚</h2>
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                        <div class="space-y-6">
                            <div><label class="text-base font-bold text-slate-600 mb-2 block">é ä¼°æ¯æœˆç…§è­·è²» (è¬)</label><input type="number" id="dis-target" class="form-input text-lg persist-input" placeholder="ä¾‹å¦‚: 5" onkeyup="calculateAll();saveData()"></div>
                            <div><label class="text-base font-bold text-slate-600 mb-2 block">å·²å‚™æœˆæ‰¶åŠ©é‡‘ (è¬)</label><input type="number" id="dis-current" class="form-input text-lg persist-input" placeholder="ä¾‹å¦‚: 1" onkeyup="calculateAll();saveData()"></div>
                            <div class="bg-amber-50 p-6 rounded-xl text-center border border-amber-100 mt-4"><div class="text-sm text-amber-800 uppercase tracking-wider mb-2">æ¯æœˆç¼ºå£</div><div class="text-4xl font-black text-amber-600" id="dis-gap">0 <span class="text-xl">è¬/æœˆ</span></div></div>
                        </div>
                        <div class="bg-slate-50 p-6 rounded-xl border border-slate-200">
                            <h4 class="font-bold text-slate-800 mb-4 text-lg"><i class="fas fa-chart-line text-yellow-500 mr-2"></i> å¸‚å ´è¡Œæƒ…åƒè€ƒ</h4>
                            <ul class="space-y-3 text-base text-slate-700 list-disc list-inside leading-relaxed"><li><strong>å¤–ç±çœ‹è­·ï¼š</strong> ç´„ 2.5 ~ 3 è¬/æœˆ</li><li><strong>å°ˆæ¥­æ©Ÿæ§‹ï¼š</strong> ç´„ 4 ~ 6 è¬/æœˆ</li><li><strong>æœ¬åœ‹çœ‹è­·ï¼š</strong> ç´„ 7 ~ 8 è¬/æœˆ</li><li class="text-slate-500 text-sm pt-2 list-none ml-0">* å°šæœªåŒ…å«å°¿å¸ƒã€ç‡Ÿé¤Šå“ç­‰è€—æè²» (ç´„ 1 è¬/æœˆ)</li></ul>
                        </div>
                    </div>
                </div>

                <div id="section-death" class="hidden grid grid-cols-1 lg:grid-cols-3 gap-6">
                    <div class="lg:col-span-2 space-y-6">
                        <div class="bg-white p-6 rounded-2xl shadow-lg border-l-8 border-rose-500">
                            <h2 class="text-xl md:text-2xl font-black text-slate-800 mb-6 flex items-center"><span class="bg-rose-100 p-2 rounded-lg mr-3 text-rose-600 text-xl">ğŸ•Šï¸</span> èº«æ•…è²¬ä»»ç²¾ç®—</h2>
                            <div class="space-y-6 divide-y divide-slate-100">
                                <div class="pb-4">
                                    <div class="flex justify-between items-center mb-3"><h3 class="font-bold text-slate-700 text-lg">çˆ¶æ¯å­é¤Šé‡‘</h3><button onclick="addParentRow()" class="text-xs bg-blue-50 text-blue-600 font-bold px-3 py-1 rounded hover:bg-blue-100">+ å¢åŠ </button></div>
                                    <div id="parents-container" class="space-y-2"></div>
                                    <div class="text-right text-rose-600 font-bold mt-2 text-base">å°è¨ˆï¼š<span id="total-parents">0 è¬</span></div>
                                </div>
                                <div class="py-4">
                                    <h3 class="font-bold text-slate-700 mb-3 text-lg">é…å¶å­å¥³ç”Ÿæ´»èˆ‡æ•™è‚²</h3>
                                    <div class="grid grid-cols-2 gap-4 mb-4"><div><label class="text-sm text-slate-500 font-bold block mb-1">æ¯æœˆç”Ÿæ´»è²» (è¬)</label><input type="number" id="living-monthly" class="form-input persist-input" placeholder="0" onkeyup="calculateAll();saveData()"></div><div><label class="text-sm text-slate-500 font-bold block mb-1">ç…§é¡§å¹´æ•¸ (å¹´)</label><input type="number" id="living-years" class="form-input persist-input" placeholder="ä¾‹å¦‚: 20" onkeyup="calculateAll();saveData()"></div></div>
                                    <div class="flex justify-between items-center mb-2"><span class="text-base font-bold text-slate-600">å­å¥³æ•™è‚²åŸºé‡‘ (ä¾ç…§è¨­å®šåƒæ•¸)</span><button onclick="addChildEduRow()" class="text-xs bg-indigo-50 text-indigo-600 px-3 py-1 rounded font-bold hover:bg-indigo-100">+ å¢åŠ å­å¥³</button></div>
                                    <div id="edu-container" class="space-y-3"></div>
                                    <div class="text-right text-rose-600 font-bold mt-2 text-base">å°è¨ˆï¼š<span id="total-living-edu">0 è¬</span></div>
                                </div>
                                <div class="pt-4">
                                    <h3 class="font-bold text-slate-700 mb-3 text-lg">å±…ä½èˆ‡æœ€å¾Œè²»ç”¨</h3>
                                    <div class="grid grid-cols-2 gap-4"><div><label class="text-sm text-slate-500 font-bold block mb-1">æˆ¿è²¸/ç§Ÿé‡‘æœˆæ”¯ (è¬)</label><input type="number" id="house-monthly" class="form-input persist-input" placeholder="0" onkeyup="calculateAll();saveData()"></div><div><label class="text-sm text-slate-500 font-bold block mb-1">å‰©é¤˜å¹´æ•¸ (å¹´)</label><input type="number" id="house-years" class="form-input persist-input" placeholder="0" onkeyup="calculateAll();saveData()"></div></div>
                                    <div class="text-right text-rose-600 font-bold mt-2 text-base">å°è¨ˆï¼š<span id="total-house">0 è¬</span></div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="lg:col-span-1">
                        <div class="lg:sticky lg:top-6 bg-slate-800 text-white rounded-2xl p-6 shadow-2xl border border-slate-700">
                            <h4 class="text-xs font-bold opacity-60 mb-2 uppercase tracking-widest text-rose-200">èº«æ•…è²¬ä»»ç¸½ç¼ºå£</h4>
                            <div class="text-4xl md:text-5xl font-black mb-6"><span id="grand-total-gap" data-need="0">0</span><span class="text-xl ml-2">è¬</span></div>
                            <div class="space-y-4">
                                <div class="bg-slate-700/50 p-4 rounded-xl border border-slate-600">
                                    <label class="text-xs opacity-70 block mb-1">æ‰£é™¤ï¼šç¾æœ‰å£½éšª (è¬)</label>
                                    <input type="number" id="existing-insurance-p2" class="w-full bg-transparent border-b border-slate-500 text-white focus:outline-none focus:border-white font-bold text-lg placeholder-slate-500 persist-input" placeholder="0" oninput="syncInsurance(this.value, 'comm-insurance-p3'); saveData()">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="section-retire" class="hidden bg-white p-6 rounded-2xl shadow-lg border-l-8 border-emerald-500 calc-section">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-xl md:text-2xl font-black text-slate-800 flex items-center"><span class="bg-emerald-100 p-2 rounded-lg mr-3 text-emerald-600 text-xl">ğŸŒ…</span> é€€ä¼‘ç”Ÿæ´»è¦åŠƒ</h2>
                        <a href="https://kuantahung.github.io/Retire-in-Real/" target="_blank" class="text-xs bg-emerald-600 text-white px-3 py-1.5 rounded-full hover:bg-emerald-700 shadow flex items-center gap-1"><i class="fas fa-calculator"></i> ç²¾ç®—ç‰ˆ</a>
                    </div>
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                        <div class="space-y-4">
                            <div class="grid grid-cols-2 gap-4"><div><label class="block text-sm font-bold text-slate-500 mb-1">ç›®å‰å¹´é½¡</label><input type="number" id="retire-current-age" class="form-input bg-slate-100 text-slate-500 font-bold" readonly placeholder="--"></div><div><label class="block text-sm font-bold text-emerald-700 mb-1">é€€ä¼‘å¹´é½¡</label><input type="number" id="retire-target-age" class="form-input border-emerald-300 text-emerald-900 font-bold persist-input" placeholder="ä¾‹å¦‚: 65" onkeyup="calculateAll();saveData()"></div></div>
                            <div class="grid grid-cols-2 gap-4"><div><label class="block text-sm font-bold text-slate-600 mb-1">é ä¼°å£½å‘½</label><input type="number" id="retire-end-age" class="form-input persist-input" placeholder="ä¾‹å¦‚: 85" onkeyup="calculateAll();saveData()"></div><div><label class="block text-sm font-bold text-slate-600 mb-1">é€€ä¼‘æœˆèŠ±è²»(è¬)</label><input type="number" id="retire-monthly" class="form-input persist-input" placeholder="ä¾‹å¦‚: 3" onkeyup="calculateAll();saveData()"></div></div>
                            <div class="bg-slate-50 p-6 rounded-xl text-base space-y-3 border border-slate-200"><div class="flex justify-between"><span class="text-slate-600">æº–å‚™æœŸ (è·é›¢é€€ä¼‘)</span><span class="font-bold text-emerald-600"><span id="retire-years-to-save">0</span> å¹´</span></div><div class="flex justify-between"><span class="text-slate-600">æé ˜æœŸ (é€€ä¼‘ç”Ÿæ´»)</span><span class="font-bold text-emerald-600"><span id="retire-years-to-live">0</span> å¹´</span></div></div>
                        </div>
                        <div class="flex flex-col justify-center space-y-4">
                            <div class="bg-emerald-50 rounded-2xl p-6 text-center border border-emerald-100"><div class="text-sm font-bold text-emerald-800 mb-1 uppercase">é€€ä¼‘é‡‘ç¸½éœ€æ±‚ (ä¸å«é€šè†¨)</div><div class="text-4xl font-black text-emerald-700"><span id="retire-total-needed">0</span> è¬</div></div>
                            <div class="bg-gradient-to-r from-emerald-600 to-teal-700 rounded-2xl p-6 text-center text-white shadow-xl"><div class="text-base font-bold opacity-80 mb-2">ç¾åœ¨é–‹å§‹ï¼Œæ¯å¹´éœ€å­˜</div><div class="text-5xl font-black mb-2"><span id="retire-annual-save">0</span> <span class="text-lg">è¬/å¹´</span></div><div class="text-xs opacity-60 border-t border-white/20 pt-2 mt-2">è¨»ï¼šæ­¤ç‚ºæœªè¨ˆå…¥æŠ•è³‡å ±é…¬ç‡ä¹‹ä¿å®ˆä¼°ç®—</div></div>
                        </div>
                    </div>
                </div>

                <div class="flex justify-center mt-12 pb-16">
                    <button onclick="togglePages('page3')" class="bg-slate-800 text-white px-10 py-4 rounded-xl text-lg font-bold shadow-xl hover:bg-slate-900 transition transform hover:-translate-y-1 w-full md:w-auto">ä¸‹ä¸€æ­¥ï¼šæ”¶æ”¯èˆ‡ç¸½çµ</button>
                </div>
            </div>
        </div>

        <div id="page3" class="container mx-auto py-6 px-4 md:py-10 hidden">
            <div class="max-w-6xl mx-auto space-y-6">
                <div class="flex justify-between items-center mb-4">
                    <button onclick="togglePages('page2')" class="text-slate-500 hover:text-slate-800 font-bold flex items-center bg-white px-4 py-2 rounded-lg shadow-sm border border-slate-200 transition"><i class="fas fa-arrow-left mr-2"></i> è¿”å›ç¼ºå£</button>
                    <div class="text-sm font-bold text-slate-400 font-mono">Step 3/3</div>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <div class="bg-white p-5 md:p-6 rounded-2xl shadow-sm border border-slate-200">
                        <h2 class="text-lg font-bold text-emerald-600 mb-4 flex items-center"><i class="fas fa-wallet mr-2"></i> å¹´åº¦æ”¶å…¥æ¦‚æ³</h2>
                        <table class="w-full financial-table mb-2 mobile-card-table"><thead><tr><th>é …ç›®</th><th>é‡‘é¡ (è¬)</th><th>æ“ä½œ</th></tr></thead><tbody id="income-body"></tbody></table>
                        <button onclick="addFlowRow('income')" class="text-xs bg-emerald-50 text-emerald-600 px-4 py-2 rounded-full font-bold mt-2 w-full md:w-auto hover:bg-emerald-100">+ æ–°å¢æ”¶å…¥</button>
                    </div>
                    <div class="bg-white p-5 md:p-6 rounded-2xl shadow-sm border border-slate-200">
                        <h2 class="text-lg font-bold text-red-500 mb-4 flex items-center"><i class="fas fa-file-invoice-dollar mr-2"></i> å¹´åº¦æ”¯å‡ºæ¦‚æ³</h2>
                        <table class="w-full financial-table mb-2 mobile-card-table"><thead><tr><th>é …ç›®</th><th>é‡‘é¡ (è¬)</th><th>æ“ä½œ</th></tr></thead><tbody id="expense-body"></tbody></table>
                        <button onclick="addFlowRow('expense')" class="text-xs bg-red-50 text-red-600 px-4 py-2 rounded-full font-bold mt-2 w-full md:w-auto hover:bg-red-100">+ æ–°å¢æ”¯å‡º</button>
                    </div>
                    <div class="bg-slate-800 text-white p-6 rounded-2xl flex justify-between items-center shadow-lg lg:col-span-2">
                        <span class="text-lg opacity-90">å¹´åº¦æ·¨ç¾é‡‘æµ</span><span id="net-cashflow" class="text-3xl font-black">0 è¬</span>
                    </div>
                    <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-200 lg:col-span-2">
                        <h2 class="text-lg font-bold text-blue-600 mb-4 flex items-center"><i class="fas fa-shield-alt mr-2"></i> ç¤¾æœƒä¿éšªèˆ‡ä¿éšœè©¦ç®—</h2>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                            <div class="bg-slate-50 p-4 rounded-xl border border-slate-100">
                                <label class="text-xs font-bold text-slate-500 block mb-1">é¸æ“‡ä¿éšªèº«ä»½</label>
                                <select id="si-type" class="si-select" onchange="updateSocialInsurance()">
                                    <option value="labor" selected>å‹ä¿</option>
                                    <option value="gov">å…¬ä¿</option>
                                    <option value="farmer">è¾²ä¿</option>
                                    <option value="fisher">æ¼ä¿</option>
                                </select>
                                <label class="text-xs font-bold text-slate-500 block mb-2">æŠ•ä¿è–ªè³‡ / ä¿ä¿¸ (å…ƒ/æœˆ)</label>
                                <input type="number" id="labor-salary-p3" class="form-input font-bold persist-input" placeholder="ä¾‹å¦‚: 45800" oninput="calculateAll();saveData()">
                                <div class="text-right mt-1" id="si-link-container">
                                    <a id="si-table-link" href="https://www.bli.gov.tw/0005475.html" target="_blank" class="salary-table-link">
                                        <i class="fas fa-table mr-1"></i>æŸ¥çœ‹è–ªè³‡ç´šè·è¡¨
                                    </a>
                                </div>
                                <div class="text-xs font-bold text-blue-600 mt-2 flex justify-between"><span>èº«æ•…çµ¦ä»˜ï¼š<span id="labor-benefit-val-p3">0</span> è¬</span></div>
                                <div id="si-note" class="text-[10px] text-slate-400 mt-1">* ä¾å‹ä¿æ™®é€šå‚·ç—…èº«æ•…(35å€‹æœˆ)ä¼°ç®—</div>
                            </div>
                            <div class="bg-slate-50 p-4 rounded-xl border border-slate-100"><label class="text-xs font-bold text-slate-500 block mb-2">å…¬å¸åœ˜ä¿ / æ’«å¹ (è¬)</label><input type="number" id="group-insurance-p3" class="form-input persist-input" placeholder="0" oninput="calculateAll();saveData()"></div>
                            <div class="bg-slate-50 p-4 rounded-xl border border-slate-100"><label class="text-xs font-bold text-slate-500 block mb-2">å•†æ¥­å£½éšª (ç¾æœ‰ä¿å–®)</label><input type="number" id="comm-insurance-p3" class="form-input bg-white persist-input" placeholder="0" oninput="syncInsurance(this.value, 'existing-insurance-p2'); saveData()"></div>
                        </div>
                    </div>
                </div>

                <div class="flex justify-center mt-12 pb-16">
                    <button onclick="generateReport()" class="bg-slate-800 text-white px-12 py-5 rounded-full text-xl font-bold shadow-2xl hover:bg-slate-900 transition-all flex items-center"><i class="fas fa-print mr-3"></i> ç”¢å‡ºå°ˆæ¥­å ±å‘Š</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        const DEFAULT_CONFIG = { 'pub-k12': 10, 'pri-k12': 30, 'pub-uni': 25, 'pri-uni': 50, 'pub-mas': 30, 'pri-mas': 60 };
        let CONFIG = { ...DEFAULT_CONFIG };

        // Social Insurance Data with official table URLs
        const SI_DATA = {
            labor: { 
                label: 'å‹ä¿èº«æ•…çµ¦ä»˜', 
                note: '* ä¾å‹ä¿æ™®é€šå‚·ç—…èº«æ•…(35å€‹æœˆ)ä¼°ç®—', 
                tableUrl: 'https://www.bli.gov.tw/0005475.html' 
            },
            gov: { 
                label: 'å…¬ä¿æ­»äº¡çµ¦ä»˜', 
                note: '* ä¾æœªæ»¿20å¹´æŠ•ä¿å¹´è³‡(30å€‹æœˆ)ä¿å®ˆä¼°ç®—', 
                tableUrl: 'https://www.bot.com.tw/tw/policy-business/government-employees-insurance-service/downloads/cash-payment-form' 
            },
            farmer: { 
                label: 'è¾²ä¿å–ªè‘¬æ´¥è²¼', 
                note: '* å›ºå®šæŠ•ä¿é‡‘é¡20,400å…ƒ x 15å€‹æœˆ', 
                fixed: 20400,
                tableUrl: null 
            },
            fisher: { 
                label: 'æ¼ä¿èº«æ•…çµ¦ä»˜', 
                note: '* æ¯”ç…§å‹ä¿ç”²é¡æœƒå“¡æ¨™æº–(35å€‹æœˆ)ä¼°ç®—', 
                tableUrl: 'https://www.bli.gov.tw/0005475.html' 
            }
        };

        function initSystem() {
            loadConfig(); 
            loadData();   
            if(document.getElementById('income-body').children.length === 0) addFlowRow('income');
            if(document.getElementById('expense-body').children.length === 0) addFlowRow('expense');
            calculateAll();
        }

        function updateSocialInsurance() {
            const type = document.getElementById('si-type').value;
            const data = SI_DATA[type];
            const input = document.getElementById('labor-salary-p3');
            const note = document.getElementById('si-note');
            const tableLink = document.getElementById('si-table-link');

            note.innerText = data.note;

            // Handle Link Visibility & URL
            if (data.tableUrl) {
                tableLink.href = data.tableUrl;
                tableLink.classList.remove('hidden');
            } else {
                tableLink.classList.add('hidden');
            }

            // Handle Fixed Amount
            if (type === 'farmer') {
                input.value = 20400;
                input.setAttribute('readonly', true);
                input.classList.add('bg-gray-100');
            } else {
                input.removeAttribute('readonly');
                input.classList.remove('bg-gray-100');
                if (input.value == 20400) input.value = ''; 
            }
            calculateAll();
            saveData();
        }

        function calculateAll() {
            const fmt = n => parseFloat(n).toLocaleString('en-US'); const clean = str => parseFloat(String(str).replace(/,/g, '')) || 0;
            // ... (Rest of calculation logic same as before)
            document.querySelectorAll('.calc-row-sick').forEach(row => { const t = clean(row.querySelector('.sick-target').value); const c = clean(row.querySelector('.sick-current').value); row.querySelector('.sick-gap').innerText = fmt(Math.max(0, t - c)) + " è¬"; });
            const disT = clean(document.getElementById('dis-target').value); const disC = clean(document.getElementById('dis-current').value); document.getElementById('dis-gap').innerHTML = `${fmt(Math.max(0, disT - disC))} <span class="text-lg">è¬/æœˆ</span>`;
            const rCur = clean(document.getElementById('retire-current-age').value); const rTar = clean(document.getElementById('retire-target-age').value) || 65; const rEnd = clean(document.getElementById('retire-end-age').value) || 85; const rMon = clean(document.getElementById('retire-monthly').value);
            const yrSave = Math.max(0, rTar - rCur); const yrLive = Math.max(0, rEnd - rTar);
            document.getElementById('retire-years-to-save').innerText = yrSave; document.getElementById('retire-years-to-live').innerText = yrLive;
            const rTotal = rMon * 12 * yrLive; document.getElementById('retire-total-needed').innerText = fmt(Math.round(rTotal));
            const rAnnual = yrSave > 0 ? rTotal / yrSave : rTotal; document.getElementById('retire-annual-save').innerText = fmt(rAnnual.toFixed(1));
            let pTotal = 0; document.querySelectorAll('.parent-row').forEach(r => { const m = clean(r.querySelector('.p-money').value); const endAge = parseFloat(r.querySelector('.p-type').value); const curAge = clean(r.querySelector('.p-age').value); pTotal += m * 12 * Math.max(0, endAge - curAge); }); document.getElementById('total-parents').innerText = fmt(Math.round(pTotal));
            const houseTotal = clean(document.getElementById('house-monthly').value) * 12 * clean(document.getElementById('house-years').value); document.getElementById('total-house').innerText = fmt(Math.round(houseTotal));
            const tLiving = clean(document.getElementById('living-monthly').value) * 12 * clean(document.getElementById('living-years').value);
            let tEdu = 0; document.querySelectorAll('.child-edu-row').forEach(r => { const a = clean(r.querySelector('.c-age').value); const d = parseFloat(r.querySelector('.c-degree').value); const type = r.querySelector('.c-type:checked').value; const k12Cost = type === 'public' ? CONFIG['pub-k12'] : CONFIG['pri-k12']; const uniCost = type === 'public' ? CONFIG['pub-uni'] : CONFIG['pri-uni']; const masCost = type === 'public' ? CONFIG['pub-mas'] : CONFIG['pri-mas']; if(a < 18 && d >= 18) tEdu += (18 - a) * k12Cost; if(a < 22 && d >= 22) tEdu += (22 - Math.max(18, a)) * uniCost; if(a < 24 && d >= 24) tEdu += (24 - Math.max(22, a)) * masCost; }); document.getElementById('total-living-edu').innerText = fmt(Math.round(tLiving + tEdu));
            const deathNeed = pTotal + tLiving + tEdu + houseTotal; 
            
            // Social Insurance Calculation
            const siType = document.getElementById('si-type').value;
            const salary = clean(document.getElementById('labor-salary-p3').value);
            let siBenefit = 0;
            
            if (siType === 'labor' || siType === 'fisher') {
                siBenefit = Math.round(salary * 35); // 5 funeral + 30 survivor
            } else if (siType === 'gov') {
                siBenefit = Math.round(salary * 30); // Conservative estimate
            } else if (siType === 'farmer') {
                siBenefit = Math.round(20400 * 15); // Fixed
            }
            
            document.getElementById('labor-benefit-val-p3').innerText = fmt(Math.round(siBenefit/10000)); // Display in Wan

            const group = clean(document.getElementById('group-insurance-p3').value); const comm = clean(document.getElementById('comm-insurance-p3').value); const deathGap = Math.max(0, deathNeed - (Math.round(siBenefit/10000) + group + comm));
            document.getElementById('grand-total-gap').innerText = fmt(Math.round(deathGap)); document.getElementById('grand-total-gap').setAttribute('data-need', deathNeed);
            let inc = 0, exp = 0; document.querySelectorAll('.income-amount').forEach(i => inc += clean(i.value)); document.querySelectorAll('.expense-amount').forEach(i => exp += clean(i.value)); const net = inc - exp; const netEl = document.getElementById('net-cashflow'); netEl.innerText = fmt(net) + " è¬"; netEl.className = `text-3xl font-black ${net >= 0 ? 'text-emerald-400' : 'text-red-400'}`;
            updateExpenseRow('æˆ¿è²¸/æˆ¿ç§Ÿ', clean(document.getElementById('house-monthly').value) * 12); updateExpenseRow('å­è¦ªè²»', clean(document.querySelector('.p-money')?.value || 0) * 12);
        }

        // ... (Rest of the functions: toggleSettings, saveConfig, loadConfig, resetDefaultConfig, clearAllData, saveData, loadData, updateAge, addFamilyMember, syncInsurance, togglePages, syncPage2Visibility, addParentRow, addChildEduRow, addFlowRow, updateExpenseRow)
        // Ensure these functions from previous version are included here. For brevity in this response, I'm assuming you copy them.
        // I will include the critical ones to ensure it works out of the box.
        
        function toggleSettings() {
            const modal = document.getElementById('settings-modal');
            modal.classList.toggle('hidden');
            if(!modal.classList.contains('hidden')) for(let k in CONFIG) document.getElementById(`cfg-${k}`).value = CONFIG[k];
        }
        function saveConfig() {
            for(let k in CONFIG) {
                const val = parseFloat(document.getElementById(`cfg-${k}`).value);
                if(!isNaN(val)) CONFIG[k] = val;
            }
            localStorage.setItem('pwm_config', JSON.stringify(CONFIG));
            calculateAll(); toggleSettings();
        }
        function loadConfig() {
            const saved = localStorage.getItem('pwm_config');
            if(saved) CONFIG = { ...DEFAULT_CONFIG, ...JSON.parse(saved) };
        }
        function resetDefaultConfig() { if(confirm('æ¢å¾©é è¨­åƒæ•¸ï¼Ÿ')) { CONFIG = { ...DEFAULT_CONFIG }; for(let k in CONFIG) document.getElementById(`cfg-${k}`).value = CONFIG[k]; } }
        function clearAllData() { if(confirm('ç¢ºå®šè¦æ¸…é™¤æ‰€æœ‰è³‡æ–™å—ï¼Ÿ')) { localStorage.removeItem('pwm_data_static'); localStorage.removeItem('pwm_data_dynamic'); location.reload(); } }

        function saveData() {
            const data = {};
            document.querySelectorAll('.persist-input').forEach(el => {
                if(el.type === 'checkbox') data[el.id] = el.checked; else data[el.id] = el.value;
            });
            // Save Select ID specifically
            data['si-type'] = document.getElementById('si-type').value;
            
            const dynamicData = { parents: [], children: [], income: [], expense: [], family: [] };
            document.querySelectorAll('.family-member-row').forEach(row => dynamicData.family.push({ relation: row.querySelector('.relation-input').value, name: row.querySelector('.name-input').value, dob: row.querySelector('.dob-input').value }));
            document.querySelectorAll('.parent-row').forEach(row => dynamicData.parents.push({ type: row.querySelector('.p-type').value, age: row.querySelector('.p-age').value, money: row.querySelector('.p-money').value }));
            document.querySelectorAll('.child-edu-row').forEach(row => dynamicData.children.push({ age: row.querySelector('.c-age').value, degree: row.querySelector('.c-degree').value, type: row.querySelector('.c-type:checked').value }));
            ['income', 'expense'].forEach(type => document.querySelectorAll(`.${type}-select`).forEach(sel => dynamicData[type].push({ name: sel.value, amount: sel.closest('tr').querySelector(`.${type}-amount`).value })));
            localStorage.setItem('pwm_data_static', JSON.stringify(data));
            localStorage.setItem('pwm_data_dynamic', JSON.stringify(dynamicData));
        }

        function loadData() {
            try {
                const staticData = JSON.parse(localStorage.getItem('pwm_data_static'));
                if(staticData) {
                    for(let id in staticData) {
                        const el = document.getElementById(id);
                        if(el) { if(el.type === 'checkbox') el.checked = staticData[id]; else el.value = staticData[id]; }
                    }
                    if(staticData['si-type']) {
                        document.getElementById('si-type').value = staticData['si-type'];
                        updateSocialInsurance(); // Update link/note
                    }
                    syncPage2Visibility();
                }
                const dynamicData = JSON.parse(localStorage.getItem('pwm_data_dynamic'));
                if(dynamicData) {
                    if(dynamicData.family) {
                        const container = document.getElementById('family-container');
                        container.querySelectorAll('.family-member-row').forEach(e => e.remove());
                        dynamicData.family.forEach(f => { addFamilyMember(); const r = container.lastElementChild; r.querySelector('.relation-input').value = f.relation; r.querySelector('.name-input').value = f.name; r.querySelector('.dob-input').value = f.dob; updateAge(r.querySelector('.dob-input')); });
                    }
                    document.getElementById('parents-container').innerHTML = ''; dynamicData.parents.forEach(p => addParentRow(p.type, p.age, p.money));
                    document.getElementById('edu-container').innerHTML = ''; dynamicData.children.forEach(c => addChildEduRow(c.age, c.degree, c.type));
                    document.getElementById('income-body').innerHTML = ''; dynamicData.income.forEach(i => addFlowRow('income', i.name, i.amount));
                    document.getElementById('expense-body').innerHTML = ''; dynamicData.expense.forEach(e => addFlowRow('expense', e.name, e.amount));
                }
            } catch(e) {}
            const dobInput = document.getElementById('main-dob'); if(dobInput.value) updateAge(dobInput);
        }

        function updateAge(input) {
            if (!input.value) return;
            const parts = input.value.split('-'); const birthDate = new Date(parts[0], parts[1]-1, parts[2]); const today = new Date();
            let months = (today.getFullYear() - birthDate.getFullYear()) * 12 + (today.getMonth() - birthDate.getMonth());
            if (today.getDate() < birthDate.getDate()) months--;
            const insAge = Math.floor(months / 12) + (months % 12 >= 6 ? 1 : 0);
            const row = input.closest('.grid'); if (row) { const el = row.querySelector('.age-display'); if(el) { el.innerText = insAge + " æ­²"; el.classList.add('highlight-update'); setTimeout(()=>el.classList.remove('highlight-update'), 1000); } }
            if (input.id === 'main-dob') { document.getElementById('main-user-age-value').value = insAge; document.getElementById('retire-current-age').value = insAge; calculateAll(); }
            saveData();
        }

        function addFamilyMember() {
            const div = document.createElement('div');
            div.className = "grid grid-cols-1 md:grid-cols-12 gap-4 items-end bg-slate-50 p-5 rounded-2xl border border-slate-200 relative animate-fade-in family-member-row";
            div.innerHTML = `<div class="md:col-span-2"><label class="block text-xs font-bold text-slate-500 mb-1">é—œä¿‚</label><select class="form-input relation-input persist-input" onchange="saveData()"><option>é…å¶</option><option>å­å¥³</option><option>çˆ¶æ¯</option></select></div><div class="md:col-span-3"><label class="block text-xs font-bold text-slate-500 mb-1">å§“å</label><input type="text" class="form-input name-input" onchange="saveData()"></div><div class="md:col-span-4"><label class="block text-xs font-bold text-slate-500 mb-1">å‡ºç”Ÿå¹´æœˆæ—¥</label><input type="date" class="form-input dob-input" onchange="updateAge(this)"></div><div class="md:col-span-3 relative"><label class="block text-xs font-bold text-slate-500 mb-1">ä¿éšªå¹´é½¡</label><div class="bg-white p-3 rounded-lg text-center font-bold text-slate-800 border border-slate-200 age-display">-- æ­²</div><button onclick="this.closest('.grid').remove();saveData()" class="absolute -top-2 -right-2 bg-red-500 text-white w-6 h-6 rounded-full text-xs shadow-md">Ã—</button></div>`;
            document.getElementById('family-container').appendChild(div);
        }

        function syncInsurance(val, targetId) { const target = document.getElementById(targetId); if(target && target.value !== val) target.value = val; calculateAll(); }
        function togglePages(pageId) { document.querySelectorAll('[id^="page"]').forEach(el => el.classList.add('hidden')); document.getElementById(pageId).classList.remove('hidden'); window.scrollTo(0, 0); if (pageId === 'page2') syncPage2Visibility(); }
        function syncPage2Visibility() { const map = {'check-sick': 'section-sick', 'check-disability': 'section-disability', 'check-death': 'section-death', 'check-retire': 'section-retire'}; for (let [cbId, secId] of Object.entries(map)) { const el = document.getElementById(secId); if(document.getElementById(cbId).checked) el.classList.remove('hidden'); else el.classList.add('hidden'); } }
        function addParentRow(typeVal, ageVal, moneyVal) { const div = document.createElement('div'); div.className = "parent-row flex gap-2 items-center text-sm mb-2"; div.innerHTML = `<select class="p-type border rounded p-2"><option value="76">çˆ¶(å¹³å‡å£½å‘½76)</option><option value="84">æ¯(å¹³å‡å£½å‘½84)</option></select><input type="number" class="p-age border rounded p-2 w-20" placeholder="æ­²" onchange="saveData()"><input type="number" class="p-money border rounded p-2 w-24" placeholder="æœˆ(è¬)" onkeyup="calculateAll();saveData()" onchange="saveData()"><button onclick="this.parentElement.remove();calculateAll();saveData()" class="text-red-500 px-2"><i class="fas fa-trash"></i></button>`; document.getElementById('parents-container').appendChild(div); if(typeVal) div.querySelector('.p-type').value = typeVal; if(ageVal) div.querySelector('.p-age').value = ageVal; if(moneyVal) div.querySelector('.p-money').value = moneyVal; }
        function addChildEduRow(ageVal, degreeVal, typeVal) { const ts = Date.now() + Math.random(); const div = document.createElement('div'); div.className = "child-edu-row bg-slate-50 p-3 rounded-lg text-sm border border-slate-200"; div.innerHTML = `<div class="flex gap-2 mb-2"><input type="number" class="c-age w-full border rounded p-2" placeholder="æ­²" onkeyup="calculateAll();saveData()" onchange="saveData()"><select class="c-degree w-full border rounded p-2" onchange="calculateAll();saveData()"><option value="22">è‡³å¤§å­¸ç•¢æ¥­(22æ­²)</option><option value="24">è‡³ç¢©å£«ç•¢æ¥­(24æ­²)</option></select></div><div class="flex justify-between items-center"><div class="space-x-3"><label class="inline-flex items-center"><input type="radio" name="e_${ts}" value="public" class="c-type mr-1" onchange="calculateAll();saveData()">å…¬ç«‹</label><label class="inline-flex items-center"><input type="radio" name="e_${ts}" value="private" class="c-type mr-1" checked onchange="calculateAll();saveData()">ç§ç«‹</label></div><button onclick="this.closest('.child-edu-row').remove();calculateAll();saveData()" class="text-red-400 text-xs font-bold">åˆªé™¤</button></div>`; document.getElementById('edu-container').appendChild(div); if(ageVal) div.querySelector('.c-age').value = ageVal; if(degreeVal) div.querySelector('.c-degree').value = degreeVal; if(typeVal) div.querySelector(`input[value="${typeVal}"]`).checked = true; }
        function addFlowRow(type, name, amount) { const tbody = document.getElementById(type + '-body'); const tr = document.createElement('tr'); const masterList = type === 'income' ? ['è–ªè³‡æ”¶å…¥', 'å¹´çµ‚çé‡‘', 'è‚¡åˆ©', 'ç§Ÿé‡‘', 'å…¼è·', 'æŠ•è³‡', 'å…¶ä»–'] : ['ç”Ÿæ´»é–‹éŠ·', 'äº¤é€š', 'æˆ¿è²¸/æˆ¿ç§Ÿ', 'ä¿éšª', 'å­è¦ªè²»', 'æ•™è‚²', 'å¨›æ¨‚', 'é›œæ”¯', 'å…¶ä»–']; let opts = masterList.map(o => `<option value="${o}">${o}</option>`).join(''); tr.innerHTML = `<td data-label="é …ç›®"><select class="form-input ${type}-select" onchange="saveData()">${opts}</select></td><td data-label="é‡‘é¡"><input type="number" class="form-input ${type}-amount" placeholder="0" onkeyup="calculateAll();saveData()" onchange="saveData()"></td><td class="action-col"><button onclick="this.closest('tr').remove();calculateAll();saveData()" class="text-slate-400 hover:text-red-500"><i class="fas fa-trash"></i></button></td>`; tbody.appendChild(tr); if(name) { const sel = tr.querySelector('select'); if(![...sel.options].some(o => o.value === name)) { const o = document.createElement('option'); o.value = name; o.text = name; sel.add(o); } sel.value = name; } if(amount) tr.querySelector('input').value = amount; }
        function updateExpenseRow(name, val) { if (!val || val === 0) return; let found = false; document.querySelectorAll('#expense-body tr').forEach(row => { if(row.querySelector('select')?.value === name) { row.querySelector('input').value = Math.round(val); found = true; } }); if (!found) addFlowRow('expense', name, Math.round(val)); }

        // --- æ ¸å¿ƒï¼šå•†æ¥­å ±å‘Šç”Ÿæˆé‚è¼¯ ---
        async function generateReport() {
            calculateAll();
            const overlay = document.getElementById('loading-overlay');
            overlay.style.display = 'flex';

            try {
                // 1. æ•¸æ“šæº–å‚™
                const name = document.getElementById('main-name').value || 'è²´è³“';
                const date = new Date().toLocaleDateString('zh-TW');
                const clean = str => parseFloat(String(str).replace(/,/g, '').replace(/[^\d.-]/g, '')) || 0;
                let sickGap = 0; document.querySelectorAll('.sick-gap').forEach(e => sickGap += clean(e.innerText));
                const disGap = document.getElementById('dis-gap').innerText;
                const deathGap = document.getElementById('grand-total-gap').innerText + " è¬";
                const retireGap = document.getElementById('retire-annual-save').innerText + " è¬/å¹´";
                const deathNeed = document.getElementById('grand-total-gap').getAttribute('data-need');
                
                // ç¤¾ä¿è³‡æ–™æŠ“å– (æ”¹ç”¨è¨ˆç®—å¾Œçš„æ•¸æ“š)
                const siType = document.getElementById('si-type').value;
                const siLabelMap = { labor: 'å‹ä¿èº«æ•…çµ¦ä»˜', gov: 'å…¬ä¿æ­»äº¡çµ¦ä»˜', farmer: 'è¾²ä¿å–ªè‘¬æ´¥è²¼', fisher: 'æ¼ä¿èº«æ•…çµ¦ä»˜' };
                const siLabel = siLabelMap[siType];
                const siBenefit = document.getElementById('labor-benefit-val-p3').innerText; // å·²ç¶“æ˜¯è¬å–®ä½

                const group = document.getElementById('group-insurance-p3').value || 0;
                const comm = document.getElementById('comm-insurance-p3').value || 0;
                let inc = 0, exp = 0;
                document.querySelectorAll('.income-amount').forEach(i => inc += clean(i.value));
                document.querySelectorAll('.expense-amount').forEach(i => exp += clean(i.value));
                const net = inc - exp;
                const netFmt = net.toLocaleString('en-US');

                // ç”¢åœ–
                const chartImg = await generateChartAsync(deathNeed, 
                    clean(siBenefit)*10000, // Pass actual value
                    group, comm);

                // å°ˆå®¶å»ºè­°
                let suggestionHTML = '';
                if (net > 0) {
                    suggestionHTML = `<div style="margin-bottom:15px; border-bottom:1px solid #e2e8f0; padding-bottom:10px;"><strong style="color:#059669;font-size:20px;">ğŸŸ¢ è²¡å‹™å¥åº·è¨ºæ–·ï¼šæ­£å‘çµé¤˜</strong><p style="margin-top:5px;opacity:0.8;font-size:15px;">æ­å–œæ‚¨ï¼æ‚¨çš„å¹´åº¦æ”¶æ”¯ç‹€æ³è‰¯å¥½ï¼Œæ“æœ‰è‡ªç”±ç¾é‡‘æµã€‚é€™ç‚ºæ‚¨çš„è³‡ç”¢é…ç½®æä¾›äº†çµ•ä½³çš„åŸºç¤ã€‚</p></div><div><strong style="color:#0f172a;font-size:18px;display:block;margin-bottom:10px;">ğŸ’¡ å°ˆå®¶è¦åŠƒå»ºè­°</strong><ul style="margin:0;padding-left:20px;line-height:1.6;font-size:15px;color:#334155;"><li><strong>å„ªå…ˆå»ºæ§‹é˜²è­·ç¶²</strong>ï¼šå°‡éƒ¨åˆ†ç›ˆé¤˜æŠ•å…¥è£œè¶³é†«ç™‚èˆ‡èº«æ•…ç¼ºå£ï¼Œç¢ºä¿è³‡ç”¢ä¸å› é¢¨éšªè€Œç¸®æ°´ã€‚</li><li><strong>å°ˆæ¬¾å°ˆç”¨é€€ä¼‘é‡‘</strong>ï¼šå–„ç”¨æ™‚é–“è¤‡åˆ©ï¼Œææ—©å•Ÿå‹•é€€ä¼‘å„²è“„è¨ˆåŠƒã€‚</li><li><strong>è³‡ç”¢å¢å€¼</strong>ï¼šå‰©é¤˜è³‡é‡‘å¯é€²è¡Œç©©å¥æŠ•è³‡ï¼Œå°æŠ—é€šè²¨è†¨è„¹ã€‚</li></ul></div>`;
                } else {
                    suggestionHTML = `<div style="margin-bottom:15px; border-bottom:1px solid #e2e8f0; padding-bottom:10px;"><strong style="color:#dc2626;font-size:20px;">ğŸ”´ è²¡å‹™å¥åº·è¨ºæ–·ï¼šéœ€è¦èª¿æ•´</strong><p style="margin-top:5px;opacity:0.8;font-size:15px;">ç›®å‰çš„å¹´åº¦æ”¶æ”¯å‘ˆç¾ç·Šç¹ƒç‹€æ…‹ã€‚ç†è²¡çš„ç¬¬ä¸€æ­¥æ˜¯ã€Œæ”¶æ”¯å¹³è¡¡ã€ï¼Œé€™å°‡æ˜¯æˆ‘å€‘é¦–è¦è§£æ±ºçš„èª²é¡Œã€‚</p></div><div><strong style="color:#991b1b;font-size:18px;display:block;margin-bottom:10px;">ğŸ’¡ å°ˆå®¶è¦åŠƒå»ºè­°</strong><ul style="margin:0;padding-left:20px;line-height:1.6;font-size:15px;color:#334155;"><li><strong>ç¾é‡‘æµæª¢è¦–</strong>ï¼šå”åŠ©æ‚¨æª¢è¦–æ”¯å‡ºæ˜ç´°ï¼Œæ‰¾å‡ºèª¿æ•´ç©ºé–“ã€‚</li><li><strong>åŸºç¤ä¿éšœå„ªå…ˆ</strong>ï¼šåœ¨é ç®—æœ‰é™ä¸‹ï¼Œå„ªå…ˆè¦åŠƒé«˜æ§“æ¡¿çš„å®šæœŸå£½éšªèˆ‡å¯¦æ”¯å¯¦ä»˜ã€‚</li><li><strong>é¢¨éšªè½‰å«</strong>ï¼šé¿å…å› çªç™¼ç–¾ç—…å°è‡´å®¶åº­è²¡å‹™å´©æ½°ï¼Œä¿éšœæ˜¯ç‚ºäº†ç•™ä½æ¯ä¸€åˆ†éŒ¢ã€‚</li></ul></div>`;
                }

                // 2. å•†æ¥­å ±å‘Š HTML
                const htmlContent = `
                    <html>
                    <head>
                        <title>ä¿éšœåˆ†æå ±å‘Š - ${name}</title>
                        <style>
                            @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;700;900&display=swap');
                            body { font-family: 'Noto Sans TC', sans-serif; margin: 0; padding: 0; background: #fff; -webkit-print-color-adjust: exact !important; print-color-adjust: exact !important; }
                            @page { size: A4; margin: 0; }
                            .page { width: 210mm; height: 296mm; overflow: hidden; page-break-after: always; position: relative; display: flex; flex-direction: column; background: white; }
                            .cover-page { position: absolute; top:0; left:0; width: 100%; height: 100%; background: linear-gradient(135deg, #0f172a 0%, #1e3a8a 100%); color: white; display: flex; flex-direction: column; justify-content: center; padding-left: 30mm; box-sizing: border-box; }
                            .cover-line { width: 80px; height: 6px; background: #b45309; margin-bottom: 30px; }
                            .cover-title-group h1 { font-size: 54px; font-weight: 900; margin: 0; line-height: 1.2; }
                            .cover-sub { font-size: 20px; font-weight: 300; margin-bottom: 60px; letter-spacing: 2px; opacity: 0.9; }
                            .header-bar { height: 15mm; background: #0f172a; color: white; display: flex; align-items: center; justify-content: space-between; padding: 0 20mm; font-size: 12px; letter-spacing: 1px; flex-shrink: 0; }
                            .brand { font-weight: 900; color: #b45309; font-size: 14px; }
                            .content { padding: 15mm 20mm; flex: 1; display: flex; flex-direction: column; }
                            .page-title { font-size: 24px; font-weight: 900; color: #0f172a; border-bottom: 3px solid #e2e8f0; padding-bottom: 10px; margin-bottom: 20px; flex-shrink: 0; }
                            .dashboard { display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; margin-bottom: 25px; flex-shrink: 0; }
                            .metric-card { background: #f8fafc; border-top: 4px solid #cbd5e1; padding: 15px 10px; text-align: center; border-radius: 4px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
                            .metric-title { font-size: 12px; color: #64748b; font-weight: bold; text-transform: uppercase; margin-bottom: 5px; }
                            .metric-val { font-size: 20px; font-weight: 900; color: #0f172a; }
                            .table-container { margin-bottom: 20px; flex-shrink: 0; }
                            .clean-table { width: 100%; border-collapse: collapse; font-size: 13px; }
                            .clean-table th { text-align: left; padding: 10px; border-bottom: 2px solid #94a3b8; color: #475569; }
                            .clean-table td { padding: 10px; border-bottom: 1px solid #f1f5f9; }
                            .chart-container { flex: 1; border: 1px solid #e2e8f0; border-radius: 8px; padding: 15px; display: flex; flex-direction: column; justify-content: center; }
                            .chart-title { text-align: center; font-weight: bold; color: #475569; margin-bottom: 10px; }
                            .chart-img { width: 100%; height: 100%; object-fit: contain; max-height: 400px; }
                            .split-layout { display: grid; grid-template-columns: 1fr 1.2fr; gap: 30px; height: 100%; }
                            .fin-left { display: flex; flex-direction: column; gap: 20px; }
                            .fin-right { display: flex; flex-direction: column; }
                            .fin-dashboard { background: #f8fafc; padding: 25px; border-radius: 12px; border: 1px solid #e2e8f0; text-align: center; }
                            .fin-score { font-size: 36px; font-weight: 900; color: ${net>=0 ? '#059669' : '#dc2626'}; margin: 10px 0; }
                            .advice-box { flex: 1; background: #fff; border: 1px solid #e2e8f0; border-radius: 8px; padding: 25px; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05); }
                            .footer { height: 12mm; border-top: 1px solid #e2e8f0; margin: 0 20mm; display: flex; align-items: center; justify-content: space-between; font-size: 10px; color: #94a3b8; flex-shrink: 0; }
                        </style>
                    </head>
                    <body>
                        <div class="page">
                            <div class="cover-page">
                                <div class="cover-title-group" style="border-left: 8px solid #b45309; padding-left: 30px;">
                                    <div style="font-size: 20px; opacity: 0.8; margin-bottom: 10px; letter-spacing: 2px; text-transform: uppercase;">Your wealth guidance to the future</div>
                                    <h1 style="font-size: 56px; font-weight: 900; line-height: 1.1; margin: 0;">å…¨æ–¹ä½<br>è²¡å¯Œä¿éšœå ±å‘Š</h1>
                                </div>
                                <div style="margin-top: 80px; padding-left: 38px;">
                                    <p style="font-size: 14px; opacity: 0.6; letter-spacing: 1px;">PREPARED FOR</p>
                                    <h2 style="font-size: 32px; margin: 5px 0 20px 0;">${name} è²´è³“</h2>
                                    <p style="font-size: 14px; opacity: 0.8;">å ±å‘Šæ—¥æœŸï¼š${date}</p>
                                </div>
                            </div>
                        </div>
                        <div class="page">
                            <div class="header-bar"><span class="brand">POLARIS WEALTH</span><span>é¢¨éšªåˆ†æ Risk Analysis</span></div>
                            <div class="content">
                                <div class="page-title">é¢¨éšªç¼ºå£ç¸½è¦½</div>
                                <div class="dashboard">
                                    <div class="metric-card" style="border-color:#ef4444"><div class="metric-title">é†«ç™‚ç¼ºå£</div><div class="metric-val" style="color:#ef4444">${parseFloat(sickGap).toLocaleString()} è¬</div></div>
                                    <div class="metric-card" style="border-color:#f59e0b"><div class="metric-title">å¤±èƒ½æœˆç¼ºå£</div><div class="metric-val" style="color:#f59e0b">${disGap}</div></div>
                                    <div class="metric-card" style="border-color:#0f172a"><div class="metric-title">èº«æ•…ç¼ºå£</div><div class="metric-val" style="color:#0f172a">${deathGap}</div></div>
                                    <div class="metric-card" style="border-color:#b45309; background:#fffbeb"><div class="metric-title" style="color:#b45309">é€€ä¼‘æº–å‚™</div><div class="metric-val" style="color:#b45309">${retireGap}</div></div>
                                </div>
                                <div class="table-container">
                                    <div style="font-size:14px; font-weight:bold; color:#475569; margin-bottom:8px;">ä¿éšœçµæ§‹æ˜ç´°</div>
                                    <table class="clean-table">
                                        <tr><th width="35%">é …ç›®</th><th width="30%">é ä¼°é‡‘é¡</th><th>å‚™è¨»</th></tr>
                                        <tr><td><strong>å®¶åº­ç¸½è²¬ä»»</strong></td><td><strong>${parseFloat(deathNeed).toLocaleString()} è¬</strong></td><td>æˆ¿è²¸ã€æ•™è‚²ã€ç”Ÿæ´»è²»ç¸½å’Œ</td></tr>
                                        <tr><td>(-) ${siLabel}</td><td style="color:#059669;">- ${siBenefit} è¬</td><td></td></tr>
                                        <tr><td>(-) åœ˜ä¿/æ’«å¹</td><td style="color:#059669;">- ${parseFloat(group).toLocaleString()} è¬</td><td></td></tr>
                                        <tr><td>(-) å•†æ¥­å£½éšª</td><td style="color:#059669;">- ${parseFloat(comm).toLocaleString()} è¬</td><td>æ—¢æœ‰ä¿å–®</td></tr>
                                        <tr style="background:#fee2e2;"><td style="color:#b91c1c; font-weight:bold;">éœ€å¢è£œç¼ºå£</td><td style="color:#b91c1c; font-weight:bold;">${deathGap}</td><td>å»ºè­°å„ªå…ˆè£œè¶³</td></tr>
                                    </table>
                                </div>
                                <div class="chart-container"><div class="chart-title">å®¶åº­è²¬ä»»èˆ‡ä¿éšœèµ°å‹¢åœ–</div><img src="${chartImg}" class="chart-img"></div>
                            </div>
                            <div class="footer"><span>æœ¬å ±å‘Šåƒ…ä¾›åƒè€ƒï¼Œå¯¦éš›ç†è³ é‡‘é¡ä»¥ä¿å–®æ¢æ¬¾ç‚ºæº–</span><span>Page 1</span></div>
                        </div>
                        <div class="page">
                            <div class="header-bar"><span class="brand">POLARIS WEALTH</span><span>è²¡å‹™å»ºè­° Financial Advice</span></div>
                            <div class="content">
                                <div class="page-title">è²¡å‹™æ”¶æ”¯èˆ‡å»ºè­°</div>
                                <div class="split-layout">
                                    <div class="fin-left">
                                        <div class="fin-dashboard">
                                            <div style="font-size:14px; color:#64748b; font-weight:bold;">å¹´åº¦æ·¨ç¾é‡‘æµ</div>
                                            <div class="fin-score">${netFmt} è¬</div>
                                            <div style="font-size:12px; opacity:0.6;">(æ”¶å…¥ - æ”¯å‡º)</div>
                                        </div>
                                        <div style="border:1px solid #e2e8f0; border-radius:8px; padding:20px;">
                                            <div style="display:flex; justify-content:space-between; margin-bottom:15px; border-bottom:1px solid #f1f5f9; padding-bottom:10px;"><span>å¹´åº¦ç¸½æ”¶å…¥</span><span style="font-weight:bold; color:#059669;">${parseFloat(inc).toLocaleString()} è¬</span></div>
                                            <div style="display:flex; justify-content:space-between;"><span>å¹´åº¦ç¸½æ”¯å‡º</span><span style="font-weight:bold; color:#dc2626;">${parseFloat(exp).toLocaleString()} è¬</span></div>
                                        </div>
                                    </div>
                                    <div class="fin-right"><div class="advice-box">${suggestionHTML}</div></div>
                                </div>
                            </div>
                            <div class="footer"><span>æœ¬å ±å‘Šåƒ…ä¾›åƒè€ƒï¼Œå¯¦éš›ç†è³ é‡‘é¡ä»¥ä¿å–®æ¢æ¬¾ç‚ºæº–</span><span>Page 2</span></div>
                        </div>
                    </body>
                    </html>
                `;

                const newWin = window.open('', '_blank');
                if(!newWin) throw new Error("è«‹å…è¨±å½ˆå‡ºè¦–çª—");
                newWin.document.write(htmlContent);
                newWin.document.close();
                newWin.onload = function() { setTimeout(() => { overlay.style.display = 'none'; newWin.focus(); newWin.print(); }, 500); };
            } catch (e) { alert('å ±å‘Šç”¢å‡ºå¤±æ•—ï¼š' + e.message); overlay.style.display = 'none'; }
        }

        // Chart with Smart Labels
        function generateChartAsync(needVal, laborVal, groupVal, commVal) {
            return new Promise((resolve) => {
                const canvas = document.getElementById('hidden-chart-canvas');
                const ctx = canvas.getContext('2d');
                canvas.width = 2400; canvas.height = 1000;

                const age = parseInt(document.getElementById('main-user-age-value').value) || 30;
                const retireAgeVal = document.getElementById('retire-target-age').value;
                const retireAge = retireAgeVal ? parseInt(retireAgeVal) : 65;
                const totalCov = (parseFloat(String(laborVal).replace(/,/g,'')) || 0) + parseFloat(groupVal) + parseFloat(commVal);
                const startNeed = parseFloat(needVal) || 0;

                const labels = []; const needData = []; const existData = [];
                for(let y = age; y <= retireAge; y++) {
                    labels.push(y);
                    let decay = 1 - ((y - age) / (retireAge - age));
                    needData.push(Math.round(startNeed * decay));
                    existData.push(totalCov);
                }

                if(window.pdfChart) window.pdfChart.destroy();

                window.pdfChart = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: labels,
                        datasets: [
                            { label: 'å®¶åº­è²¬ä»»éæ¸›', data: needData, backgroundColor: 'rgba(59, 130, 246, 0.6)', order: 2, barPercentage: 0.7 },
                            { label: 'ç¾æœ‰ä¿éšœ', data: existData, type: 'line', borderColor: '#10b981', borderWidth: 5, pointRadius: 0, order: 1 }
                        ]
                    },
                    options: {
                        animation: { onComplete: function() { resolve(canvas.toDataURL()); } },
                        responsive: false,
                        devicePixelRatio: 2,
                        plugins: { legend: { labels: { font: { size: 26 } } } },
                        scales: { x: { ticks: { font: { size: 20 } } }, y: { beginAtZero: true, ticks: { font: { size: 20 } } } }
                    },
                    plugins: [{
                        id: 'gapLabel',
                        afterDatasetsDraw: (chart) => {
                            const ctx = chart.ctx;
                            chart.data.datasets.forEach((dataset, i) => {
                                if (dataset.label === 'å®¶åº­è²¬ä»»éæ¸›') {
                                    const meta = chart.getDatasetMeta(i);
                                    meta.data.forEach((bar, index) => {
                                        const currentAge = labels[index];
                                        if (index === 0 || currentAge % 5 === 0) {
                                            const gap = dataset.data[index] - existData[index];
                                            if (gap > 0) {
                                                ctx.save(); ctx.fillStyle = '#dc2626'; ctx.font = 'bold 28px Arial'; ctx.textAlign = 'center';
                                                ctx.fillText(gap.toLocaleString(), bar.x, bar.y - 15); ctx.restore();
                                            }
                                        }
                                    });
                                }
                            });
                        }
                    }]
                });
            });
        }
    </script>
</body>
</html>
