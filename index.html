<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å…¨æ–¹ä½è²¡å¯Œä¿éšœç³»çµ± Pro (2026 ç©ºç™½é€šç”¨ç‰ˆ)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        /* --- æ ¸å¿ƒæ¨£å¼ --- */
        body { font-family: 'Microsoft JhengHei', sans-serif; background-color: #f1f5f9; overflow-x: hidden; -webkit-tap-highlight-color: transparent; }
        .gradient-bg { background: linear-gradient(135deg, #0f172a 0%, #334155 100%); }
        .glass-card { background: rgba(255, 255, 255, 0.98); backdrop-filter: blur(10px); border: 1px solid rgba(255,255,255,0.2); }
        input[type="number"]::-webkit-inner-spin-button { -webkit-appearance: none; }
        .hidden { display: none !important; }
        
        /* å‹•ç•« */
        .animate-fade-in { animation: fadeIn 0.3s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

        /* è¡¨æ ¼æ¨£å¼ (Desktop) - å¯¬æ•é–“è· */
        .financial-table th { background-color: #f8fafc; color: #475569; padding: 16px; font-size: 1rem; border-bottom: 2px solid #e2e8f0; font-weight: 700; white-space: nowrap; }
        .financial-table td { padding: 16px; border-bottom: 1px solid #f1f5f9; vertical-align: middle; }
        
        /* é€šç”¨ Input */
        .form-input { width: 100%; border: 1px solid #cbd5e1; border-radius: 8px; padding: 12px; font-size: 1rem; transition: all 0.2s; }
        .form-input:focus { border-color: #3b82f6; box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1); outline: none; }
        
        /* æ‰‹æ©Ÿç‰ˆå¡ç‰‡å¼è¡¨æ ¼å„ªåŒ– */
        @media (max-width: 768px) {
            .mobile-card-table thead { display: none; }
            .mobile-card-table tbody tr { display: block; background: white; margin-bottom: 15px; border-radius: 12px; border: 1px solid #e2e8f0; padding: 20px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
            .mobile-card-table td { display: block; width: 100%; padding: 8px 0; border: none; }
            .mobile-card-table td::before { content: attr(data-label); float: left; font-weight: bold; color: #64748b; margin-right: 10px; font-size: 1rem; margin-top: 10px;}
            .mobile-card-table input, .mobile-card-table select { width: 100%; }
            .mobile-card-table .action-col { text-align: right; margin-top: 15px; border-top: 1px dashed #e2e8f0; padding-top: 15px; }
        }

        /* Loading é®ç½© */
        #loading-overlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.85); z-index: 100000; color: white; justify-content: center; align-items: center; flex-direction: column; backdrop-filter: blur(5px); }
        .spinner { border: 4px solid rgba(255,255,255,0.3); border-radius: 50%; border-top: 4px solid #d4af37; width: 50px; height: 50px; animation: spin 1s linear infinite; margin-bottom: 20px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* è¨­å®šè¦–çª— Modal */
        #settings-modal { transition: opacity 0.3s ease; }
        #settings-modal.hidden { opacity: 0; pointer-events: none; }
        #settings-modal:not(.hidden) { opacity: 1; pointer-events: auto; }
        
        /* å¹´é½¡é¡¯ç¤ºæ›´æ–°æç¤ºå‹•ç•« */
        .highlight-update { animation: highlight 1s ease; }
        @keyframes highlight { 0% { background-color: #fef3c7; } 100% { background-color: #ffffff; } }

        /* å¡ç‰‡è¦–è¦ºå¢å¼· (å¤§åœ–ç¤º) */
        .need-card { height: 280px; }
        @media (min-width: 768px) { .need-card { height: 450px; } } 
    </style>
</head>
<body class="bg-slate-100 min-h-screen text-slate-800 font-sans" onload="initSystem()">

    <div id="loading-overlay">
        <div class="spinner"></div>
        <div class="text-2xl font-bold tracking-widest">å ±å‘Šç”Ÿæˆä¸­</div>
        <p class="text-sm text-gray-400 mt-2">æ­£åœ¨ç¹ªè£½åœ–è¡¨èˆ‡æ’ç‰ˆï¼Œè«‹ç¨å€™...</p>
    </div>

    <canvas id="hidden-chart-canvas" width="1200" height="600" style="position:fixed; left:-9999px;"></canvas>

    <div id="settings-modal" class="fixed inset-0 z-50 flex items-center justify-center bg-black/60 hidden backdrop-blur-sm">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-md p-6 m-4 animate-fade-in">
            <div class="flex justify-between items-center mb-6 border-b pb-4">
                <h3 class="text-xl font-bold text-slate-800"><i class="fas fa-cog mr-2"></i> åƒæ•¸è¨­å®š</h3>
                <button onclick="toggleSettings()" class="text-slate-400 hover:text-slate-600"><i class="fas fa-times text-xl"></i></button>
            </div>
            <div class="space-y-4">
                <h4 class="font-bold text-sm text-slate-500 uppercase">æ•™è‚²è²»ç”¨é è¨­å€¼ (è¬/å¹´)</h4>
                <div class="grid grid-cols-2 gap-4">
                    <div><label class="text-xs font-bold block mb-1">å…¬ç«‹ - K12</label><input type="number" id="cfg-pub-k12" class="form-input text-sm"></div>
                    <div><label class="text-xs font-bold block mb-1">ç§ç«‹ - K12</label><input type="number" id="cfg-pri-k12" class="form-input text-sm"></div>
                    <div><label class="text-xs font-bold block mb-1">å…¬ç«‹ - å¤§å­¸</label><input type="number" id="cfg-pub-uni" class="form-input text-sm"></div>
                    <div><label class="text-xs font-bold block mb-1">ç§ç«‹ - å¤§å­¸</label><input type="number" id="cfg-pri-uni" class="form-input text-sm"></div>
                    <div><label class="text-xs font-bold block mb-1">å…¬ç«‹ - ç¢©å£«</label><input type="number" id="cfg-pub-mas" class="form-input text-sm"></div>
                    <div><label class="text-xs font-bold block mb-1">ç§ç«‹ - ç¢©å£«</label><input type="number" id="cfg-pri-mas" class="form-input text-sm"></div>
                </div>
            </div>
            <div class="mt-8 flex justify-end gap-3">
                <button onclick="resetDefaultConfig()" class="px-4 py-2 text-sm text-slate-500 hover:bg-slate-100 rounded-lg">æ¢å¾©é è¨­</button>
                <button onclick="saveConfig()" class="px-6 py-2 bg-slate-800 text-white rounded-lg font-bold hover:bg-slate-900">å„²å­˜</button>
            </div>
        </div>
    </div>

    <div id="app-container">
        <div id="page1" class="container mx-auto py-6 px-4 md:py-10">
            <div class="max-w-6xl mx-auto glass-card shadow-2xl rounded-3xl overflow-hidden border border-white">
                <div class="gradient-bg p-6 md:p-8 text-white flex justify-between items-center">
                    <div><h1 class="text-2xl md:text-3xl font-black">å…¨æ–¹ä½è²¡å¯Œä¿éšœç³»çµ±</h1><p class="mt-1 text-slate-300 text-xs md:text-sm">Professional Wealth Management</p></div>
                    <div class="flex items-center gap-4">
                        <button onclick="clearAllData()" class="text-white/80 hover:text-red-300 transition text-sm flex items-center gap-1" title="æ¸…ç©ºæ‰€æœ‰æ¬„ä½"><i class="fas fa-trash-alt"></i> æ¸…é™¤</button>
                        <button onclick="toggleSettings()" class="text-white/80 hover:text-white transition"><i class="fas fa-cog text-xl"></i></button>
                        <div class="text-right opacity-80 text-sm font-mono border-l pl-4 border-white/20">Step 1/3</div>
                    </div>
                </div>
                
                <div class="p-6 md:p-8">
                    <section class="mb-10">
                        <div class="flex justify-between items-end mb-6">
                            <h2 class="text-xl font-bold border-l-4 border-slate-700 pl-3 text-slate-800">å®¢æˆ¶åŸºæœ¬è³‡æ–™</h2>
                            <button onclick="addFamilyMember()" class="text-sm bg-slate-100 text-slate-600 px-4 py-2 rounded-full hover:bg-slate-200 font-bold transition shadow-sm">+ æ–°å¢æˆå“¡</button>
                        </div>
                        <div id="family-container" class="space-y-4">
                            <div id="main-user-row" class="grid grid-cols-1 md:grid-cols-12 gap-4 items-end bg-slate-50 p-5 rounded-2xl border border-slate-200 shadow-sm" data-relation="æœ¬äºº">
                                <div class="md:col-span-2"><label class="text-xs font-bold text-slate-500 uppercase tracking-wide mb-1 block">é—œä¿‚</label><input type="text" value="æœ¬äºº" readonly class="w-full bg-white rounded-lg p-3 text-center font-bold text-slate-700 border border-slate-200"></div>
                                <div class="md:col-span-3"><label class="text-xs font-bold text-slate-500 uppercase tracking-wide mb-1 block">å§“å</label><input type="text" id="main-name" placeholder="è«‹è¼¸å…¥å§“å" class="form-input name-input persist-input" onchange="saveData()"></div>
                                <div class="md:col-span-4"><label class="text-xs font-bold text-slate-500 uppercase tracking-wide mb-1 block">å‡ºç”Ÿå¹´æœˆæ—¥</label><input type="date" id="main-dob" onchange="updateAge(this); saveData()" class="form-input dob-input persist-input"></div>
                                <div class="md:col-span-3"><label class="text-xs font-bold text-slate-500 uppercase tracking-wide mb-1 block">ä¿éšªå¹´é½¡</label><div id="main-user-age-display" class="bg-white p-3 rounded-lg text-center font-bold text-slate-800 text-lg border border-slate-200 age-display">-- æ­²</div><input type="hidden" id="main-user-age-value" value="0"></div>
                            </div>
                        </div>
                    </section>

                    <section class="mb-10">
                        <h2 class="text-xl font-bold border-l-4 border-slate-700 pl-3 mb-6 text-slate-800">æ ¸å¿ƒæ“”æ†‚èˆ‡ç›®æ¨™ (è«‹å‹¾é¸)</h2>
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                            <label class="relative need-card rounded-3xl overflow-hidden shadow-lg cursor-pointer group hover:shadow-2xl transition-all duration-300">
                                <input type="checkbox" id="check-sick" class="hidden peer persist-input" onchange="saveData()">
                                <div class="absolute inset-0 bg-cover bg-center transition-transform duration-700 group-hover:scale-110" style="background-image: url('https://images.unsplash.com/photo-1538108149393-fbbd81895907?q=80&w=600');"></div>
                                <div class="absolute inset-0 bg-black/40 peer-checked:bg-blue-900/80 transition-all"></div>
                                <div class="absolute top-6 right-6 text-white opacity-0 peer-checked:opacity-100 transition-all scale-0 peer-checked:scale-100"><i class="fas fa-check-circle text-4xl"></i></div>
                                <div class="relative h-full flex flex-col justify-end p-8 text-white">
                                    <h3 class="text-6xl font-black mb-2 tracking-tighter">ç—…</h3>
                                    <p class="text-xl font-bold opacity-90">é«˜ç«¯é†«ç™‚å“è³ª</p>
                                </div>
                                <div class="absolute inset-0 border-4 border-transparent peer-checked:border-blue-400 rounded-3xl pointer-events-none"></div>
                            </label>

                            <label class="relative need-card rounded-3xl overflow-hidden shadow-lg cursor-pointer group hover:shadow-2xl transition-all duration-300">
                                <input type="checkbox" id="check-disability" class="hidden peer persist-input" onchange="saveData()">
                                <div class="absolute inset-0 bg-cover bg-center transition-transform duration-700 group-hover:scale-110" style="background-image: url('https://images.unsplash.com/photo-1576765608535-5f04d1e3f289?q=80&w=600');"></div>
                                <div class="absolute inset-0 bg-black/40 peer-checked:bg-amber-900/80 transition-all"></div>
                                <div class="absolute top-6 right-6 text-white opacity-0 peer-checked:opacity-100 transition-all scale-0 peer-checked:scale-100"><i class="fas fa-check-circle text-4xl"></i></div>
                                <div class="relative h-full flex flex-col justify-end p-8 text-white">
                                    <h3 class="text-6xl font-black mb-2 tracking-tighter">æ®˜</h3>
                                    <p class="text-xl font-bold opacity-90">å¤±èƒ½é•·ç…§é˜²è­·</p>
                                </div>
                                <div class="absolute inset-0 border-4 border-transparent peer-checked:border-amber-400 rounded-3xl pointer-events-none"></div>
                            </label>

                            <label class="relative need-card rounded-3xl overflow-hidden shadow-lg cursor-pointer group hover:shadow-2xl transition-all duration-300">
                                <input type="checkbox" id="check-death" class="hidden peer persist-input" onchange="saveData()">
                                <div class="absolute inset-0 bg-cover bg-center transition-transform duration-700 group-hover:scale-110" style="background-image: url('https://images.unsplash.com/photo-1475483768296-6163e08872a1?q=80&w=600');"></div>
                                <div class="absolute inset-0 bg-black/40 peer-checked:bg-rose-900/80 transition-all"></div>
                                <div class="absolute top-6 right-6 text-white opacity-0 peer-checked:opacity-100 transition-all scale-0 peer-checked:scale-100"><i class="fas fa-check-circle text-4xl"></i></div>
                                <div class="relative h-full flex flex-col justify-end p-8 text-white">
                                    <h3 class="text-6xl font-black mb-2 tracking-tighter">æ­»</h3>
                                    <p class="text-xl font-bold opacity-90">å®¶åº­è²¬ä»»å‚³æ‰¿</p>
                                </div>
                                <div class="absolute inset-0 border-4 border-transparent peer-checked:border-rose-400 rounded-3xl pointer-events-none"></div>
                            </label>

                            <label class="relative need-card rounded-3xl overflow-hidden shadow-lg cursor-pointer group hover:shadow-2xl transition-all duration-300">
                                <input type="checkbox" id="check-retire" class="hidden peer persist-input" onchange="saveData()">
                                <div class="absolute inset-0 bg-cover bg-center transition-transform duration-700 group-hover:scale-110" style="background-image: url('https://images.unsplash.com/photo-1507525428034-b723cf961d3e?q=80&w=600');"></div>
                                <div class="absolute inset-0 bg-black/40 peer-checked:bg-emerald-900/80 transition-all"></div>
                                <div class="absolute top-6 right-6 text-white opacity-0 peer-checked:opacity-100 transition-all scale-0 peer-checked:scale-100"><i class="fas fa-check-circle text-4xl"></i></div>
                                <div class="relative h-full flex flex-col justify-end p-8 text-white">
                                    <h3 class="text-6xl font-black mb-2 tracking-tighter">è€</h3>
                                    <p class="text-xl font-bold opacity-90">é€€ä¼‘è²¡å¯Œè‡ªç”±</p>
                                </div>
                                <div class="absolute inset-0 border-4 border-transparent peer-checked:border-emerald-400 rounded-3xl pointer-events-none"></div>
                            </label>
                        </div>
                    </section>

                    <button onclick="togglePages('page2')" class="w-full bg-slate-800 text-white py-4 rounded-xl font-bold text-lg hover:bg-slate-900 shadow-xl transition transform hover:-translate-y-1">ä¸‹ä¸€æ­¥ï¼šéœ€æ±‚é‡åŒ–åˆ†æ</button>
                </div>
            </div>
        </div>

        <div id="page2" class="container mx-auto py-6 px-4 md:py-10 hidden">
            <div class="max-w-6xl mx-auto space-y-6">
                <div class="flex justify-between items-center mb-4">
                    <button onclick="togglePages('page1')" class="text-slate-500 hover:text-slate-800 font-bold flex items-center bg-white px-4 py-2 rounded-lg shadow-sm border border-slate-200 transition"><i class="fas fa-arrow-left mr-2"></i> è¿”å›ä¿®æ”¹</button>
                    <div class="text-sm font-bold text-slate-400 font-mono">Step 2/3</div>
                </div>

                <div id="section-sick" class="hidden bg-white p-6 rounded-2xl shadow-lg border-l-8 border-blue-500 calc-section">
                    <h2 class="text-xl md:text-2xl font-black text-slate-800 mb-6 flex items-center"><span class="bg-blue-100 p-2 rounded-lg mr-3 text-blue-600 text-xl">ğŸ¥</span> ç–¾ç—…é†«ç™‚éœ€æ±‚</h2>
                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                        <div class="lg:col-span-2">
                            <table class="w-full text-left mobile-card-table">
                                <thead class="bg-slate-50 text-slate-600 text-sm uppercase">
                                    <tr>
                                        <th class="p-5 rounded-l-lg">é …ç›®</th>
                                        <th class="p-5">å“è³ªéœ€æ±‚</th>
                                        <th class="p-5">å¯å®‰å¿ƒé¡åº¦ (è¬)</th>
                                        <th class="p-5">å·²å‚™è¦åŠƒ (è¬)</th>
                                        <th class="p-5 rounded-r-lg text-right">ç¼ºå£</th>
                                    </tr>
                                </thead>
                                <tbody class="divide-y divide-slate-100">
                                    <tr class="calc-row-sick">
                                        <td class="font-bold p-5" data-label="é …ç›®">ä½é™¢é›œè²»/å·®é¡</td>
                                        <td class="p-5" data-label="å“è³ª"><select class="form-input text-sm persist-input id-sick-room-type" onchange="saveData()"><option>å–®äººæˆ¿</option><option>é›™äººæˆ¿</option><option>å¥ä¿æˆ¿</option></select></td>
                                        <td class="p-5" data-label="å®‰å¿ƒé¡åº¦"><input type="number" class="sick-target form-input persist-input id-sick-room-target" onkeyup="calculateAll();saveData()" placeholder="0"></td>
                                        <td class="p-5" data-label="å·²å‚™"><input type="number" class="sick-current form-input persist-input id-sick-room-current" onkeyup="calculateAll();saveData()" placeholder="0"></td>
                                        <td class="text-right font-bold text-red-500 sick-gap action-col p-5" data-label="ç¼ºå£">0 è¬</td>
                                    </tr>
                                    <tr class="calc-row-sick">
                                        <td class="font-bold p-5" data-label="é …ç›®">ç™Œç—‡/é‡å¤§å‚·ç—…</td>
                                        <td class="p-5 text-sm text-slate-400" data-label="å“è³ª">ä¸€ç­†çµ¦ä»˜å‹</td>
                                        <td class="p-5" data-label="å®‰å¿ƒé¡åº¦"><input type="number" class="sick-target form-input persist-input id-sick-cancer-target" onkeyup="calculateAll();saveData()" placeholder="0"></td>
                                        <td class="p-5" data-label="å·²å‚™"><input type="number" class="sick-current form-input persist-input id-sick-cancer-current" onkeyup="calculateAll();saveData()" placeholder="0"></td>
                                        <td class="text-right font-bold text-red-500 sick-gap action-col p-5" data-label="ç¼ºå£">0 è¬</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                        <div class="lg:col-span-1 bg-slate-50 p-6 rounded-xl border border-slate-200">
                            <h4 class="font-bold text-slate-800 mb-4 text-lg flex items-center"><i class="fas fa-lightbulb text-yellow-500 mr-2"></i> é¡§å•æŒ‡å¼•</h4>
                            <div class="space-y-4 text-base text-slate-700 leading-relaxed">
                                <p><strong>ä½é™¢å“è³ªï¼š</strong>å‡ç­‰å–®äººæˆ¿å¯é™ä½é™¢å…§äº¤å‰æ„ŸæŸ“é¢¨éšªï¼Œæå‡ä¼‘é¤Šå“è³ªã€‚</p>
                                <p><strong>ç™Œç—‡è¶¨å‹¢ï¼š</strong>æ¨™é¶è—¥ç‰©ã€å…ç–«ç™‚æ³•å¤šéœ€è‡ªè²»ï¼Œå»ºè­°è¦åŠƒä¸€æ¬¡é‡‘ä»¥æ‡‰å°çŸ­æœŸå¤§é¡æ”¯å‡ºã€‚</p>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="section-disability" class="hidden bg-white p-6 rounded-2xl shadow-lg border-l-8 border-amber-500 calc-section">
                    <h2 class="text-xl md:text-2xl font-black text-slate-800 mb-6 flex items-center"><span class="bg-amber-100 p-2 rounded-lg mr-3 text-amber-600 text-xl">â™¿</span> å¤±èƒ½ç…§è­·éœ€æ±‚</h2>
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                        <div class="space-y-6">
                            <div><label class="text-base font-bold text-slate-600 mb-2 block">é ä¼°æ¯æœˆç…§è­·è²» (è¬)</label><input type="number" id="dis-target" class="form-input text-lg persist-input" placeholder="ä¾‹å¦‚: 5" onkeyup="calculateAll();saveData()"></div>
                            <div><label class="text-base font-bold text-slate-600 mb-2 block">å·²å‚™æœˆæ‰¶åŠ©é‡‘ (è¬)</label><input type="number" id="dis-current" class="form-input text-lg persist-input" placeholder="ä¾‹å¦‚: 1" onkeyup="calculateAll();saveData()"></div>
                            <div class="bg-amber-50 p-6 rounded-xl text-center border border-amber-100 mt-4">
                                <div class="text-sm text-amber-800 uppercase tracking-wider mb-2">æ¯æœˆç¼ºå£</div>
                                <div class="text-4xl font-black text-amber-600" id="dis-gap">0 <span class="text-xl">è¬/æœˆ</span></div>
                            </div>
                        </div>
                        <div class="bg-slate-50 p-6 rounded-xl border border-slate-200">
                            <h4 class="font-bold text-slate-800 mb-4 text-lg"><i class="fas fa-chart-line text-yellow-500 mr-2"></i> å¸‚å ´è¡Œæƒ…åƒè€ƒ</h4>
                            <ul class="space-y-3 text-base text-slate-700 list-disc list-inside leading-relaxed">
                                <li><strong>å¤–ç±çœ‹è­·ï¼š</strong> ç´„ 2.5 ~ 3 è¬/æœˆ</li>
                                <li><strong>å°ˆæ¥­æ©Ÿæ§‹ï¼š</strong> ç´„ 4 ~ 6 è¬/æœˆ</li>
                                <li><strong>æœ¬åœ‹çœ‹è­·ï¼š</strong> ç´„ 7 ~ 8 è¬/æœˆ</li>
                                <li class="text-slate-500 text-sm pt-2 list-none ml-0">* å°šæœªåŒ…å«å°¿å¸ƒã€ç‡Ÿé¤Šå“ç­‰è€—æè²» (ç´„ 1 è¬/æœˆ)</li>
                            </ul>
                        </div>
                    </div>
                </div>

                <div id="section-death" class="hidden grid grid-cols-1 lg:grid-cols-3 gap-6">
                    <div class="lg:col-span-2 space-y-6">
                        <div class="bg-white p-6 rounded-2xl shadow-lg border-l-8 border-rose-500">
                            <h2 class="text-xl md:text-2xl font-black text-slate-800 mb-6 flex items-center"><span class="bg-rose-100 p-2 rounded-lg mr-3 text-rose-600 text-xl">ğŸ•Šï¸</span> èº«æ•…è²¬ä»»ç²¾ç®—</h2>
                            <div class="space-y-6 divide-y divide-slate-100">
                                <div class="pb-4">
                                    <div class="flex justify-between items-center mb-3">
                                        <h3 class="font-bold text-slate-700 text-lg">çˆ¶æ¯å­é¤Šé‡‘</h3>
                                        <button onclick="addParentRow()" class="text-xs bg-blue-50 text-blue-600 font-bold px-3 py-1 rounded hover:bg-blue-100">+ å¢åŠ </button>
                                    </div>
                                    <div id="parents-container" class="space-y-2"></div>
                                    <div class="text-right text-rose-600 font-bold mt-2 text-base">å°è¨ˆï¼š<span id="total-parents">0 è¬</span></div>
                                </div>
                                <div class="py-4">
                                    <h3 class="font-bold text-slate-700 mb-3 text-lg">é…å¶å­å¥³ç”Ÿæ´»èˆ‡æ•™è‚²</h3>
                                    <div class="grid grid-cols-2 gap-4 mb-4">
                                        <div><label class="text-sm text-slate-500 font-bold block mb-1">æ¯æœˆç”Ÿæ´»è²» (è¬)</label><input type="number" id="living-monthly" class="form-input persist-input" placeholder="0" onkeyup="calculateAll();saveData()"></div>
                                        <div><label class="text-sm text-slate-500 font-bold block mb-1">ç…§é¡§å¹´æ•¸ (å¹´)</label><input type="number" id="living-years" class="form-input persist-input" placeholder="ä¾‹å¦‚: 20" onkeyup="calculateAll();saveData()"></div>
                                    </div>
                                    <div class="flex justify-between items-center mb-2">
                                        <span class="text-base font-bold text-slate-600">å­å¥³æ•™è‚²åŸºé‡‘ (ä¾ç…§è¨­å®šåƒæ•¸)</span>
                                        <button onclick="addChildEduRow()" class="text-xs bg-indigo-50 text-indigo-600 px-3 py-1 rounded font-bold hover:bg-indigo-100">+ å¢åŠ å­å¥³</button>
                                    </div>
                                    <div id="edu-container" class="space-y-3"></div>
                                    <div class="text-right text-rose-600 font-bold mt-2 text-base">å°è¨ˆï¼š<span id="total-living-edu">0 è¬</span></div>
                                </div>
                                <div class="pt-4">
                                    <h3 class="font-bold text-slate-700 mb-3 text-lg">å±…ä½èˆ‡æœ€å¾Œè²»ç”¨</h3>
                                    <div class="grid grid-cols-2 gap-4">
                                        <div><label class="text-sm text-slate-500 font-bold block mb-1">æˆ¿è²¸/ç§Ÿé‡‘æœˆæ”¯ (è¬)</label><input type="number" id="house-monthly" class="form-input persist-input" placeholder="0" onkeyup="calculateAll();saveData()"></div>
                                        <div><label class="text-sm text-slate-500 font-bold block mb-1">å‰©é¤˜å¹´æ•¸ (å¹´)</label><input type="number" id="house-years" class="form-input persist-input" placeholder="0" onkeyup="calculateAll();saveData()"></div>
                                    </div>
                                    <div class="text-right text-rose-600 font-bold mt-2 text-base">å°è¨ˆï¼š<span id="total-house">0 è¬</span></div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="lg:col-span-1">
                        <div class="lg:sticky lg:top-6 bg-slate-800 text-white rounded-2xl p-6 shadow-2xl border border-slate-700">
                            <h4 class="text-xs font-bold opacity-60 mb-2 uppercase tracking-widest text-rose-200">èº«æ•…è²¬ä»»ç¸½ç¼ºå£</h4>
                            <div class="text-4xl md:text-5xl font-black mb-6"><span id="grand-total-gap" data-need="0">0</span><span class="text-xl ml-2">è¬</span></div>
                            
                            <div class="space-y-4">
                                <div class="bg-slate-700/50 p-4 rounded-xl border border-slate-600">
                                    <label class="text-xs opacity-70 block mb-1">æ‰£é™¤ï¼šç¾æœ‰å£½éšª (è¬)</label>
                                    <input type="number" id="existing-insurance-p2" class="w-full bg-transparent border-b border-slate-500 text-white focus:outline-none focus:border-white font-bold text-lg placeholder-slate-500 persist-input" placeholder="0" oninput="syncInsurance(this.value, 'comm-insurance-p3'); saveData()">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="section-retire" class="hidden bg-white p-6 rounded-2xl shadow-lg border-l-8 border-emerald-500 calc-section">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-xl md:text-2xl font-black text-slate-800 flex items-center"><span class="bg-emerald-100 p-2 rounded-lg mr-3 text-emerald-600 text-xl">ğŸŒ…</span> é€€ä¼‘ç”Ÿæ´»è¦åŠƒ</h2>
                        <a href="https://kuantahung.github.io/Retire-in-Real/" target="_blank" class="text-xs bg-emerald-600 text-white px-3 py-1.5 rounded-full hover:bg-emerald-700 shadow flex items-center gap-1"><i class="fas fa-calculator"></i> ç²¾ç®—ç‰ˆ</a>
                    </div>
                    
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                        <div class="space-y-4">
                            <div class="grid grid-cols-2 gap-4">
                                <div><label class="block text-sm font-bold text-slate-500 mb-1">ç›®å‰å¹´é½¡</label><input type="number" id="retire-current-age" class="form-input bg-slate-100 text-slate-500 font-bold" readonly placeholder="--"></div>
                                <div><label class="block text-sm font-bold text-emerald-700 mb-1">é€€ä¼‘å¹´é½¡</label><input type="number" id="retire-target-age" class="form-input border-emerald-300 text-emerald-900 font-bold persist-input" placeholder="ä¾‹å¦‚: 65" onkeyup="calculateAll();saveData()"></div>
                            </div>
                            <div class="grid grid-cols-2 gap-4">
                                <div><label class="block text-sm font-bold text-slate-600 mb-1">é ä¼°å£½å‘½</label><input type="number" id="retire-end-age" class="form-input persist-input" placeholder="ä¾‹å¦‚: 85" onkeyup="calculateAll();saveData()"></div>
                                <div><label class="block text-sm font-bold text-slate-600 mb-1">é€€ä¼‘æœˆèŠ±è²»(è¬)</label><input type="number" id="retire-monthly" class="form-input persist-input" placeholder="ä¾‹å¦‚: 3" onkeyup="calculateAll();saveData()"></div>
                            </div>
                            <div class="bg-slate-50 p-6 rounded-xl text-base space-y-3 border border-slate-200">
                                <div class="flex justify-between"><span class="text-slate-600">æº–å‚™æœŸ (è·é›¢é€€ä¼‘)</span><span class="font-bold text-emerald-600"><span id="retire-years-to-save">0</span> å¹´</span></div>
                                <div class="flex justify-between"><span class="text-slate-600">æé ˜æœŸ (é€€ä¼‘ç”Ÿæ´»)</span><span class="font-bold text-emerald-600"><span id="retire-years-to-live">0</span> å¹´</span></div>
                            </div>
                        </div>
                        <div class="flex flex-col justify-center space-y-4">
                            <div class="bg-emerald-50 rounded-2xl p-6 text-center border border-emerald-100">
                                <div class="text-sm font-bold text-emerald-800 mb-1 uppercase">é€€ä¼‘é‡‘ç¸½éœ€æ±‚ (ä¸å«é€šè†¨)</div>
                                <div class="text-4xl font-black text-emerald-700"><span id="retire-total-needed">0</span> è¬</div>
                            </div>
                            <div class="bg-gradient-to-r from-emerald-600 to-teal-700 rounded-2xl p-6 text-center text-white shadow-xl">
                                <div class="text-base font-bold opacity-80 mb-2">ç¾åœ¨é–‹å§‹ï¼Œæ¯å¹´éœ€å­˜</div>
                                <div class="text-5xl font-black mb-2"><span id="retire-annual-save">0</span> <span class="text-lg">è¬/å¹´</span></div>
                                <div class="text-xs opacity-60 border-t border-white/20 pt-2 mt-2">è¨»ï¼šæ­¤ç‚ºæœªè¨ˆå…¥æŠ•è³‡å ±é…¬ç‡ä¹‹ä¿å®ˆä¼°ç®—</div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="flex justify-center mt-12 pb-12">
                    <button onclick="togglePages('page3')" class="bg-slate-800 text-white px-10 py-4 rounded-xl text-lg font-bold shadow-xl hover:bg-slate-900 transition transform hover:-translate-y-1 w-full md:w-auto">ä¸‹ä¸€æ­¥ï¼šæ”¶æ”¯èˆ‡ç¸½çµ</button>
                </div>
            </div>
        </div>

        <div id="page3" class="container mx-auto py-6 px-4 md:py-10 hidden">
            <div class="max-w-6xl mx-auto space-y-6">
                <div class="flex justify-between items-center mb-4">
                    <button onclick="togglePages('page2')" class="text-slate-500 hover:text-slate-800 font-bold flex items-center bg-white px-4 py-2 rounded-lg shadow-sm border border-slate-200 transition"><i class="fas fa-arrow-left mr-2"></i> è¿”å›ç¼ºå£</button>
                    <div class="text-sm font-bold text-slate-400 font-mono">Step 3/3</div>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <div class="bg-white p-5 md:p-6 rounded-2xl shadow-sm border border-slate-200">
                        <h2 class="text-lg font-bold text-emerald-600 mb-4 flex items-center"><i class="fas fa-wallet mr-2"></i> å¹´åº¦æ”¶å…¥æ¦‚æ³</h2>
                        <table class="w-full financial-table mb-2 mobile-card-table">
                            <thead><tr><th>é …ç›®</th><th>é‡‘é¡ (è¬)</th><th>æ“ä½œ</th></tr></thead>
                            <tbody id="income-body"></tbody>
                        </table>
                        <button onclick="addFlowRow('income')" class="text-xs bg-emerald-50 text-emerald-600 px-4 py-2 rounded-full font-bold mt-2 w-full md:w-auto hover:bg-emerald-100">+ æ–°å¢æ”¶å…¥</button>
                    </div>

                    <div class="bg-white p-5 md:p-6 rounded-2xl shadow-sm border border-slate-200">
                        <h2 class="text-lg font-bold text-red-500 mb-4 flex items-center"><i class="fas fa-file-invoice-dollar mr-2"></i> å¹´åº¦æ”¯å‡ºæ¦‚æ³</h2>
                        <table class="w-full financial-table mb-2 mobile-card-table">
                            <thead><tr><th>é …ç›®</th><th>é‡‘é¡ (è¬)</th><th>æ“ä½œ</th></tr></thead>
                            <tbody id="expense-body"></tbody>
                        </table>
                        <button onclick="addFlowRow('expense')" class="text-xs bg-red-50 text-red-600 px-4 py-2 rounded-full font-bold mt-2 w-full md:w-auto hover:bg-red-100">+ æ–°å¢æ”¯å‡º</button>
                    </div>

                    <div class="bg-slate-800 text-white p-6 rounded-2xl flex justify-between items-center shadow-lg lg:col-span-2">
                        <span class="text-lg opacity-90">å¹´åº¦æ·¨ç¾é‡‘æµ</span>
                        <span id="net-cashflow" class="text-3xl font-black">0 è¬</span>
                    </div>

                    <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-200 lg:col-span-2">
                        <h2 class="text-lg font-bold text-blue-600 mb-4 flex items-center"><i class="fas fa-shield-alt mr-2"></i> ç¤¾æœƒä¿éšªèˆ‡ä¿éšœè©¦ç®—</h2>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                            <div class="bg-slate-50 p-4 rounded-xl border border-slate-100">
                                <label class="text-xs font-bold text-slate-500 block mb-2">å‹ä¿æŠ•ä¿è–ªè³‡ (å…ƒ/æœˆ)</label>
                                <input type="number" id="labor-salary-p3" class="form-input font-bold persist-input" placeholder="ä¾‹å¦‚: 45800" oninput="calculateAll();saveData()">
                                <div class="text-xs font-bold text-blue-600 mt-2 flex justify-between">
                                    <span>èº«æ•…çµ¦ä»˜ï¼š<span id="labor-benefit-val-p3">0</span> è¬</span>
                                </div>
                                <div class="text-[10px] text-slate-400 mt-1">* ä»¥æ™®é€šå‚·ç—…ä¸”å¹´è³‡æ»¿2å¹´(35å€‹æœˆ)ä¼°ç®—</div>
                            </div>
                            <div class="bg-slate-50 p-4 rounded-xl border border-slate-100">
                                <label class="text-xs font-bold text-slate-500 block mb-2">å…¬å¸åœ˜ä¿ / æ’«å¹ (è¬)</label>
                                <input type="number" id="group-insurance-p3" class="form-input persist-input" placeholder="0" oninput="calculateAll();saveData()">
                            </div>
                            <div class="bg-slate-50 p-4 rounded-xl border border-slate-100">
                                <label class="text-xs font-bold text-slate-500 block mb-2">å•†æ¥­å£½éšª (ç¾æœ‰ä¿å–®)</label>
                                <input type="number" id="comm-insurance-p3" class="form-input bg-white persist-input" placeholder="0" oninput="syncInsurance(this.value, 'existing-insurance-p2'); saveData()">
                            </div>
                        </div>
                    </div>
                </div>

                <div class="flex justify-center mt-12 pb-16">
                    <button onclick="generateReport()" class="bg-slate-800 text-white px-12 py-5 rounded-full text-xl font-bold shadow-2xl hover:bg-slate-900 transition-all flex items-center"><i class="fas fa-print mr-3"></i> ç”¢å‡ºå°ˆæ¥­å ±å‘Š</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        /* --- 1. é…ç½®èˆ‡åˆå§‹åŒ– --- */
        const DEFAULT_CONFIG = {
            'pub-k12': 10, 'pri-k12': 30,
            'pub-uni': 25, 'pri-uni': 50,
            'pub-mas': 30, 'pri-mas': 60
        };
        let CONFIG = { ...DEFAULT_CONFIG };

        function initSystem() {
            loadConfig(); 
            loadData();   
            
            if(document.getElementById('income-body').children.length === 0) addFlowRow('income');
            if(document.getElementById('expense-body').children.length === 0) addFlowRow('expense');
            
            calculateAll();
        }

        /* --- 2. è¨­å®šèˆ‡è³‡æ–™æ¸…é™¤ç®¡ç† --- */
        function toggleSettings() {
            const modal = document.getElementById('settings-modal');
            modal.classList.toggle('hidden');
            if(!modal.classList.contains('hidden')) {
                for(let k in CONFIG) document.getElementById(`cfg-${k}`).value = CONFIG[k];
            }
        }
        function saveConfig() {
            for(let k in CONFIG) {
                const val = parseFloat(document.getElementById(`cfg-${k}`).value);
                if(!isNaN(val)) CONFIG[k] = val;
            }
            localStorage.setItem('pwm_config', JSON.stringify(CONFIG));
            calculateAll();
            toggleSettings();
        }
        function loadConfig() {
            const saved = localStorage.getItem('pwm_config');
            if(saved) CONFIG = { ...DEFAULT_CONFIG, ...JSON.parse(saved) };
        }
        function resetDefaultConfig() {
            if(confirm('ç¢ºå®šè¦æ¢å¾©é è¨­åƒæ•¸å—ï¼Ÿ')) {
                CONFIG = { ...DEFAULT_CONFIG };
                for(let k in CONFIG) document.getElementById(`cfg-${k}`).value = CONFIG[k];
            }
        }
        
        // æ–°å¢ï¼šæ¸…é™¤æ‰€æœ‰è³‡æ–™
        function clearAllData() {
            if(confirm('ç¢ºå®šè¦æ¸…é™¤æ‰€æœ‰è¼¸å…¥çš„è³‡æ–™å—ï¼Ÿ(æ­¤å‹•ä½œç„¡æ³•å¾©åŸ)')) {
                localStorage.removeItem('pwm_data_static');
                localStorage.removeItem('pwm_data_dynamic');
                location.reload(); // é‡æ–°æ•´ç†é é¢ä»¥å›æ­¸é è¨­å€¼
            }
        }

        /* --- 3. è³‡æ–™å­˜å– (localStorage) --- */
        function saveData() {
            const data = {};
            document.querySelectorAll('.persist-input').forEach(el => {
                if(el.type === 'checkbox' || el.type === 'radio') {
                    if(el.checked) data[el.id || el.name] = el.value; 
                    if(el.type === 'checkbox') data[el.id] = el.checked;
                } else {
                    data[el.id] = el.value;
                }
            });
            
            const dynamicData = {
                parents: [], children: [], income: [], expense: [], family: []
            };
            
            // Family members (excluding main)
            document.querySelectorAll('.family-member-row').forEach(row => {
                dynamicData.family.push({
                    relation: row.querySelector('.relation-input').value,
                    name: row.querySelector('.name-input').value,
                    dob: row.querySelector('.dob-input').value
                });
            });

            // Parents
            document.querySelectorAll('.parent-row').forEach(row => {
                dynamicData.parents.push({
                    type: row.querySelector('.p-type').value,
                    age: row.querySelector('.p-age').value,
                    money: row.querySelector('.p-money').value
                });
            });
            // Children
            document.querySelectorAll('.child-edu-row').forEach(row => {
                dynamicData.children.push({
                    age: row.querySelector('.c-age').value,
                    degree: row.querySelector('.c-degree').value,
                    type: row.querySelector('.c-type:checked').value
                });
            });
            // Flows
            ['income', 'expense'].forEach(type => {
                document.querySelectorAll(`.${type}-select`).forEach((sel, idx) => {
                    const row = sel.closest('tr');
                    dynamicData[type].push({
                        name: sel.value,
                        amount: row.querySelector(`.${type}-amount`).value
                    });
                });
            });

            localStorage.setItem('pwm_data_static', JSON.stringify(data));
            localStorage.setItem('pwm_data_dynamic', JSON.stringify(dynamicData));
        }

        function loadData() {
            try {
                const staticData = JSON.parse(localStorage.getItem('pwm_data_static'));
                if(staticData) {
                    for(let id in staticData) {
                        const el = document.getElementById(id);
                        if(el) {
                            if(el.type === 'checkbox') el.checked = staticData[id];
                            else el.value = staticData[id];
                        }
                    }
                    syncPage2Visibility();
                }

                const dynamicData = JSON.parse(localStorage.getItem('pwm_data_dynamic'));
                if(dynamicData) {
                    if(dynamicData.family) {
                        const container = document.getElementById('family-container');
                        container.querySelectorAll('.family-member-row').forEach(e => e.remove());
                        dynamicData.family.forEach(f => {
                            addFamilyMember(); 
                            const rows = container.querySelectorAll('.family-member-row');
                            const lastRow = rows[rows.length - 1];
                            lastRow.querySelector('.relation-input').value = f.relation;
                            lastRow.querySelector('.name-input').value = f.name;
                            lastRow.querySelector('.dob-input').value = f.dob;
                            updateAge(lastRow.querySelector('.dob-input'));
                        });
                    }

                    document.getElementById('parents-container').innerHTML = '';
                    dynamicData.parents.forEach(p => addParentRow(p.type, p.age, p.money));
                    
                    document.getElementById('edu-container').innerHTML = '';
                    dynamicData.children.forEach(c => addChildEduRow(c.age, c.degree, c.type));
                    
                    document.getElementById('income-body').innerHTML = '';
                    dynamicData.income.forEach(i => addFlowRow('income', i.name, i.amount));
                    
                    document.getElementById('expense-body').innerHTML = '';
                    dynamicData.expense.forEach(e => addFlowRow('expense', e.name, e.amount));
                }
            } catch(e) { console.log('No saved data or error loading'); }
            
            const dobInput = document.getElementById('main-dob');
            if(dobInput.value) updateAge(dobInput);
        }

        /* --- 4. æ ¸å¿ƒé‚è¼¯ --- */
        function updateAge(input) {
            if (!input.value) return;

            const parts = input.value.split('-');
            const birthYear = parseInt(parts[0]);
            const birthMonth = parseInt(parts[1]) - 1; 
            const birthDay = parseInt(parts[2]);
            
            const today = new Date();
            let months = (today.getFullYear() - birthYear) * 12 + (today.getMonth() - birthMonth);
            
            if (today.getDate() < birthDay) months--;

            const insAge = Math.floor(months / 12) + (months % 12 >= 6 ? 1 : 0);

            const row = input.closest('.grid'); 
            if (row) {
                const displayEl = row.querySelector('.age-display');
                if (displayEl) {
                    displayEl.innerText = insAge + " æ­²";
                    displayEl.classList.add('highlight-update');
                    setTimeout(() => displayEl.classList.remove('highlight-update'), 1000);
                }
            }

            if (input.id === 'main-dob') {
                document.getElementById('main-user-age-value').value = insAge;
                document.getElementById('retire-current-age').value = insAge;
                calculateAll(); 
            }
            saveData();
        }

        function addFamilyMember() {
            const container = document.getElementById('family-container');
            const div = document.createElement('div');
            div.className = "grid grid-cols-1 md:grid-cols-12 gap-4 items-end bg-slate-50 p-5 rounded-2xl border border-slate-200 relative animate-fade-in family-member-row";
            
            div.innerHTML = `
                <div class="md:col-span-2">
                    <label class="block text-xs font-bold text-slate-500 mb-1">é—œä¿‚</label>
                    <select class="form-input relation-input persist-input" onchange="saveData()"><option>é…å¶</option><option>å­å¥³</option><option>çˆ¶æ¯</option></select>
                </div>
                <div class="md:col-span-3">
                    <label class="block text-xs font-bold text-slate-500 mb-1">å§“å</label>
                    <input type="text" class="form-input name-input" onchange="saveData()">
                </div>
                <div class="md:col-span-4">
                    <label class="block text-xs font-bold text-slate-500 mb-1">å‡ºç”Ÿå¹´æœˆæ—¥</label>
                    <input type="date" class="form-input dob-input" onchange="updateAge(this)">
                </div>
                <div class="md:col-span-3 relative">
                    <label class="block text-xs font-bold text-slate-500 mb-1">ä¿éšªå¹´é½¡</label>
                    <div class="bg-white p-3 rounded-lg text-center font-bold text-slate-800 border border-slate-200 age-display">-- æ­²</div>
                    <button onclick="this.closest('.grid').remove();saveData()" class="absolute -top-2 -right-2 bg-red-500 text-white w-6 h-6 rounded-full text-xs shadow-md hover:bg-red-600 transition">Ã—</button>
                </div>
            `;
            container.appendChild(div);
        }

        function syncInsurance(val, targetId) {
            const target = document.getElementById(targetId);
            if(target && target.value !== val) {
                target.value = val;
            }
            calculateAll();
        }

        function togglePages(pageId) {
            document.querySelectorAll('[id^="page"]').forEach(el => el.classList.add('hidden'));
            document.getElementById(pageId).classList.remove('hidden');
            window.scrollTo(0, 0);
            if (pageId === 'page2') syncPage2Visibility();
        }

        function syncPage2Visibility() {
            const map = {'check-sick': 'section-sick', 'check-disability': 'section-disability', 'check-death': 'section-death', 'check-retire': 'section-retire'};
            for (let [cbId, secId] of Object.entries(map)) {
                const el = document.getElementById(secId);
                if(document.getElementById(cbId).checked) el.classList.remove('hidden'); 
                else el.classList.add('hidden');
            }
        }

        function calculateAll() {
            const fmt = n => parseFloat(n).toLocaleString('en-US');
            const clean = str => parseFloat(String(str).replace(/,/g, '')) || 0;

            // 1. Sick
            document.querySelectorAll('.calc-row-sick').forEach(row => {
                const t = clean(row.querySelector('.sick-target').value);
                const c = clean(row.querySelector('.sick-current').value);
                row.querySelector('.sick-gap').innerText = fmt(Math.max(0, t - c)) + " è¬";
            });

            // 2. Disability
            const disT = clean(document.getElementById('dis-target').value);
            const disC = clean(document.getElementById('dis-current').value);
            document.getElementById('dis-gap').innerHTML = `${fmt(Math.max(0, disT - disC))} <span class="text-lg">è¬/æœˆ</span>`;

            // 3. Retire
            const rCur = clean(document.getElementById('retire-current-age').value);
            const rTarVal = document.getElementById('retire-target-age').value;
            const rTar = rTarVal ? clean(rTarVal) : 65;
            
            const rEndVal = document.getElementById('retire-end-age').value;
            const rEnd = rEndVal ? clean(rEndVal) : 85;
            
            const rMon = clean(document.getElementById('retire-monthly').value);
            
            const yrSave = Math.max(0, rTar - rCur);
            const yrLive = Math.max(0, rEnd - rTar);
            document.getElementById('retire-years-to-save').innerText = yrSave;
            document.getElementById('retire-years-to-live').innerText = yrLive;

            const rTotal = rMon * 12 * yrLive;
            document.getElementById('retire-total-needed').innerText = fmt(Math.round(rTotal));
            
            const rAnnual = yrSave > 0 ? rTotal / yrSave : rTotal;
            document.getElementById('retire-annual-save').innerText = fmt(rAnnual.toFixed(1));

            // 4. Death
            let pTotal = 0;
            document.querySelectorAll('.parent-row').forEach(r => {
                const m = clean(r.querySelector('.p-money').value);
                const endAge = parseFloat(r.querySelector('.p-type').value);
                const curAge = clean(r.querySelector('.p-age').value);
                pTotal += m * 12 * Math.max(0, endAge - curAge);
            });
            document.getElementById('total-parents').innerText = fmt(Math.round(pTotal));

            const houseTotal = clean(document.getElementById('house-monthly').value) * 12 * clean(document.getElementById('house-years').value);
            document.getElementById('total-house').innerText = fmt(Math.round(houseTotal));

            const tLiving = clean(document.getElementById('living-monthly').value) * 12 * clean(document.getElementById('living-years').value);
            let tEdu = 0;
            document.querySelectorAll('.child-edu-row').forEach(r => {
                const a = clean(r.querySelector('.c-age').value);
                const d = parseFloat(r.querySelector('.c-degree').value);
                const type = r.querySelector('.c-type:checked').value;
                
                const k12Cost = type === 'public' ? CONFIG['pub-k12'] : CONFIG['pri-k12'];
                const uniCost = type === 'public' ? CONFIG['pub-uni'] : CONFIG['pri-uni'];
                const masCost = type === 'public' ? CONFIG['pub-mas'] : CONFIG['pri-mas'];

                if(a < 18 && d >= 18) tEdu += (18 - a) * k12Cost;
                if(a < 22 && d >= 22) tEdu += (22 - Math.max(18, a)) * uniCost;
                if(a < 24 && d >= 24) tEdu += (24 - Math.max(22, a)) * masCost;
            });
            document.getElementById('total-living-edu').innerText = fmt(Math.round(tLiving + tEdu));

            const deathNeed = pTotal + tLiving + tEdu + houseTotal;
            
            const laborSalary = clean(document.getElementById('labor-salary-p3').value);
            const laborBenefit = Math.round(laborSalary * 35 / 10000); 
            document.getElementById('labor-benefit-val-p3').innerText = fmt(laborBenefit);

            const group = clean(document.getElementById('group-insurance-p3').value);
            const comm = clean(document.getElementById('comm-insurance-p3').value);
            
            const deathGap = Math.max(0, deathNeed - (laborBenefit + group + comm));
            document.getElementById('grand-total-gap').innerText = fmt(Math.round(deathGap));
            document.getElementById('grand-total-gap').setAttribute('data-need', deathNeed);

            // 5. Cashflow
            let inc = 0, exp = 0;
            document.querySelectorAll('.income-amount').forEach(i => inc += clean(i.value));
            document.querySelectorAll('.expense-amount').forEach(i => exp += clean(i.value));
            const net = inc - exp;
            const netEl = document.getElementById('net-cashflow');
            netEl.innerText = fmt(net) + " è¬";
            netEl.className = `text-3xl font-black ${net >= 0 ? 'text-emerald-400' : 'text-red-400'}`;

            updateExpenseRow('æˆ¿è²¸/æˆ¿ç§Ÿ', clean(document.getElementById('house-monthly').value) * 12);
            updateExpenseRow('å­è¦ªè²»', clean(document.querySelector('.p-money')?.value || 0) * 12);
        }

        /* --- 5. å‹•æ…‹åˆ—è¡¨ç®¡ç† (Parents, Children, Flows) --- */
        function addParentRow(typeVal, ageVal, moneyVal) {
            const div = document.createElement('div');
            div.className = "parent-row flex gap-2 items-center text-sm mb-2";
            div.innerHTML = `<select class="p-type border rounded p-2"><option value="76">çˆ¶(å¹³å‡å£½å‘½76)</option><option value="84">æ¯(å¹³å‡å£½å‘½84)</option></select><input type="number" class="p-age border rounded p-2 w-20" placeholder="æ­²" onchange="saveData()"><input type="number" class="p-money border rounded p-2 w-24" placeholder="æœˆ(è¬)" onkeyup="calculateAll();saveData()" onchange="saveData()"><button onclick="this.parentElement.remove();calculateAll();saveData()" class="text-red-500 px-2"><i class="fas fa-trash"></i></button>`;
            document.getElementById('parents-container').appendChild(div);
            if(typeVal) div.querySelector('.p-type').value = typeVal;
            if(ageVal) div.querySelector('.p-age').value = ageVal;
            if(moneyVal) div.querySelector('.p-money').value = moneyVal;
        }

        function addChildEduRow(ageVal, degreeVal, typeVal) {
            const ts = Date.now() + Math.random();
            const div = document.createElement('div');
            div.className = "child-edu-row bg-slate-50 p-3 rounded-lg text-sm border border-slate-200";
            div.innerHTML = `<div class="flex gap-2 mb-2"><input type="number" class="c-age w-full border rounded p-2" placeholder="æ­²" onkeyup="calculateAll();saveData()" onchange="saveData()"><select class="c-degree w-full border rounded p-2" onchange="calculateAll();saveData()"><option value="22">è‡³å¤§å­¸ç•¢æ¥­(22æ­²)</option><option value="24">è‡³ç¢©å£«ç•¢æ¥­(24æ­²)</option></select></div><div class="flex justify-between items-center"><div class="space-x-3"><label class="inline-flex items-center"><input type="radio" name="e_${ts}" value="public" class="c-type mr-1" onchange="calculateAll();saveData()">å…¬ç«‹</label><label class="inline-flex items-center"><input type="radio" name="e_${ts}" value="private" class="c-type mr-1" checked onchange="calculateAll();saveData()">ç§ç«‹</label></div><button onclick="this.closest('.child-edu-row').remove();calculateAll();saveData()" class="text-red-400 text-xs font-bold">åˆªé™¤</button></div>`;
            document.getElementById('edu-container').appendChild(div);
            if(ageVal) div.querySelector('.c-age').value = ageVal;
            if(degreeVal) div.querySelector('.c-degree').value = degreeVal;
            if(typeVal) div.querySelector(`input[value="${typeVal}"]`).checked = true;
        }

        function addFlowRow(type, name, amount) {
            const tbody = document.getElementById(type + '-body');
            const tr = document.createElement('tr');
            const masterList = type === 'income' ? ['è–ªè³‡æ”¶å…¥', 'å¹´çµ‚çé‡‘', 'è‚¡åˆ©', 'ç§Ÿé‡‘', 'å…¼è·', 'æŠ•è³‡', 'å…¶ä»–'] : ['ç”Ÿæ´»é–‹éŠ·', 'äº¤é€š', 'æˆ¿è²¸/æˆ¿ç§Ÿ', 'ä¿éšª', 'å­è¦ªè²»', 'æ•™è‚²', 'å¨›æ¨‚', 'é›œæ”¯', 'å…¶ä»–'];
            let opts = masterList.map(o => `<option value="${o}">${o}</option>`).join('');
            
            tr.innerHTML = `<td data-label="é …ç›®"><select class="form-input ${type}-select" onchange="saveData()">${opts}</select></td><td data-label="é‡‘é¡"><input type="number" class="form-input ${type}-amount" placeholder="0" onkeyup="calculateAll();saveData()" onchange="saveData()"></td><td class="action-col"><button onclick="this.closest('tr').remove();calculateAll();saveData()" class="text-slate-400 hover:text-red-500"><i class="fas fa-trash"></i></button></td>`;
            tbody.appendChild(tr);
            if(name) {
                const sel = tr.querySelector('select');
                if(![...sel.options].some(o => o.value === name)) {
                    const o = document.createElement('option'); o.value = name; o.text = name; sel.add(o);
                }
                sel.value = name;
            }
            if(amount) tr.querySelector('input').value = amount;
        }

        function updateExpenseRow(name, val) {
            if (!val || val === 0) return;
            let found = false;
            document.querySelectorAll('#expense-body tr').forEach(row => {
                if(row.querySelector('select')?.value === name) {
                    row.querySelector('input').value = Math.round(val);
                    found = true;
                }
            });
            if (!found) addFlowRow('expense', name, Math.round(val));
        }

        /* --- 6. å ±å‘Šç”Ÿæˆ (Async/Await) --- */
        async function generateReport() {
            calculateAll();
            const overlay = document.getElementById('loading-overlay');
            overlay.style.display = 'flex';

            try {
                const name = document.getElementById('main-name').value || 'è²´è³“';
                const date = new Date().toLocaleDateString('zh-TW');
                const clean = str => parseFloat(String(str).replace(/,/g, '').replace(/[^\d.-]/g, '')) || 0;
                
                let sickGap = 0; document.querySelectorAll('.sick-gap').forEach(e => sickGap += clean(e.innerText));
                const disGap = document.getElementById('dis-gap').innerText;
                const deathGap = document.getElementById('grand-total-gap').innerText + " è¬";
                const retireGap = document.getElementById('retire-annual-save').innerText + " è¬/å¹´";
                
                const deathNeed = document.getElementById('grand-total-gap').getAttribute('data-need');
                const labor = document.getElementById('labor-benefit-val-p3').innerText;
                const group = document.getElementById('group-insurance-p3').value || 0;
                const comm = document.getElementById('comm-insurance-p3').value || 0;

                let inc = 0, exp = 0;
                document.querySelectorAll('.income-amount').forEach(i => inc += clean(i.value));
                document.querySelectorAll('.expense-amount').forEach(i => exp += clean(i.value));
                const net = inc - exp;
                const netFmt = net.toLocaleString('en-US');

                const chartImg = await generateChartAsync(deathNeed, labor, group, comm);

                let suggestionHTML = '';
                if (net > 0) {
                    suggestionHTML = `
                        <div style="margin-bottom: 20px;">
                            <strong style="color:#059669; font-size: 16px;">ğŸŸ¢ è²¡å‹™å¥åº·è¨ºæ–·ï¼šæ­£å‘çµé¤˜</strong>
                            <p style="margin-top:5px;">æ­å–œæ‚¨ï¼æ‚¨çš„å¹´åº¦æ”¶æ”¯ç‹€æ³è‰¯å¥½ï¼Œæ“æœ‰è‡ªç”±ç¾é‡‘æµã€‚é€™ç‚ºæ‚¨çš„è³‡ç”¢é…ç½®æä¾›äº†çµ•ä½³çš„åŸºç¤ã€‚</p>
                        </div>
                        <div style="background:#f8fafc; padding:15px; border-radius:8px; border-left:4px solid #0f172a;">
                            <strong style="color:#0f172a;">ğŸ’¡ å°ˆå®¶è¦åŠƒå»ºè­°</strong>
                            <ol style="margin-top:10px; margin-left:20px; line-height:1.8;">
                                <li><strong>å„ªå…ˆå»ºæ§‹é˜²è­·ç¶²</strong>ï¼šå°‡éƒ¨åˆ†ç›ˆé¤˜æŠ•å…¥è£œè¶³é†«ç™‚èˆ‡èº«æ•…ç¼ºå£ï¼Œç¢ºä¿è³‡ç”¢ä¸å› é¢¨éšªè€Œç¸®æ°´ã€‚</li>
                                <li><strong>å°ˆæ¬¾å°ˆç”¨é€€ä¼‘é‡‘</strong>ï¼šå–„ç”¨æ™‚é–“è¤‡åˆ©ï¼Œææ—©å•Ÿå‹•é€€ä¼‘å„²è“„è¨ˆåŠƒã€‚</li>
                                <li><strong>è³‡ç”¢å¢å€¼</strong>ï¼šå‰©é¤˜è³‡é‡‘å¯é€²è¡Œç©©å¥æŠ•è³‡ï¼Œå°æŠ—é€šè²¨è†¨è„¹ã€‚</li>
                            </ol>
                        </div>`;
                } else {
                    suggestionHTML = `
                        <div style="margin-bottom: 20px;">
                            <strong style="color:#dc2626; font-size: 16px;">ğŸ”´ è²¡å‹™å¥åº·è¨ºæ–·ï¼šéœ€è¦èª¿æ•´</strong>
                            <p style="margin-top:5px;">ç›®å‰çš„å¹´åº¦æ”¶æ”¯å‘ˆç¾ç·Šç¹ƒç‹€æ…‹ã€‚ç†è²¡çš„ç¬¬ä¸€æ­¥æ˜¯ã€Œæ”¶æ”¯å¹³è¡¡ã€ï¼Œé€™å°‡æ˜¯æˆ‘å€‘é¦–è¦è§£æ±ºçš„èª²é¡Œã€‚</p>
                        </div>
                        <div style="background:#fff1f2; padding:15px; border-radius:8px; border-left:4px solid #dc2626;">
                            <strong style="color:#991b1b;">ğŸ’¡ å°ˆå®¶è¦åŠƒå»ºè­°</strong>
                            <ol style="margin-top:10px; margin-left:20px; line-height:1.8;">
                                <li><strong>ç¾é‡‘æµæª¢è¦–</strong>ï¼šå”åŠ©æ‚¨æª¢è¦–æ”¯å‡ºæ˜ç´°ï¼Œæ‰¾å‡ºèª¿æ•´ç©ºé–“ã€‚</li>
                                <li><strong>åŸºç¤ä¿éšœå„ªå…ˆ</strong>ï¼šåœ¨é ç®—æœ‰é™ä¸‹ï¼Œå„ªå…ˆè¦åŠƒé«˜æ§“æ¡¿çš„å®šæœŸå£½éšªèˆ‡å¯¦æ”¯å¯¦ä»˜ã€‚</li>
                                <li><strong>é¢¨éšªè½‰å«</strong>ï¼šé¿å…å› çªç™¼ç–¾ç—…å°è‡´å®¶åº­è²¡å‹™å´©æ½°ï¼Œä¿éšœæ˜¯ç‚ºäº†ç•™ä½æ¯ä¸€åˆ†éŒ¢ã€‚</li>
                            </ol>
                        </div>`;
                }

                const htmlContent = `
                    <html>
                    <head>
                        <title>ä¿éšœåˆ†æå ±å‘Š - ${name}</title>
                        <style>
                            @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700;900&display=swap');
                            body { font-family: 'Noto Sans TC', sans-serif; background: #525252; margin: 0; padding: 20px; }
                            .page { width: 210mm; min-height: 297mm; background: white; margin: 0 auto 20px auto; padding: 20mm; box-sizing: border-box; position: relative; }
                            .cover { background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%); color: white; display:flex; flex-direction:column; justify-content:center; }
                            h1, h2, h3 { margin: 0; }
                            .print-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 30px; }
                            .card { border: 1px solid #e2e8f0; padding: 15px; border-radius: 8px; }
                            .table { width: 100%; border-collapse: collapse; margin-bottom: 20px; font-size: 13px; }
                            .table th { background: #f1f5f9; padding: 8px; text-align: left; border-bottom: 2px solid #cbd5e1; }
                            .table td { padding: 8px; border-bottom: 1px solid #e2e8f0; }
                            @media print {
                                body { background: white; padding: 0; }
                                .page { margin: 0; width: 100%; height: 100vh; page-break-after: always; }
                                .no-print { display: none; }
                                * { -webkit-print-color-adjust: exact !important; print-color-adjust: exact !important; }
                            }
                        </style>
                    </head>
                    <body>
                        <div class="page cover">
                            <div style="border-left: 10px solid #d4af37; padding-left: 30px;">
                                <div style="font-size: 24px; opacity: 0.8; margin-bottom: 15px; font-weight: 300; letter-spacing: 1px;">Your wealth guidance to the future</div>
                                <h1 style="font-size: 48px; margin-bottom: 20px; font-weight: 900;">å…¨æ–¹ä½<br>è²¡å¯Œä¿éšœå ±å‘Š</h1>
                            </div>
                            <div style="margin-top: 100px; padding-left: 40px;">
                                <p style="opacity: 0.7; font-size: 14px;">PREPARED FOR</p>
                                <h2 style="font-size: 36px; margin-bottom: 10px;">${name} è²´è³“</h2>
                                <p style="opacity: 0.7;">æ—¥æœŸï¼š${date}</p>
                            </div>
                        </div>

                        <div class="page">
                            <h2 style="border-bottom: 3px solid #0f172a; padding-bottom: 10px; margin-bottom: 30px;">é¢¨éšªç¼ºå£ç¸½è¦½</h2>
                            <div class="print-grid">
                                <div class="card"><div style="color:#64748b; font-weight:bold;">é†«ç™‚è²»ç”¨ç¼ºå£</div><div style="font-size:24px; color:#ef4444; font-weight:bold;">${parseFloat(sickGap).toLocaleString()} è¬</div></div>
                                <div class="card"><div style="color:#64748b; font-weight:bold;">å¤±èƒ½ç…§è­·æœˆç¼ºå£</div><div style="font-size:24px; color:#f59e0b; font-weight:bold;">${disGap}</div></div>
                                <div class="card"><div style="color:#64748b; font-weight:bold;">èº«æ•…è²¬ä»»ç¼ºå£</div><div style="font-size:24px; color:#0f172a; font-weight:bold;">${deathGap}</div></div>
                                <div class="card" style="background:#fffbeb; border-color:#d4af37;"><div style="color:#b45309; font-weight:bold;">é€€ä¼‘æº–å‚™å¹´å„²è“„</div><div style="font-size:24px; color:#d97706; font-weight:bold;">${retireGap}</div></div>
                            </div>

                            <h3 style="background:#0f172a; color:white; padding:10px; border-radius:4px; font-size:16px; margin-bottom:15px;">èº«æ•…ä¿éšœçµæ§‹åˆ†æ</h3>
                            <table class="table">
                                <tr><th>ä¿éšœä¾†æº</th><th>é ä¼°é‡‘é¡</th><th>å‚™è¨»</th></tr>
                                <tr><td><strong>å®¶åº­ç¸½è²¬ä»»</strong></td><td><strong>${parseFloat(deathNeed).toLocaleString()} è¬</strong></td><td>æˆ¿è²¸ã€æ•™è‚²ã€ç”Ÿæ´»è²»ç¸½å’Œ</td></tr>
                                <tr><td>(-) å‹ä¿èº«æ•…çµ¦ä»˜</td><td style="color:#059669;">- ${labor} è¬</td><td>ä»¥æ™®é€šå‚·ç—…æ»¿2å¹´ä¼°ç®—</td></tr>
                                <tr><td>(-) å…¬å¸åœ˜ä¿/æ’«å¹</td><td style="color:#059669;">- ${parseFloat(group).toLocaleString()} è¬</td><td></td></tr>
                                <tr><td>(-) æ—¢æœ‰å•†æ¥­å£½éšª</td><td style="color:#059669;">- ${parseFloat(comm).toLocaleString()} è¬</td><td></td></tr>
                                <tr style="background:#fee2e2; color:#b91c1c; font-weight:bold;"><td>éœ€å¢è£œç¼ºå£</td><td>${deathGap}</td><td></td></tr>
                            </table>

                            <div style="margin-top:40px; text-align:center;">
                                <div style="font-weight:bold; margin-bottom:15px; color:#475569;">ç”Ÿå‘½é€±æœŸè²¬ä»»éæ¸›åœ–</div>
                                <img src="${chartImg}" style="width:100%; max-height:400px; border:1px solid #eee;">
                            </div>
                        </div>

                        <div class="page">
                            <h2 style="border-bottom: 3px solid #0f172a; padding-bottom: 10px; margin-bottom: 30px;">è²¡å‹™æ”¶æ”¯èˆ‡å»ºè­°</h2>
                            
                            <div class="print-grid">
                                <div>
                                    <div style="background:#059669; color:white; padding:5px 10px; font-weight:bold; border-radius:4px 4px 0 0;">å¹´åº¦æ”¶å…¥</div>
                                    <div style="border:1px solid #059669; padding:15px; text-align:center; font-size:20px; font-weight:bold; border-radius:0 0 4px 4px;">${parseFloat(inc).toLocaleString()} è¬</div>
                                </div>
                                <div>
                                    <div style="background:#dc2626; color:white; padding:5px 10px; font-weight:bold; border-radius:4px 4px 0 0;">å¹´åº¦æ”¯å‡º</div>
                                    <div style="border:1px solid #dc2626; padding:15px; text-align:center; font-size:20px; font-weight:bold; border-radius:0 0 4px 4px;">${parseFloat(exp).toLocaleString()} è¬</div>
                                </div>
                            </div>
                            
                            <div style="background:#f1f5f9; padding:20px; border-radius:8px; margin-bottom:30px; display:flex; justify-content:space-between; align-items:center;">
                                <span style="font-weight:bold; color:#475569;">å¹´åº¦æ·¨ç¾é‡‘æµ</span>
                                <span style="font-size:28px; font-weight:900; color:${net>=0 ? '#059669' : '#dc2626'}">${netFmt} è¬</span>
                            </div>

                            <div style="margin-top: 20px;">
                                ${suggestionHTML}
                            </div>
                            
                            <div style="margin-top: auto; padding-top: 50px; text-align: center; color: #94a3b8; font-size: 12px;">
                                æ­¤å ±å‘Šåƒ…ä¾›ä¿éšªè¦åŠƒåƒè€ƒï¼Œå¯¦éš›ç†è³ é‡‘é¡ä»¥ä¿å–®æ¢æ¬¾ç‚ºæº–ã€‚
                            </div>
                        </div>
                    </body>
                    </html>
                `;

                const newWin = window.open('', '_blank');
                if(!newWin) throw new Error("è«‹å…è¨±å½ˆå‡ºè¦–çª—");
                newWin.document.write(htmlContent);
                newWin.document.close();
                
                newWin.onload = function() {
                    setTimeout(() => {
                        overlay.style.display = 'none';
                        newWin.focus();
                        newWin.print();
                    }, 500);
                };

            } catch (e) {
                alert('å ±å‘Šç”¢å‡ºå¤±æ•—ï¼š' + e.message);
                overlay.style.display = 'none';
            }
        }

        function generateChartAsync(needVal, laborVal, groupVal, commVal) {
            return new Promise((resolve) => {
                const ctx = document.getElementById('hidden-chart-canvas').getContext('2d');
                const age = parseInt(document.getElementById('main-user-age-value').value) || 30;
                // è‹¥æœªå¡«é€€ä¼‘å¹´é½¡ï¼Œé è¨­65ç•«åœ–ç”¨
                const retireAgeVal = document.getElementById('retire-target-age').value;
                const retireAge = retireAgeVal ? parseInt(retireAgeVal) : 65;

                const totalCov = (parseFloat(String(laborVal).replace(/,/g,'')) || 0) + parseFloat(groupVal) + parseFloat(commVal);
                const startNeed = parseFloat(needVal) || 0;

                const labels = [];
                const needData = [];
                const existData = [];

                for(let y = age; y <= retireAge; y++) {
                    labels.push(y);
                    let decay = 1 - ((y - age) / (retireAge - age));
                    needData.push(Math.round(startNeed * decay));
                    existData.push(totalCov);
                }

                if(window.pdfChart) window.pdfChart.destroy();

                window.pdfChart = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: labels,
                        datasets: [
                            { label: 'å®¶åº­è²¬ä»»éæ¸›', data: needData, backgroundColor: 'rgba(59, 130, 246, 0.5)', order: 2 },
                            { label: 'ç¾æœ‰ä¿éšœ', data: existData, type: 'line', borderColor: '#10b981', borderWidth: 3, pointRadius: 0, order: 1 }
                        ]
                    },
                    options: {
                        animation: {
                            onComplete: function() {
                                resolve(document.getElementById('hidden-chart-canvas').toDataURL());
                            }
                        },
                        responsive: false,
                        scales: {
                            y: { beginAtZero: true }
                        }
                    }
                });
            });
        }
    </script>
</body>
</html>
