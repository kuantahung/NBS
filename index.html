<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å€å®‰ä¿éšªéœ€æ±‚åˆ†æç³»çµ± Pro (2026 æ™ºæ…§é€£å‹•ç‰ˆ)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@100;300;400;500;700;900&display=swap" rel="stylesheet">
    <style>
        /* --- ç³»çµ±ä»‹é¢æ¨£å¼ (Web UI) --- */
        body { font-family: 'Noto Sans TC', sans-serif; background-color: #f8fafc; color: #334155; overflow-x: hidden; -webkit-tap-highlight-color: transparent; }
        .gradient-bg { background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%); }
        .glass-card { background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(20px); border: 1px solid rgba(255,255,255,0.5); box-shadow: 0 10px 40px -10px rgba(0,0,0,0.1); }
        input[type="number"]::-webkit-inner-spin-button { -webkit-appearance: none; }
        .hidden { display: none !important; }
        .animate-fade-in { animation: fadeIn 0.4s cubic-bezier(0.4, 0, 0.2, 1); }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* ä»‹é¢è¡¨æ ¼èˆ‡è¼¸å…¥æ¡† */
        .financial-table th { background-color: transparent; color: #64748b; padding: 12px; font-size: 0.9rem; border-bottom: 2px solid #e2e8f0; font-weight: 700; white-space: nowrap; text-align: left; }
        .financial-table td { padding: 12px; border-bottom: 1px solid #f1f5f9; vertical-align: middle; }
        .form-input { width: 100%; background: #fff; border: 1px solid #e2e8f0; border-radius: 8px; padding: 10px 12px; font-size: 1rem; color: #1e293b; transition: all 0.2s ease; }
        .form-input:focus { border-color: #94a3b8; box-shadow: 0 0 0 3px rgba(148, 163, 184, 0.1); outline: none; }
        .form-input::placeholder { color: #cbd5e1; font-weight: 300; }
        
        /* ç¤¾ä¿é¸å–® */
        .si-select { background-color: #fff; border: 1px solid #e2e8f0; border-radius: 8px; padding: 8px 12px; font-size: 0.95rem; font-weight: 500; color: #334155; width: 100%; margin-bottom: 8px; cursor: pointer; transition: all 0.2s; -webkit-appearance: none; appearance: none; background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%236b7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e"); background-position: right 0.5rem center; background-repeat: no-repeat; background-size: 1.5em 1.5em; }
        .si-select:hover { border-color: #94a3b8; }
        
        /* é€£çµæ¨£å¼ */
        .salary-table-link { font-size: 0.8rem; color: #64748b; text-decoration: none; display: inline-flex; align-items: center; margin-top: 6px; transition: color 0.2s; font-weight: 500; }
        .salary-table-link:hover { color: #0f172a; }

        /* å¡ç‰‡æ¨£å¼ */
        .need-card { height: 280px; border-radius: 16px; overflow: hidden; transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); border: 2px solid transparent; }
        .need-card:hover { transform: translateY(-4px); box-shadow: 0 12px 30px -8px rgba(0, 0, 0, 0.15); }

        /* Loading */
        #loading-overlay { display: none; position: fixed; inset: 0; background: rgba(255,255,255,0.9); z-index: 100000; justify-content: center; align-items: center; flex-direction: column; backdrop-filter: blur(5px); }
        .spinner { border: 3px solid rgba(15, 23, 42, 0.1); border-radius: 50%; border-top: 3px solid #0f172a; width: 40px; height: 40px; animation: spin 0.8s linear infinite; margin-bottom: 20px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* RWD */
        @media (min-width: 768px) { .need-card { height: 400px; } }
        @media (max-width: 768px) {
            .mobile-card-table thead { display: none; }
            .mobile-card-table tbody tr { display: block; background: white; margin-bottom: 15px; border-radius: 12px; border: 1px solid #e2e8f0; padding: 20px; box-shadow: 0 2px 5px rgba(0,0,0,0.02); }
            .mobile-card-table td { display: block; width: 100%; padding: 8px 0; border: none; }
            .mobile-card-table td::before { content: attr(data-label); float: left; font-weight: 700; color: #64748b; margin-right: 10px; font-size: 0.95rem; margin-top: 10px;}
            .mobile-card-table .action-col { text-align: right; margin-top: 15px; border-top: 1px dashed #e2e8f0; padding-top: 15px; }
        }
    </style>
</head>
<body class="bg-slate-50 min-h-screen text-slate-800 font-sans" onload="initSystem()">

    <div id="loading-overlay">
        <div class="spinner"></div>
        <div class="text-xl font-bold text-slate-800 tracking-wider">GENERATING REPORT</div>
        <p class="text-sm text-slate-500 mt-2">æ­£åœ¨ç‚ºæ‚¨è£½ä½œå°ˆæ¥­åˆ†æå ±å‘Š...</p>
    </div>

    <canvas id="hidden-chart-canvas" width="2400" height="1200" style="position:fixed; left:-9999px;"></canvas>

    <div id="settings-modal" class="fixed inset-0 z-50 flex items-center justify-center bg-black/40 hidden backdrop-blur-sm transition-opacity duration-300">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-md p-8 m-4 animate-fade-in">
            <div class="flex justify-between items-center mb-8">
                <h3 class="text-xl font-bold text-slate-800">åƒæ•¸è¨­å®š</h3>
                <button onclick="toggleSettings()" class="text-slate-400 hover:text-slate-600 transition"><i class="fas fa-times text-xl"></i></button>
            </div>
            <div class="space-y-6">
                <h4 class="font-bold text-xs text-slate-500 uppercase tracking-wider">æ•™è‚²è²»ç”¨é è¨­å€¼ (è¬/å¹´)</h4>
                <div class="grid grid-cols-2 gap-4">
                    <div><label class="text-xs font-bold text-slate-400 block mb-1">å…¬ç«‹ - K12</label><input type="number" id="cfg-pub-k12" class="form-input text-sm"></div>
                    <div><label class="text-xs font-bold text-slate-400 block mb-1">ç§ç«‹ - K12</label><input type="number" id="cfg-pri-k12" class="form-input text-sm"></div>
                    <div><label class="text-xs font-bold text-slate-400 block mb-1">å…¬ç«‹ - å¤§å­¸</label><input type="number" id="cfg-pub-uni" class="form-input text-sm"></div>
                    <div><label class="text-xs font-bold text-slate-400 block mb-1">ç§ç«‹ - å¤§å­¸</label><input type="number" id="cfg-pri-uni" class="form-input text-sm"></div>
                    <div><label class="text-xs font-bold text-slate-400 block mb-1">å…¬ç«‹ - ç¢©å£«</label><input type="number" id="cfg-pub-mas" class="form-input text-sm"></div>
                    <div><label class="text-xs font-bold text-slate-400 block mb-1">ç§ç«‹ - ç¢©å£«</label><input type="number" id="cfg-pri-mas" class="form-input text-sm"></div>
                </div>
            </div>
            <div class="mt-8 flex justify-end gap-3 pt-6 border-t border-slate-100">
                <button onclick="resetDefaultConfig()" class="px-5 py-2 text-sm font-medium text-slate-500 hover:text-slate-800 transition">æ¢å¾©é è¨­</button>
                <button onclick="saveConfig()" class="px-6 py-2 bg-slate-800 text-white rounded-lg font-bold hover:bg-slate-900 transition shadow-lg shadow-slate-200">å„²å­˜è¨­å®š</button>
            </div>
        </div>
    </div>

    <div id="app-container" class="pb-20">
        <div class="bg-white border-b border-slate-200 sticky top-0 z-40">
            <div class="container mx-auto px-4 md:px-6 h-16 flex items-center justify-between">
                <div class="flex items-center gap-3">
                    <div class="w-8 h-8 bg-slate-900 rounded-lg flex items-center justify-center text-white font-black text-sm">P</div>
                    <div>
                        <h1 class="font-bold text-slate-800 leading-tight">å€å®‰ä¿éšªéœ€æ±‚åˆ†æ</h1>
                        <p class="text-[10px] text-slate-400 tracking-wide">Your needs are our responsibility</p>
                    </div>
                </div>
                <div class="flex items-center gap-2">
                    <button onclick="clearInputs()" class="p-2 text-slate-400 hover:text-red-500 transition" title="æ¸…ç©ºé‡å¡«"><i class="fas fa-redo-alt"></i></button>
                    <button onclick="toggleSettings()" class="p-2 text-slate-400 hover:text-slate-800 transition"><i class="fas fa-cog"></i></button>
                </div>
            </div>
        </div>

        <div id="page1" class="container mx-auto py-8 px-4 md:px-6 max-w-5xl animate-fade-in">
            <div class="space-y-8">
                <section class="bg-white p-6 md:p-8 rounded-2xl shadow-sm border border-slate-100">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-lg font-bold text-slate-800 flex items-center"><span class="w-1 h-5 bg-slate-800 mr-3 rounded-full"></span>åŸºæœ¬è³‡æ–™</h2>
                        <button onclick="addFamilyMember()" class="text-sm font-bold text-blue-600 hover:bg-blue-50 px-3 py-1.5 rounded-full transition">+ æ–°å¢æˆå“¡</button>
                    </div>
                    <div id="family-container" class="space-y-4">
                        <div id="main-user-row" class="grid grid-cols-1 md:grid-cols-12 gap-4 items-end bg-slate-50/50 p-4 rounded-xl border border-slate-100">
                            <div class="md:col-span-2">
                                <label class="text-xs font-bold text-slate-400 block mb-1.5">é—œä¿‚</label>
                                <select id="main-relation" class="form-input fam-rel font-bold text-slate-700">
                                    <option value="æœ¬äºº" selected>æœ¬äºº</option>
                                    <option value="é…å¶">é…å¶</option>
                                    <option value="å­">å­</option>
                                    <option value="å¥³">å¥³</option>
                                    <option value="çˆ¶">çˆ¶</option>
                                    <option value="æ¯">æ¯</option>
                                    <option value="ç¥–çˆ¶æ¯">ç¥–çˆ¶æ¯</option>
                                </select>
                            </div>
                            <div class="md:col-span-3"><label class="text-xs font-bold text-slate-400 block mb-1.5">å§“å</label><input type="text" id="main-name" class="form-input" placeholder="è«‹è¼¸å…¥å§“å"></div>
                            <div class="md:col-span-4"><label class="text-xs font-bold text-slate-400 block mb-1.5">å‡ºç”Ÿå¹´æœˆæ—¥</label><input type="date" id="main-dob" class="form-input fam-dob" onchange="updateAge(this)"></div>
                            <div class="md:col-span-3"><label class="text-xs font-bold text-slate-400 block mb-1.5">ä¿éšªå¹´é½¡</label><div id="main-user-age-display" class="bg-white p-2.5 rounded-lg text-center font-bold text-slate-800 border border-slate-200">-- æ­²</div><input type="hidden" id="main-user-age-value" value="0"></div>
                        </div>
                    </div>
                </section>

                <section>
                    <h2 class="text-lg font-bold text-slate-800 mb-6 flex items-center"><span class="w-1 h-5 bg-slate-800 mr-3 rounded-full"></span>æ ¸å¿ƒæ“”æ†‚</h2>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                        <label class="relative need-card cursor-pointer group bg-black">
                            <input type="checkbox" id="check-sick" class="hidden peer">
                            <div class="absolute inset-0 bg-cover bg-center opacity-60 group-hover:opacity-40 transition duration-500 group-hover:scale-105" style="background-image: url('https://images.unsplash.com/photo-1538108149393-fbbd81895907?q=80&w=600');"></div>
                            <div class="absolute inset-0 bg-gradient-to-t from-slate-900/90 to-transparent"></div>
                            <div class="absolute top-4 right-4 text-white/20 peer-checked:text-blue-400 peer-checked:opacity-100 transition"><i class="fas fa-check-circle text-3xl"></i></div>
                            <div class="absolute bottom-0 left-0 p-6 w-full">
                                <h3 class="text-4xl font-black text-white mb-1">ç—…</h3>
                                <p class="text-sm font-medium text-slate-300">é†«ç™‚å“è³ª / é‡å¤§å‚·ç—…</p>
                            </div>
                            <div class="absolute inset-0 border-2 border-transparent peer-checked:border-blue-400 rounded-2xl pointer-events-none transition"></div>
                        </label>
                        
                        <label class="relative need-card cursor-pointer group bg-black">
                            <input type="checkbox" id="check-disability" class="hidden peer">
                            <div class="absolute inset-0 bg-cover bg-center opacity-60 group-hover:opacity-40 transition duration-500 group-hover:scale-105" style="background-image: url('https://images.unsplash.com/photo-1576765608535-5f04d1e3f289?q=80&w=600');"></div>
                            <div class="absolute inset-0 bg-gradient-to-t from-slate-900/90 to-transparent"></div>
                            <div class="absolute top-4 right-4 text-white/20 peer-checked:text-amber-400 peer-checked:opacity-100 transition"><i class="fas fa-check-circle text-3xl"></i></div>
                            <div class="absolute bottom-0 left-0 p-6 w-full">
                                <h3 class="text-4xl font-black text-white mb-1">æ®˜</h3>
                                <p class="text-sm font-medium text-slate-300">å¤±èƒ½ç…§è­· / è–ªè³‡è£œå„Ÿ</p>
                            </div>
                            <div class="absolute inset-0 border-2 border-transparent peer-checked:border-amber-400 rounded-2xl pointer-events-none transition"></div>
                        </label>

                        <label class="relative need-card cursor-pointer group bg-black">
                            <input type="checkbox" id="check-death" class="hidden peer">
                            <div class="absolute inset-0 bg-cover bg-center opacity-60 group-hover:opacity-40 transition duration-500 group-hover:scale-105" style="background-image: url('https://images.unsplash.com/photo-1475483768296-6163e08872a1?q=80&w=600');"></div>
                            <div class="absolute inset-0 bg-gradient-to-t from-slate-900/90 to-transparent"></div>
                            <div class="absolute top-4 right-4 text-white/20 peer-checked:text-rose-400 peer-checked:opacity-100 transition"><i class="fas fa-check-circle text-3xl"></i></div>
                            <div class="absolute bottom-0 left-0 p-6 w-full">
                                <h3 class="text-4xl font-black text-white mb-1">æ­»</h3>
                                <p class="text-sm font-medium text-slate-300">å®¶åº­è²¬ä»» / æ„›çš„å‚³æ‰¿</p>
                            </div>
                            <div class="absolute inset-0 border-2 border-transparent peer-checked:border-rose-400 rounded-2xl pointer-events-none transition"></div>
                        </label>

                        <label class="relative need-card cursor-pointer group bg-black">
                            <input type="checkbox" id="check-retire" class="hidden peer">
                            <div class="absolute inset-0 bg-cover bg-center opacity-60 group-hover:opacity-40 transition duration-500 group-hover:scale-105" style="background-image: url('https://images.unsplash.com/photo-1507525428034-b723cf961d3e?q=80&w=600');"></div>
                            <div class="absolute inset-0 bg-gradient-to-t from-slate-900/90 to-transparent"></div>
                            <div class="absolute top-4 right-4 text-white/20 peer-checked:text-emerald-400 peer-checked:opacity-100 transition"><i class="fas fa-check-circle text-3xl"></i></div>
                            <div class="absolute bottom-0 left-0 p-6 w-full">
                                <h3 class="text-4xl font-black text-white mb-1">è€</h3>
                                <p class="text-sm font-medium text-slate-300">é€€ä¼‘æ¨‚æ´» / è²¡å¯Œè‡ªç”±</p>
                            </div>
                            <div class="absolute inset-0 border-2 border-transparent peer-checked:border-emerald-400 rounded-2xl pointer-events-none transition"></div>
                        </label>
                    </div>
                </section>

                <div class="flex justify-end pt-8">
                    <button onclick="togglePages('page2')" class="bg-slate-900 text-white px-8 py-4 rounded-xl font-bold text-lg hover:bg-slate-800 transition shadow-xl flex items-center">
                        ä¸‹ä¸€æ­¥ï¼šéœ€æ±‚é‡åŒ– <i class="fas fa-arrow-right ml-2"></i>
                    </button>
                </div>
            </div>
        </div>

        <div id="page2" class="container mx-auto py-8 px-4 md:px-6 max-w-5xl hidden animate-fade-in">
             <div class="space-y-6">
                <button onclick="togglePages('page1')" class="text-slate-500 hover:text-slate-800 font-bold mb-4 flex items-center"><i class="fas fa-arrow-left mr-2"></i> è¿”å›</button>
                
                <div id="section-sick" class="hidden bg-white p-6 rounded-2xl shadow-sm border border-slate-100"><h2 class="text-xl font-bold mb-4">ğŸ¥ é†«ç™‚éœ€æ±‚</h2><table class="w-full text-left financial-table"><tr class="calc-row-sick"><th>é …ç›®</th><th>éœ€æ±‚</th><th>é¡åº¦(è¬)</th><th>å·²å‚™(è¬)</th><th>ç¼ºå£</th></tr><tr class="calc-row-sick"><td>ä½é™¢é›œè²»</td><td>å–®äººæˆ¿</td><td><input type="number" class="sick-target form-input"></td><td><input type="number" class="sick-current form-input"></td><td class="sick-gap font-bold text-red-500">0</td></tr><tr class="calc-row-sick"><td>é‡å¤§å‚·ç—…</td><td>ä¸€æ¬¡é‡‘</td><td><input type="number" class="sick-target form-input"></td><td><input type="number" class="sick-current form-input"></td><td class="sick-gap font-bold text-red-500">0</td></tr></table>
                <p class="text-sm text-slate-500 mt-4 bg-slate-50 p-3 rounded">ğŸ’¡ é¡§å•æŒ‡å¼•ï¼šå‡ç­‰å–®äººæˆ¿å¯é™ä½æ„ŸæŸ“é¢¨éšªï¼›ç™Œç—‡æ¨™é¶èˆ‡å…ç–«ç™‚æ³•å¤šéœ€è‡ªè²»ï¼Œå»ºè­°è¦åŠƒè¶³å¤ ä¸€æ¬¡é‡‘ã€‚</p></div>

                <div id="section-disability" class="hidden bg-white p-6 rounded-2xl shadow-sm border border-slate-100"><h2 class="text-xl font-bold mb-4">â™¿ å¤±èƒ½éœ€æ±‚</h2><div class="grid grid-cols-2 gap-4"><div><label>æœˆç…§è­·è²»(è¬)</label><input type="number" id="dis-target" class="form-input"></div><div><label>å·²å‚™(è¬)</label><input type="number" id="dis-current" class="form-input"></div></div><div class="mt-4 p-4 bg-slate-50 rounded text-center font-bold text-amber-600">ç¼ºå£: <span id="dis-gap">0</span> è¬/æœˆ</div>
                <p class="text-sm text-slate-500 mt-4">ğŸ’¡ å¸‚å ´è¡Œæƒ…ï¼šå¤–ç±çœ‹è­·ç´„3è¬/æœˆï¼Œæ©Ÿæ§‹ç´„4-6è¬/æœˆ (æœªå«è€—æ)ã€‚</p></div>

                <div id="section-death" class="hidden bg-white p-6 rounded-2xl shadow-sm border border-slate-100"><h2 class="text-xl font-bold mb-4">ğŸ•Šï¸ èº«æ•…éœ€æ±‚</h2>
                    <div class="mb-2"><span class="font-bold text-slate-700">çˆ¶æ¯å­é¤Š</span> <button onclick="addParentRow()" class="text-xs bg-blue-50 text-blue-600 px-2 py-1 rounded ml-2">+ æ‰‹å‹•æ–°å¢</button></div>
                    <div id="parents-container" class="mb-4 space-y-2"></div>
                    
                    <div class="grid grid-cols-2 gap-4 mb-4"><div><label>é…å¶ç”Ÿæ´»è²»(è¬/æœˆ)</label><input type="number" id="living-monthly" class="form-input"></div><div><label>ç…§é¡§å¹´æ•¸</label><input type="number" id="living-years" class="form-input"></div></div>
                    
                    <div class="mb-2 mt-4"><span class="font-bold text-slate-700">å­å¥³æ•™è‚²åŸºé‡‘</span> <button onclick="addChildEduRow()" class="text-xs bg-blue-50 text-blue-600 px-2 py-1 rounded ml-2">+ æ‰‹å‹•æ–°å¢</button></div>
                    <div id="edu-container" class="mt-2 space-y-2"></div>
                    
                    <div class="grid grid-cols-2 gap-4 mt-4"><div><label>æˆ¿è²¸/ç§Ÿé‡‘(è¬/æœˆ)</label><input type="number" id="house-monthly" class="form-input"></div><div><label>å‰©é¤˜å¹´æ•¸</label><input type="number" id="house-years" class="form-input"></div></div>
                    <div class="mt-4 p-4 bg-slate-900 text-white rounded text-center"><div class="text-xs opacity-50">ç¸½ç¼ºå£</div><div class="text-2xl font-bold" id="grand-total-gap" data-need="0">0</div><div class="mt-2 text-sm">æ‰£é™¤ç¾æœ‰å£½éšª: <input type="number" id="existing-insurance-p2" class="bg-transparent border-b border-slate-500 w-20 text-center text-white" oninput="syncInsurance(this.value, 'comm-insurance-p3')"></div><span id="total-parents" class="hidden"></span><span id="total-living-edu" class="hidden"></span><span id="total-house" class="hidden"></span></div>
                </div>

                <div id="section-retire" class="hidden bg-white p-6 rounded-2xl shadow-sm border border-slate-100"><h2 class="text-xl font-bold mb-4">ğŸŒ… é€€ä¼‘éœ€æ±‚</h2><div class="grid grid-cols-2 gap-4"><div><label>ç¾é½¡</label><input type="number" id="retire-current-age" class="form-input" readonly></div><div><label>é€€é½¡</label><input type="number" id="retire-target-age" class="form-input"></div><div><label>å£½å‘½</label><input type="number" id="retire-end-age" class="form-input"></div><div><label>æœˆèŠ±è²»(è¬)</label><input type="number" id="retire-monthly" class="form-input"></div></div><div class="mt-4 p-4 bg-emerald-50 text-emerald-700 rounded text-center font-bold">å¹´å„²è“„: <span id="retire-annual-save">0</span> è¬<span id="retire-total-needed" class="hidden"></span><span id="retire-years-to-save" class="hidden"></span><span id="retire-years-to-live" class="hidden"></span></div></div>

                <div class="flex justify-end pt-8">
                    <button onclick="togglePages('page3')" class="bg-slate-900 text-white px-8 py-4 rounded-xl font-bold text-lg hover:bg-slate-800 transition shadow-xl">ä¸‹ä¸€æ­¥ï¼šè²¡å‹™è©¦ç®—</button>
                </div>
             </div>
        </div>

        <div id="page3" class="container mx-auto py-8 px-4 md:px-6 max-w-5xl hidden animate-fade-in">
             <div class="space-y-6">
                <button onclick="togglePages('page2')" class="text-slate-500 hover:text-slate-800 font-bold mb-4 flex items-center"><i class="fas fa-arrow-left mr-2"></i> è¿”å›</button>
                
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-100">
                        <h3 class="font-bold text-emerald-600 mb-4">å¹´åº¦æ”¶å…¥</h3>
                        <table class="w-full financial-table"><tbody id="income-body"></tbody></table>
                        <button onclick="addFlowRow('income')" class="text-xs bg-slate-100 px-3 py-1 rounded mt-2 hover:bg-slate-200">+ æ–°å¢</button>
                    </div>
                    <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-100">
                        <h3 class="font-bold text-red-500 mb-4">å¹´åº¦æ”¯å‡º</h3>
                        <table class="w-full financial-table"><tbody id="expense-body"></tbody></table>
                        <button onclick="addFlowRow('expense')" class="text-xs bg-slate-100 px-3 py-1 rounded mt-2 hover:bg-slate-200">+ æ–°å¢</button>
                    </div>
                </div>

                <div class="bg-slate-900 text-white p-6 rounded-2xl flex justify-between items-center">
                    <span>å¹´åº¦æ·¨ç¾é‡‘æµ</span>
                    <span id="net-cashflow" class="text-2xl font-bold">0 è¬</span>
                </div>

                <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-100">
                    <h3 class="font-bold text-blue-600 mb-4">ç¤¾æœƒä¿éšªèˆ‡ä¿éšœ</h3>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                        <div>
                            <label class="text-xs font-bold text-slate-400 block mb-2">ä¿éšªèº«ä»½</label>
                            <select id="si-type" class="si-select" onchange="updateSocialInsurance()">
                                <option value="labor" selected>å‹ä¿</option>
                                <option value="gov">å…¬ä¿</option>
                                <option value="farmer">è¾²ä¿</option>
                                <option value="fisher">æ¼ä¿</option>
                                <option value="national">åœ‹ä¿</option>
                            </select>
                            <label class="text-xs font-bold text-slate-400 block mb-2 mt-3">æŠ•ä¿è–ªè³‡ (å…ƒ)</label>
                            <input type="number" id="labor-salary-p3" class="form-input" oninput="calculateAll()">
                            <a id="si-table-link" href="https://www.bli.gov.tw/0005475.html" target="_blank" class="salary-table-link"><i class="fas fa-external-link-alt mr-1"></i>ç´šè·è¡¨</a>
                            <div class="mt-2 text-sm font-bold text-blue-600">èº«æ•…çµ¦ä»˜: <span id="labor-benefit-val-p3">0</span> è¬</div>
                            <div id="si-note" class="text-xs text-slate-400 mt-1"></div>
                        </div>
                        <div>
                            <label class="text-xs font-bold text-slate-400 block mb-2">å…¬å¸åœ˜ä¿ (è¬)</label>
                            <input type="number" id="group-insurance-p3" class="form-input" oninput="calculateAll()">
                        </div>
                        <div>
                            <label class="text-xs font-bold text-slate-400 block mb-2">å•†æ¥­å£½éšª (è¬)</label>
                            <input type="number" id="comm-insurance-p3" class="form-input" oninput="syncInsurance(this.value, 'existing-insurance-p2')">
                        </div>
                    </div>
                </div>

                <div class="flex justify-center pt-8">
                    <button onclick="generateReport()" class="bg-slate-900 text-white px-10 py-5 rounded-full font-bold text-xl hover:bg-slate-800 transition shadow-2xl flex items-center transform hover:-translate-y-1">
                        <i class="fas fa-print mr-3"></i> ç”¢å‡ºå°ˆæ¥­å ±å‘Š
                    </button>
                </div>
             </div>
        </div>
    </div>

    <script>
        const DEFAULT_CONFIG = { 'pub-k12': 10, 'pri-k12': 30, 'pub-uni': 25, 'pri-uni': 50, 'pub-mas': 30, 'pri-mas': 60 };
        let CONFIG = { ...DEFAULT_CONFIG };

        const SI_DATA = {
            labor: { label: 'å‹ä¿èº«æ•…çµ¦ä»˜', note: '* ä¾å‹ä¿æ™®é€šå‚·ç—…(35å€‹æœˆ)', tableUrl: 'https://www.bli.gov.tw/0005475.html' },
            gov: { label: 'å…¬ä¿æ­»äº¡çµ¦ä»˜', note: '* ä¾æœªæ»¿20å¹´å¹´è³‡(30å€‹æœˆ)', tableUrl: 'https://www.bot.com.tw/tw/policy-business/government-employees-insurance-service/downloads/cash-payment-form' },
            farmer: { label: 'è¾²ä¿å–ªè‘¬æ´¥è²¼', note: '* å›ºå®š 20,400 x 15å€‹æœˆ', fixed: 20400, tableUrl: null },
            fisher: { label: 'æ¼ä¿èº«æ•…çµ¦ä»˜', note: '* æ¯”ç…§å‹ä¿ç”²é¡(35å€‹æœˆ)', tableUrl: 'https://www.bli.gov.tw/0005475.html' },
            national: { label: 'åœ‹ä¿å–ªè‘¬çµ¦ä»˜', note: '* å›ºå®š 19,761 x 5å€‹æœˆ', fixed: 19761, tableUrl: null }
        };

        function initSystem() {
            resetInputs();
            const savedConfig = localStorage.getItem('pwm_config');
            if(savedConfig) CONFIG = { ...DEFAULT_CONFIG, ...JSON.parse(savedConfig) };
            if(document.getElementById('income-body').children.length === 0) addFlowRow('income');
            if(document.getElementById('expense-body').children.length === 0) addFlowRow('expense');
            document.getElementById('si-type').value = 'labor';
            updateSocialInsurance();
            calculateAll();
        }

        function resetInputs() {
            document.querySelectorAll('input').forEach(i => {
                if(i.type === 'checkbox' || i.type === 'radio') i.checked = false;
                else i.value = '';
            });
            document.querySelectorAll('select:not(#si-type)').forEach(select => select.selectedIndex = 0);
            document.getElementById('parents-container').innerHTML = '';
            document.getElementById('edu-container').innerHTML = '';
            document.getElementById('income-body').innerHTML = '';
            document.getElementById('expense-body').innerHTML = '';
            document.getElementById('main-user-age-display').innerText = '-- æ­²';
        }
        
        function clearInputs() { if(confirm('ç¢ºå®šè¦æ¸…ç©ºæ‰€æœ‰è³‡æ–™å—ï¼Ÿ')) { resetInputs(); initSystem(); } }

        function updateSocialInsurance() {
            const type = document.getElementById('si-type').value;
            const data = SI_DATA[type];
            const input = document.getElementById('labor-salary-p3');
            document.getElementById('si-note').innerText = data.note;
            const link = document.getElementById('si-table-link');
            if(data.tableUrl) { link.href = data.tableUrl; link.classList.remove('hidden'); } else { link.classList.add('hidden'); }
            if(data.fixed) { input.value = data.fixed; input.setAttribute('readonly', true); input.classList.add('bg-slate-100'); } 
            else { input.removeAttribute('readonly'); input.classList.remove('bg-slate-100'); if(input.value == 20400 || input.value == 19761) input.value = ''; }
            calculateAll();
        }

        function getAgeFromDate(dateStr) {
            if(!dateStr) return 0;
            const dob = new Date(dateStr);
            const today = new Date();
            let age = today.getFullYear() - dob.getFullYear();
            if(today < new Date(today.getFullYear(), dob.getMonth(), dob.getDate())) age--;
            const m = (age*12) + (today.getMonth() - dob.getMonth());
            return Math.floor(m/12) + (m%12>=6 ? 1 : 0);
        }

        function updateAge(input) { 
            const insAge = getAgeFromDate(input.value);
            if(input.id === 'main-dob') {
                document.getElementById('main-user-age-display').innerText = insAge + " æ­²"; 
                document.getElementById('main-user-age-value').value = insAge; 
                document.getElementById('retire-current-age').value = insAge;
            }
            calculateAll(); 
        }

        function syncInsurance(v, tid) { const t=document.getElementById(tid); if(t && t.value!=v) t.value=v; calculateAll(); }
        
        // Auto-populate Death Logic
        function autoFillDeathNeeds() {
            if(!document.getElementById('check-death').checked) return;
            
            // Clear current to prevent duplicates
            document.getElementById('parents-container').innerHTML = '';
            document.getElementById('edu-container').innerHTML = '';

            // 1. Get Main User (if relation is Parent, though usually 'æœ¬äºº')
            // Not usually needed for Death benefit of 'Self' to pay parents.

            // 2. Scan other members
            const rows = document.querySelectorAll('#family-container .grid');
            rows.forEach(row => {
                const rel = row.querySelector('.fam-rel').value;
                const dob = row.querySelector('.fam-dob').value;
                const age = getAgeFromDate(dob);

                if (rel === 'çˆ¶') {
                    addParentRow(rel, age, 76);
                } else if (rel === 'æ¯') {
                    addParentRow(rel, age, 84);
                } else if (rel === 'å­' || rel === 'å¥³') {
                    addChildEduRow(age);
                }
            });
        }

        function togglePages(id) { 
            document.querySelectorAll('[id^="page"]').forEach(e=>e.classList.add('hidden')); 
            document.getElementById(id).classList.remove('hidden'); 
            window.scrollTo(0,0); 
            if(id==='page2') {
                syncPage2();
                autoFillDeathNeeds(); // Auto Populate
            }
        }
        function syncPage2() { const m={'check-sick':'section-sick','check-disability':'section-disability','check-death':'section-death','check-retire':'section-retire'}; for(let k in m) { const e=document.getElementById(m[k]); if(document.getElementById(k).checked) e.classList.remove('hidden'); else e.classList.add('hidden'); } }
        
        function addFamilyMember() { 
            const d=document.createElement('div'); 
            d.className="grid grid-cols-1 md:grid-cols-12 gap-4 items-end bg-slate-50 p-4 rounded-xl border border-slate-100 animate-fade-in"; 
            d.innerHTML=`<div class="md:col-span-2"><label class="text-xs font-bold text-slate-400 block mb-1">é—œä¿‚</label><select class="form-input fam-rel"><option>é…å¶</option><option>å­</option><option>å¥³</option><option>çˆ¶</option><option>æ¯</option><option>ç¥–çˆ¶æ¯</option></select></div><div class="md:col-span-3"><label class="text-xs font-bold text-slate-400 block mb-1">å§“å</label><input type="text" class="form-input"></div><div class="md:col-span-4"><label class="text-xs font-bold text-slate-400 block mb-1">ç”Ÿæ—¥</label><input type="date" class="form-input fam-dob" onchange="updateAge(this)"></div><div class="md:col-span-3 relative"><label class="text-xs font-bold text-slate-400 block mb-1">ä¿éšªå¹´é½¡</label><div class="bg-white p-2.5 rounded-lg text-center font-bold text-slate-800 border border-slate-200 age-display">-- æ­²</div><button onclick="this.parentElement.parentElement.remove()" class="absolute -top-2 -right-2 text-red-400 hover:text-red-600"><i class="fas fa-times-circle"></i></button></div>`; 
            document.getElementById('family-container').appendChild(d); 
        }
        
        function addParentRow(rel, age, targetAge) { 
            const d=document.createElement('div'); 
            d.className="flex gap-2 mb-2 items-center bg-slate-50 p-2 rounded border border-slate-100"; 
            
            // Simplified Display
            const label = rel ? rel : 'é•·è¼©';
            const ageVal = age ? age : '';
            const targetVal = targetAge ? targetAge : (rel==='çˆ¶'?76:84);
            const note = targetAge ? `(ä¾åœ‹äººå¹³å‡å£½å‘½)` : '';

            d.innerHTML=`
                <div class="w-24 text-center">
                    <div class="font-bold text-slate-700">${label}</div>
                    <div class="text-[10px] text-slate-400">ç›®å‰ ${ageVal} æ­²</div>
                </div>
                <div class="flex-1 flex gap-2 items-center">
                    <div class="flex-1">
                       <label class="text-[10px] text-slate-400 block">é ä¼°å£½å‘½</label>
                       <input type="number" class="p-type form-input h-8 text-sm" value="${targetVal}">
                       <div class="text-[10px] text-slate-400 mt-0.5">${note}</div>
                    </div>
                     <div class="flex-1">
                       <label class="text-[10px] text-slate-400 block">æœˆå­é¤Šé‡‘(è¬)</label>
                       <input type="number" class="p-money form-input h-8 text-sm" oninput="calculateAll()">
                    </div>
                </div>
                <input type="hidden" class="p-age" value="${ageVal}">
                <button onclick="this.parentElement.remove();calculateAll()" class="text-red-400 px-2"><i class="fas fa-trash"></i></button>
            `; 
            document.getElementById('parents-container').appendChild(d); 
        }

        function addChildEduRow(age) { 
            const d=document.createElement('div'); 
            d.className="child-edu-row bg-slate-50 p-3 rounded mb-2 border border-slate-100"; 
            const ageVal = age ? age : '';
            d.innerHTML=`<div class="flex gap-2 mb-2"><input type="number" class="c-age form-input" placeholder="æ­²" value="${ageVal}" oninput="calculateAll()"><select class="c-degree form-input" onchange="calculateAll()"><option value="22">è‡³å¤§å­¸</option><option value="24">è‡³ç¢©å£«</option></select></div><div class="flex justify-between items-center"><div class="text-sm"><label class="mr-3"><input type="radio" name="e_${Date.now()}" value="public" class="c-type" onchange="calculateAll()"> å…¬ç«‹</label><label><input type="radio" name="e_${Date.now()}" value="private" class="c-type" checked onchange="calculateAll()"> ç§ç«‹</label></div><button onclick="this.parentElement.parentElement.remove();calculateAll()" class="text-red-400 text-xs">åˆªé™¤</button></div>`; 
            document.getElementById('edu-container').appendChild(d); 
        }

        function addFlowRow(type, name, amount) { 
            const currentSelects = document.querySelectorAll(`.${type}-select`);
            const usedValues = Array.from(currentSelects).map(s => s.value);
            const masterList = type === 'income' ? ['è–ªè³‡æ”¶å…¥', 'å¹´çµ‚çé‡‘', 'è‚¡åˆ©', 'ç§Ÿé‡‘', 'å…¼è·', 'æŠ•è³‡', 'å…¶ä»–'] : ['ç”Ÿæ´»é–‹éŠ·', 'äº¤é€š', 'æˆ¿è²¸/æˆ¿ç§Ÿ', 'ä¿éšª', 'å­è¦ªè²»', 'æ•™è‚²', 'å¨›æ¨‚', 'é›œæ”¯', 'å…¶ä»–'];
            const availableOptions = masterList.filter(item => !usedValues.includes(item));
            if (availableOptions.length === 0) { alert("å·²ç„¡æ›´å¤šé¸é …"); return; }
            const tbody = document.getElementById(type + '-body'); 
            const tr = document.createElement('tr'); 
            let opts = availableOptions.map(o => `<option value="${o}">${o}</option>`).join('');
            tr.innerHTML = `<td data-label="é …ç›®"><select class="form-input ${type}-select" onchange="saveData()">${opts}</select></td><td data-label="é‡‘é¡"><input type="number" class="form-input ${type}-amount" placeholder="0" onkeyup="calculateAll();saveData()" onchange="saveData()"></td><td class="action-col"><button onclick="this.closest('tr').remove();calculateAll();saveData()" class="text-slate-400 hover:text-red-500"><i class="fas fa-trash"></i></button></td>`; 
            tbody.appendChild(tr); 
            if(name) { const sel = tr.querySelector('select'); if(![...sel.options].some(o => o.value === name)) { const o = document.createElement('option'); o.value = name; o.text = name; sel.add(o); } sel.value = name; } 
            if(amount) tr.querySelector('input').value = amount; 
        }

        function calculateAll() {
            const clean=v=>parseFloat(v)||0; const fmt=v=>v.toLocaleString();
            document.querySelectorAll('.calc-row-sick').forEach(r=>{ const t=clean(r.querySelector('.sick-target').value), c=clean(r.querySelector('.sick-current').value); r.querySelector('.sick-gap').innerText=fmt(Math.max(0,t-c)); });
            const disG=Math.max(0, clean(document.getElementById('dis-target').value)-clean(document.getElementById('dis-current').value)); document.getElementById('dis-gap').innerText=fmt(disG);
            
            // Death
            let pTot=0; document.querySelectorAll('.parent-row').forEach(r=>{ 
                const m=clean(r.querySelector('.p-money').value);
                // Important: Use .p-age value from hidden input if available, else 0
                const age=clean(r.querySelector('.p-age').value); 
                const end=clean(r.querySelector('.p-type').value); 
                pTot+=m*12*Math.max(0,end-age); 
            });
            const house=clean(document.getElementById('house-monthly').value)*12*clean(document.getElementById('house-years').value);
            const living=clean(document.getElementById('living-monthly').value)*12*clean(document.getElementById('living-years').value);
            let edu=0; document.querySelectorAll('.child-edu-row').forEach(r=>{ 
                const age=clean(r.querySelector('.c-age').value), deg=clean(r.querySelector('.c-degree').value), isPri=r.querySelector('.c-type:checked').value==='private';
                const k12=isPri?CONFIG['pri-k12']:CONFIG['pub-k12'], uni=isPri?CONFIG['pri-uni']:CONFIG['pub-uni'];
                if(age<18) edu+=(18-age)*k12; if(age<deg) edu+=(deg-Math.max(18,age))*uni;
            });
            const dNeed=pTot+house+living+edu;
            
            // SI Benefit
            const siType=document.getElementById('si-type').value; const sal=clean(document.getElementById('labor-salary-p3').value);
            let siBen=0;
            if(siType==='labor'||siType==='fisher') siBen=sal*35; else if(siType==='gov') siBen=sal*30; else if(siType==='farmer') siBen=20400*15; else siBen=19761*5;
            document.getElementById('labor-benefit-val-p3').innerText=fmt(Math.round(siBen/10000));
            
            const grp=clean(document.getElementById('group-insurance-p3').value), comm=clean(document.getElementById('comm-insurance-p3').value);
            const dGap=Math.max(0, dNeed-(Math.round(siBen/10000)+grp+comm));
            document.getElementById('grand-total-gap').innerText=fmt(dGap)+" è¬"; document.getElementById('grand-total-gap').dataset.need=dNeed;

            // Retire
            const rTar=clean(document.getElementById('retire-target-age').value)||65, rCur=clean(document.getElementById('retire-current-age').value), rEnd=clean(document.getElementById('retire-end-age').value)||85;
            const rTot=clean(document.getElementById('retire-monthly').value)*12*Math.max(0,rEnd-rTar);
            document.getElementById('retire-annual-save').innerText=fmt((rTot/Math.max(1,rTar-rCur)).toFixed(1));

            // Cashflow
            let inc=0; document.querySelectorAll('.income-amount').forEach(i=>inc+=clean(i.value));
            let exp=0; document.querySelectorAll('.expense-amount').forEach(i=>exp+=clean(i.value));
            const net=inc-exp; document.getElementById('net-cashflow').innerText=fmt(net)+" è¬";
            document.getElementById('net-cashflow').className=`text-2xl font-bold ${net>=0?'text-emerald-500':'text-red-500'}`;
        }

        function toggleSettings() { const m=document.getElementById('settings-modal'); m.classList.toggle('hidden'); if(!m.classList.contains('hidden')) for(k in CONFIG) document.getElementById('cfg-'+k).value=CONFIG[k]; }
        function saveConfig() { for(k in CONFIG) CONFIG[k]=parseFloat(document.getElementById('cfg-'+k).value)||CONFIG[k]; localStorage.setItem('pwm_config',JSON.stringify(CONFIG)); toggleSettings(); calculateAll(); }
        function resetDefaultConfig() { if(confirm('æ¢å¾©é è¨­ï¼Ÿ')) { CONFIG={...DEFAULT_CONFIG}; for(k in CONFIG) document.getElementById('cfg-'+k).value=CONFIG[k]; } }

        // --- Report Generation ---
        async function generateReport() {
            const overlay = document.getElementById('loading-overlay'); overlay.style.display = 'flex';
            await new Promise(r => setTimeout(r, 800)); 
            calculateAll();

            const name = document.getElementById('main-name').value || 'è²´è³“';
            const date = new Date().toLocaleDateString();
            const clean = v => parseFloat(v.replace(/,/g,''))||0;

            let sickGap = 0; document.querySelectorAll('.sick-gap').forEach(e=>sickGap+=clean(e.innerText));
            const disGap = document.getElementById('dis-gap').innerText;
            const deathGap = document.getElementById('grand-total-gap').innerText;
            const retireGap = document.getElementById('retire-annual-save').innerText;
            const deathNeed = clean(document.getElementById('grand-total-gap').dataset.need);
            const siVal = document.getElementById('labor-benefit-val-p3').innerText;
            const grpVal = document.getElementById('group-insurance-p3').value||0;
            const commVal = document.getElementById('comm-insurance-p3').value||0;
            const inc = document.querySelectorAll('.income-amount'); let totInc=0; inc.forEach(i=>totInc+=clean(i.value));
            const exp = document.querySelectorAll('.expense-amount'); let totExp=0; exp.forEach(i=>totExp+=clean(i.value));
            const net = totInc-totExp;

            const advice = [];
            if(sickGap>0) advice.push(`<strong>ğŸ¥ é†«ç™‚å“è³ª (ç—…)</strong>ï¼šå°šæœ‰ç¼ºå£ ${sickGap} è¬ã€‚å»ºè­°å„ªå…ˆè£œè¶³å¯¦æ”¯å¯¦ä»˜èˆ‡é‡å¤§å‚·ç—…éšªï¼Œç¢ºä¿é†«ç™‚è‡ªä¸»æ¬Šã€‚`);
            if(clean(disGap)>0) advice.push(`<strong>â™¿ å¤±èƒ½ç…§è­· (æ®˜)</strong>ï¼šæ¯æœˆç¼ºå£ ${disGap}ã€‚é•·æœŸçœ‹è­·å°‡ä¾µè•è³‡ç”¢ï¼Œå»ºè­°è¦åŠƒå¤±èƒ½æ‰¶åŠ©éšªè½‰å«é¢¨éšªã€‚`);
            if(clean(deathGap)>0) advice.push(`<strong>ğŸ•Šï¸ å®¶åº­è²¬ä»» (æ­»)</strong>ï¼šèº«æ•…ç¼ºå£é” ${deathGap}ã€‚å»ºè­°åˆ©ç”¨å®šæœŸå£½éšªçš„é«˜æ§“æ¡¿ç‰¹æ€§ï¼Œä½é ç®—è£œè¶³å°å®¶äººçš„æ„›ã€‚`);
            if(clean(retireGap)>0) advice.push(`<strong>ğŸŒ… é€€ä¼‘æ¨‚æ´» (è€)</strong>ï¼šæ¯å¹´éœ€å­˜ ${retireGap} è¬ã€‚æ™‚é–“æ˜¯è¤‡åˆ©æœ€å¥½çš„æœ‹å‹ï¼Œå»ºè­°å³åˆ»å•Ÿå‹•å°ˆæ¬¾å°ˆç”¨è¨ˆç•«ã€‚`);
            if(advice.length===0) advice.push("<strong>ğŸ‘ æ­å–œæ‚¨ï¼</strong>ç›®å‰çš„ä¿éšœè¦åŠƒç›¸ç•¶å®Œå–„ã€‚å»ºè­°å®šæœŸæª¢è¦–ä¿å–®ï¼Œç¢ºä¿é¡åº¦éš¨äººç”Ÿéšæ®µèª¿æ•´ã€‚");

            const canvas = document.getElementById('hidden-chart-canvas');
            const ctx = canvas.getContext('2d');
            const age = parseInt(document.getElementById('main-user-age-value').value)||30;
            const rAge = parseInt(document.getElementById('retire-target-age').value)||65;
            const exist = clean(siVal)+clean(grpVal)+clean(commVal);
            const labels=[], dNeed=[], dExist=[];
            for(let i=age; i<=rAge; i++) { labels.push(i); dNeed.push(Math.max(0, Math.round(deathNeed * (1 - (i-age)/(rAge-age))))); dExist.push(exist); }
            
            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [
                        { label: 'å®¶åº­è²¬ä»»', data: dNeed, backgroundColor: 'rgba(252, 211, 77, 0.5)', order: 2 },
                        { label: 'ç¾æœ‰ä¿éšœ', data: dExist, type:'line', borderColor: '#1e293b', borderWidth: 4, pointRadius:0, order: 1 }
                    ]
                },
                options: { animation: false, responsive: false, scales: { y: { beginAtZero: true } }, plugins: { legend: { labels: { font: { size: 24 } } } } }
            });
            const chartURL = canvas.toDataURL();

            const html = `
                <html><head><style>
                    @page { size: A4; margin: 0; }
                    body { font-family: 'Noto Sans TC', sans-serif; margin: 0; -webkit-print-color-adjust: exact !important; print-color-adjust: exact !important; }
                    .page { width: 210mm; height: 297mm; position: relative; overflow: hidden; page-break-after: always; display: flex; flex-direction: column; background: white; }
                    .cover { background: linear-gradient(135deg, #0f172a 0%, #1e3a8a 100%); flex: 1; display: flex; flex-direction: column; justify-content: center; padding-left: 30mm; color: white; }
                    .title-line { width: 80px; height: 6px; background: #fcd34d; margin-bottom: 30px; }
                    .header { height: 18mm; background: #0f172a; display: flex; align-items: center; justify-content: space-between; padding: 0 20mm; }
                    .brand-l { color: #fcd34d; font-weight: 300; font-size: 14px; letter-spacing: 1px; }
                    .brand-r { color: white; text-align: right; line-height: 1.2; }
                    .content { padding: 15mm 10mm; flex: 1; display: flex; flex-direction: column; }
                    .pg-title { font-size: 24px; font-weight: 900; color: #0f172a; border-bottom: 3px solid #e2e8f0; padding-bottom: 10px; margin-bottom: 25px; }
                    .grid-4 { display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; margin-bottom: 25px; }
                    .card { background: #f8fafc; border-top: 4px solid #94a3b8; padding: 15px 10px; text-align: center; border-radius: 4px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
                    .card-val { font-size: 22px; font-weight: 900; color: #0f172a; }
                    .card-lbl { font-size: 12px; color: #64748b; font-weight: bold; margin-bottom: 5px; }
                    .tbl { width: 100%; border-collapse: collapse; font-size: 13px; margin-bottom: 20px; }
                    .tbl th { text-align: left; padding: 10px; background: #f1f5f9; color: #475569; border-bottom: 2px solid #cbd5e1; }
                    .tbl td { padding: 10px; border-bottom: 1px solid #f1f5f9; }
                    .advice { background: #fff; border: 1px solid #e2e8f0; padding: 30px; border-radius: 8px; box-shadow: 0 4px 10px rgba(0,0,0,0.05); }
                    .advice li { margin-bottom: 15px; }
                    .footer { height: 12mm; border-top: 1px solid #e2e8f0; display: flex; align-items: center; justify-content: space-between; padding: 0 20mm; font-size: 10px; color: #94a3b8; }
                </style></head><body>
                    <div class="page cover">
                        <div class="title-line"></div>
                        <h1 style="font-size: 56px; font-weight: 900; line-height: 1.1; margin: 0;">å€å®‰ä¿éšª<br>éœ€æ±‚åˆ†æå ±å‘Š</h1>
                        <div style="font-size: 20px; font-weight: 300; margin: 15px 0 60px 0; color: #fcd34d; letter-spacing: 1px;">Polaris Financial Group</div>
                        <div style="border-left: 1px solid rgba(255,255,255,0.3); padding-left: 20px;">
                            <p style="font-size: 14px; opacity: 0.7; letter-spacing: 2px;">PREPARED FOR</p>
                            <h2 style="font-size: 36px; font-weight: 700; margin: 5px 0 10px 0;">${name} <span style="font-size: 18px; font-weight: 300; font-family: 'Noto Sans TC';">å…ˆç”Ÿ/å°å§</span></h2>
                            <p style="font-size: 14px; opacity: 0.8;">${date}</p>
                        </div>
                        <div style="position: absolute; bottom: 30mm; font-size: 14px; font-weight: 300; letter-spacing: 1px; opacity: 0.6;">Your needs are our responsibility</div>
                    </div>

                    <div class="page">
                        <div class="header">
                            <span class="brand-l">Polaris Financial Group</span>
                            <div class="brand-r"><span style="font-weight:700; font-size:18px;">é¢¨éšªåˆ†æ</span><br><span style="font-weight:300; font-size:9px; letter-spacing:2px; text-transform:uppercase;">Risk Analysis</span></div>
                        </div>
                        <div class="content">
                            <div class="pg-title">é¢¨éšªç¼ºå£ç¸½è¦½</div>
                            <div class="grid-4">
                                <div class="card" style="border-color:#ef4444"><div class="card-lbl">é†«ç™‚ç¼ºå£</div><div class="card-val" style="color:#ef4444">${parseFloat(sickGap).toLocaleString()} è¬</div></div>
                                <div class="card" style="border-color:#f59e0b"><div class="card-lbl">å¤±èƒ½æœˆç¼ºå£</div><div class="card-val" style="color:#f59e0b">${disGap}</div></div>
                                <div class="card" style="border-color:#0f172a"><div class="card-lbl">èº«æ•…ç¼ºå£</div><div class="card-val" style="color:#0f172a">${deathGap}</div></div>
                                <div class="card" style="border-color:#10b981; background:#f0fdf4"><div class="card-lbl" style="color:#047857">é€€ä¼‘å¹´å„²è“„</div><div class="card-val" style="color:#047857">${retireGap}</div></div>
                            </div>
                            <table class="tbl">
                                <tr><th width="40%">ä¿éšœä¾†æº</th><th width="30%">é ä¼°é‡‘é¡</th><th>å‚™è¨»</th></tr>
                                <tr><td>å®¶åº­ç¸½è²¬ä»»</td><td>${deathGap.replace(' è¬','')} è¬</td><td>æˆ¿è²¸ã€æ•™è‚²ã€ç”Ÿæ´»è²»ç¸½å’Œ</td></tr>
                                <tr><td>(-) ${SI_DATA[document.getElementById('si-type').value].label}</td><td style="color:#059669">- ${siVal} è¬</td><td></td></tr>
                                <tr><td>(-) å…¬å¸åœ˜ä¿/æ’«å¹</td><td style="color:#059669">- ${parseFloat(grpVal).toLocaleString()} è¬</td><td></td></tr>
                                <tr><td>(-) æ—¢æœ‰å•†æ¥­å£½éšª</td><td style="color:#059669">- ${parseFloat(commVal).toLocaleString()} è¬</td><td></td></tr>
                                <tr style="background:#fee2e2; font-weight:bold; color:#b91c1c"><td>éœ€å¢è£œç¼ºå£</td><td>${deathGap}</td><td></td></tr>
                            </table>
                            <div style="flex:1; border:1px solid #e2e8f0; border-radius:8px; padding:20px; display:flex; flex-direction:column;">
                                <div style="text-align:center; font-weight:bold; color:#64748b; margin-bottom:10px;">å®¶åº­è²¬ä»» vs ç¾æœ‰ä¿éšœ</div>
                                <img src="${chartURL}" style="flex:1; object-fit:contain; width:100%;">
                            </div>
                        </div>
                        <div class="footer"><span>æœ¬å ±å‘Šåƒ…ä¾›åƒè€ƒï¼Œå¯¦éš›ç†è³ é‡‘é¡ä»¥ä¿å–®æ¢æ¬¾ç‚ºæº–</span><span>Page 1</span></div>
                    </div>

                    <div class="page">
                        <div class="header">
                            <span class="brand-l">Polaris Financial Group</span>
                            <div class="brand-r"><span style="font-weight:700; font-size:18px;">è²¡å‹™å»ºè­°</span><br><span style="font-weight:300; font-size:9px; letter-spacing:2px; text-transform:uppercase;">Financial Advice</span></div>
                        </div>
                        <div class="content">
                            <div class="pg-title">è²¡å‹™æ”¶æ”¯èˆ‡å»ºè­°</div>
                            <div style="display:flex; gap:20px; margin-bottom:30px;">
                                <div style="flex:1; background:#f8fafc; border:1px solid #e2e8f0; border-radius:12px; padding:25px; text-align:center;">
                                    <div style="color:#64748b; font-weight:bold; font-size:14px;">å¹´åº¦æ·¨ç¾é‡‘æµ</div>
                                    <div style="font-size:36px; font-weight:900; margin:10px 0; color:${net>=0?'#059669':'#dc2626'}">${netFmt} è¬</div>
                                    <div style="font-size:12px; opacity:0.6;">( å¹´åº¦æ”¶å…¥ - å¹´åº¦æ”¯å‡º )</div>
                                </div>
                                <div style="flex:1; border:1px solid #e2e8f0; border-radius:12px; padding:20px; display:flex; flex-direction:column; justify-content:center;">
                                    <div style="display:flex; justify-content:space-between; margin-bottom:15px; border-bottom:1px solid #f1f5f9; padding-bottom:10px;">
                                        <span>å¹´åº¦ç¸½æ”¶å…¥</span><span style="font-weight:bold; color:#059669;">${parseFloat(totInc).toLocaleString()} è¬</span>
                                    </div>
                                    <div style="display:flex; justify-content:space-between;">
                                        <span>å¹´åº¦ç¸½æ”¯å‡º</span><span style="font-weight:bold; color:#dc2626;">${parseFloat(totExp).toLocaleString()} è¬</span>
                                    </div>
                                </div>
                            </div>
                            <div class="advice" style="flex:1; display:flex; flex-direction:column;">
                                <h3 style="font-size:20px; font-weight:900; color:#0f172a; margin-bottom:20px; border-left:5px solid #fcd34d; padding-left:15px;">å°ˆå®¶è¦åŠƒå»ºè­°</h3>
                                <ul style="margin:0; padding-left:20px; list-style:disc; font-size:16px; line-height:2.4; color:#334155; flex:1;">
                                    ${advice.map(i=>`<li>${i}</li>`).join('')}
                                </ul>
                            </div>
                        </div>
                        <div class="footer"><span>æœ¬å ±å‘Šåƒ…ä¾›åƒè€ƒï¼Œå¯¦éš›ç†è³ é‡‘é¡ä»¥ä¿å–®æ¢æ¬¾ç‚ºæº–</span><span>Page 2</span></div>
                    </div>
                </body></html>
            `;
            
            const win = window.open('','_blank');
            win.document.write(html);
            win.document.close();
            win.onload = () => { overlay.style.display='none'; win.print(); };
        }
    </script>
</body>
</html>
